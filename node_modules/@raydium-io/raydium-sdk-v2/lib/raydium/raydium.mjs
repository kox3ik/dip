var dc=Object.defineProperty,pc=Object.defineProperties;var fc=Object.getOwnPropertyDescriptors;var Qi=Object.getOwnPropertySymbols;var _s=Object.prototype.hasOwnProperty,Vs=Object.prototype.propertyIsEnumerable;var vs=(o,e,t)=>e in o?dc(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,M=(o,e)=>{for(var t in e||(e={}))_s.call(e,t)&&vs(o,t,e[t]);if(Qi)for(var t of Qi(e))Vs.call(e,t)&&vs(o,t,e[t]);return o},U=(o,e)=>pc(o,fc(e));var We=(o,e)=>{var t={};for(var n in o)_s.call(o,n)&&e.indexOf(n)<0&&(t[n]=o[n]);if(o!=null&&Qi)for(var n of Qi(o))e.indexOf(n)<0&&Vs.call(o,n)&&(t[n]=o[n]);return t};import{merge as cp}from"lodash";import Ia from"axios";import{PublicKey as Ds}from"@solana/web3.js";import{get as Es,set as yc}from"lodash";var ar=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},Fs={},bc={};function me(o){let e=Es(Fs,o);if(!e){let t=Es(bc,o);e=new ar({name:o,logLevel:t}),yc(Fs,o,e)}return e}import{MINT_SIZE as gc,TOKEN_PROGRAM_ID as wc,getTransferFeeConfig as Ac,unpackMint as Pc}from"@solana/spl-token";var ur=me("Raydium_accountInfo_util");async function Lt(o,e,t){let{batchRequest:n,commitment:i="confirmed",chunkCount:r=100}=M({batchRequest:!1},t),s=cr(e,r),a=new Array(s.length).fill([]);if(n){let c=s.map(m=>{let d=o._buildArgs([m.map(p=>p.toBase58())],i,"base64");return{methodName:"getMultipleAccounts",args:d}}),u=cr(c,10);a=(await(await Promise.all(u.map(async m=>await o._rpcBatchRequest(m)))).flat()).map(m=>(m.error&&ur.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${m.error.message}`),m.result.value.map(d=>{if(d){let{data:p,executable:f,lamports:y,owner:b,rentEpoch:g}=d;return p.length!==2&&p[1]!=="base64"&&ur.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:f,lamports:y,owner:new Ds(b),rentEpoch:g}}return null})))}else try{a=await Promise.all(s.map(c=>o.getMultipleAccountsInfo(c,i)))}catch(c){c instanceof Error&&ur.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${c.message}`)}return a.flat()}async function Ue(o,e,t){let n=await Lt(o,e.map(i=>i.pubkey),t);return e.map((i,r)=>U(M({},i),{accountInfo:n[r]}))}async function _n({connection:o,mints:e,config:t}){var r,s,a;if(e.length===0)return{};let n=await Ue(o,e.map(c=>({pubkey:tt(c)})),t),i={};for(let c of n){if(!c.accountInfo||c.accountInfo.data.length<gc){console.log("invalid mint account",c.pubkey.toBase58());continue}let u=Pc(c.pubkey,c.accountInfo,(r=c.accountInfo)==null?void 0:r.owner);i[c.pubkey.toString()]=U(M({},u),{programId:((s=c.accountInfo)==null?void 0:s.owner)||wc,feeConfig:(a=Ac(u))!=null?a:void 0})}return i[Ds.default.toBase58()]=i[j.toBase58()],i}import Qt from"bn.js";var Vn=9e15,an=1e9,lr="0123456789abcdef",Hi="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",ji="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",mr={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-Vn,maxE:Vn,crypto:!1},Gs,Xt,se=!0,$i="[DecimalError] ",sn=$i+"Invalid argument: ",Xs=$i+"Precision limit exceeded",zs=$i+"crypto unavailable",Qs="[object Decimal]",nt=Math.floor,Ge=Math.pow,kc=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,hc=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,Tc=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,Ys=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,Mt=1e7,te=7,Ic=9007199254740991,Bc=Hi.length-1,dr=ji.length-1,D={toStringTag:Qs};D.absoluteValue=D.abs=function(){var o=new this.constructor(this);return o.s<0&&(o.s=1),J(o)};D.ceil=function(){return J(new this.constructor(this),this.e+1,2)};D.clampedTo=D.clamp=function(o,e){var t,n=this,i=n.constructor;if(o=new i(o),e=new i(e),!o.s||!e.s)return new i(NaN);if(o.gt(e))throw Error(sn+e);return t=n.cmp(o),t<0?o:n.cmp(e)>0?e:new i(n)};D.comparedTo=D.cmp=function(o){var e,t,n,i,r=this,s=r.d,a=(o=new r.constructor(o)).d,c=r.s,u=o.s;if(!s||!a)return!c||!u?NaN:c!==u?c:s===a?0:!s^c<0?1:-1;if(!s[0]||!a[0])return s[0]?c:a[0]?-u:0;if(c!==u)return c;if(r.e!==o.e)return r.e>o.e^c<0?1:-1;for(n=s.length,i=a.length,e=0,t=n<i?n:i;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^c<0?1:-1;return n===i?0:n>i^c<0?1:-1};D.cosine=D.cos=function(){var o,e,t=this,n=t.constructor;return t.d?t.d[0]?(o=n.precision,e=n.rounding,n.precision=o+Math.max(t.e,t.sd())+te,n.rounding=1,t=xc(n,Js(n,t)),n.precision=o,n.rounding=e,J(Xt==2||Xt==3?t.neg():t,o,e,!0)):new n(1):new n(NaN)};D.cubeRoot=D.cbrt=function(){var o,e,t,n,i,r,s,a,c,u,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(se=!1,r=l.s*Ge(l.s*l,1/3),!r||Math.abs(r)==1/0?(t=je(l.d),o=l.e,(r=(o-t.length+1)%3)&&(t+=r==1||r==-2?"0":"00"),r=Ge(t,1/3),o=nt((o+1)/3)-(o%3==(o<0?-1:2)),r==1/0?t="5e"+o:(t=r.toExponential(),t=t.slice(0,t.indexOf("e")+1)+o),n=new m(t),n.s=l.s):n=new m(r.toString()),s=(o=m.precision)+3;;)if(a=n,c=a.times(a).times(a),u=c.plus(l),n=Ie(u.plus(l).times(a),u.plus(c),s+2,1),je(a.d).slice(0,s)===(t=je(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!i&&t=="4999"){if(!i&&(J(a,o+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,i=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(J(n,o+1,1),e=!n.times(n).times(n).eq(l));break}return se=!0,J(n,o,m.rounding,e)};D.decimalPlaces=D.dp=function(){var o,e=this.d,t=NaN;if(e){if(o=e.length-1,t=(o-nt(this.e/te))*te,o=e[o],o)for(;o%10==0;o/=10)t--;t<0&&(t=0)}return t};D.dividedBy=D.div=function(o){return Ie(this,new this.constructor(o))};D.dividedToIntegerBy=D.divToInt=function(o){var e=this,t=e.constructor;return J(Ie(e,new t(o),0,1,1),t.precision,t.rounding)};D.equals=D.eq=function(o){return this.cmp(o)===0};D.floor=function(){return J(new this.constructor(this),this.e+1,3)};D.greaterThan=D.gt=function(o){return this.cmp(o)>0};D.greaterThanOrEqualTo=D.gte=function(o){var e=this.cmp(o);return e==1||e===0};D.hyperbolicCosine=D.cosh=function(){var o,e,t,n,i,r=this,s=r.constructor,a=new s(1);if(!r.isFinite())return new s(r.s?1/0:NaN);if(r.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(r.e,r.sd())+4,s.rounding=1,i=r.d.length,i<32?(o=Math.ceil(i/3),e=(1/eo(4,o)).toString()):(o=16,e="2.3283064365386962890625e-10"),r=En(s,1,r.times(e),new s(1),!0);for(var c,u=o,l=new s(8);u--;)c=r.times(r),r=a.minus(c.times(l.minus(c.times(l))));return J(r,s.precision=t,s.rounding=n,!0)};D.hyperbolicSine=D.sinh=function(){var o,e,t,n,i=this,r=i.constructor;if(!i.isFinite()||i.isZero())return new r(i);if(e=r.precision,t=r.rounding,r.precision=e+Math.max(i.e,i.sd())+4,r.rounding=1,n=i.d.length,n<3)i=En(r,2,i,i,!0);else{o=1.4*Math.sqrt(n),o=o>16?16:o|0,i=i.times(1/eo(5,o)),i=En(r,2,i,i,!0);for(var s,a=new r(5),c=new r(16),u=new r(20);o--;)s=i.times(i),i=i.times(a.plus(s.times(c.times(s).plus(u))))}return r.precision=e,r.rounding=t,J(i,e,t,!0)};D.hyperbolicTangent=D.tanh=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+7,n.rounding=1,Ie(t.sinh(),t.cosh(),n.precision=o,n.rounding=e)):new n(t.s)};D.inverseCosine=D.acos=function(){var o,e=this,t=e.constructor,n=e.abs().cmp(1),i=t.precision,r=t.rounding;return n!==-1?n===0?e.isNeg()?Ot(t,i,r):new t(0):new t(NaN):e.isZero()?Ot(t,i+4,r).times(.5):(t.precision=i+6,t.rounding=1,e=e.asin(),o=Ot(t,i+4,r).times(.5),t.precision=i,t.rounding=r,o.minus(e))};D.inverseHyperbolicCosine=D.acosh=function(){var o,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(o=n.precision,e=n.rounding,n.precision=o+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,se=!1,t=t.times(t).minus(1).sqrt().plus(t),se=!0,n.precision=o,n.rounding=e,t.ln()):new n(t)};D.inverseHyperbolicSine=D.asinh=function(){var o,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,se=!1,t=t.times(t).plus(1).sqrt().plus(t),se=!0,n.precision=o,n.rounding=e,t.ln())};D.inverseHyperbolicTangent=D.atanh=function(){var o,e,t,n,i=this,r=i.constructor;return i.isFinite()?i.e>=0?new r(i.abs().eq(1)?i.s/0:i.isZero()?i:NaN):(o=r.precision,e=r.rounding,n=i.sd(),Math.max(n,o)<2*-i.e-1?J(new r(i),o,e,!0):(r.precision=t=n-i.e,i=Ie(i.plus(1),new r(1).minus(i),t+o,1),r.precision=o+4,r.rounding=1,i=i.ln(),r.precision=o,r.rounding=e,i.times(.5))):new r(NaN)};D.inverseSine=D.asin=function(){var o,e,t,n,i=this,r=i.constructor;return i.isZero()?new r(i):(e=i.abs().cmp(1),t=r.precision,n=r.rounding,e!==-1?e===0?(o=Ot(r,t+4,n).times(.5),o.s=i.s,o):new r(NaN):(r.precision=t+6,r.rounding=1,i=i.div(new r(1).minus(i.times(i)).sqrt().plus(1)).atan(),r.precision=t,r.rounding=n,i.times(2)))};D.inverseTangent=D.atan=function(){var o,e,t,n,i,r,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding;if(u.isFinite()){if(u.isZero())return new l(u);if(u.abs().eq(1)&&m+4<=dr)return s=Ot(l,m+4,d).times(.25),s.s=u.s,s}else{if(!u.s)return new l(NaN);if(m+4<=dr)return s=Ot(l,m+4,d).times(.5),s.s=u.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/te+2|0),o=t;o;--o)u=u.div(u.times(u).plus(1).sqrt().plus(1));for(se=!1,e=Math.ceil(a/te),n=1,c=u.times(u),s=new l(u),i=u;o!==-1;)if(i=i.times(c),r=s.minus(i.div(n+=2)),i=i.times(c),s=r.plus(i.div(n+=2)),s.d[e]!==void 0)for(o=e;s.d[o]===r.d[o]&&o--;);return t&&(s=s.times(2<<t-1)),se=!0,J(s,l.precision=m,l.rounding=d,!0)};D.isFinite=function(){return!!this.d};D.isInteger=D.isInt=function(){return!!this.d&&nt(this.e/te)>this.d.length-2};D.isNaN=function(){return!this.s};D.isNegative=D.isNeg=function(){return this.s<0};D.isPositive=D.isPos=function(){return this.s>0};D.isZero=function(){return!!this.d&&this.d[0]===0};D.lessThan=D.lt=function(o){return this.cmp(o)<0};D.lessThanOrEqualTo=D.lte=function(o){return this.cmp(o)<1};D.logarithm=D.log=function(o){var e,t,n,i,r,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding,p=5;if(o==null)o=new l(10),e=!0;else{if(o=new l(o),t=o.d,o.s<0||!t||!t[0]||o.eq(1))return new l(NaN);e=o.eq(10)}if(t=u.d,u.s<0||!t||!t[0]||u.eq(1))return new l(t&&!t[0]?-1/0:u.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)r=!0;else{for(i=t[0];i%10===0;)i/=10;r=i!==1}if(se=!1,a=m+p,s=rn(u,a),n=e?Zi(l,a+10):rn(o,a),c=Ie(s,n,a,1),$n(c.d,i=m,d))do if(a+=10,s=rn(u,a),n=e?Zi(l,a+10):rn(o,a),c=Ie(s,n,a,1),!r){+je(c.d).slice(i+1,i+15)+1==1e14&&(c=J(c,m+1,0));break}while($n(c.d,i+=10,d));return se=!0,J(c,m,d)};D.minus=D.sub=function(o){var e,t,n,i,r,s,a,c,u,l,m,d,p=this,f=p.constructor;if(o=new f(o),!p.d||!o.d)return!p.s||!o.s?o=new f(NaN):p.d?o.s=-o.s:o=new f(o.d||p.s!==o.s?p:NaN),o;if(p.s!=o.s)return o.s=-o.s,p.plus(o);if(u=p.d,d=o.d,a=f.precision,c=f.rounding,!u[0]||!d[0]){if(d[0])o.s=-o.s;else if(u[0])o=new f(p);else return new f(c===3?-0:0);return se?J(o,a,c):o}if(t=nt(o.e/te),l=nt(p.e/te),u=u.slice(),r=l-t,r){for(m=r<0,m?(e=u,r=-r,s=d.length):(e=d,t=l,s=u.length),n=Math.max(Math.ceil(a/te),s)+2,r>n&&(r=n,e.length=1),e.reverse(),n=r;n--;)e.push(0);e.reverse()}else{for(n=u.length,s=d.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(u[n]!=d[n]){m=u[n]<d[n];break}r=0}for(m&&(e=u,u=d,d=e,o.s=-o.s),s=u.length,n=d.length-s;n>0;--n)u[s++]=0;for(n=d.length;n>r;){if(u[--n]<d[n]){for(i=n;i&&u[--i]===0;)u[i]=Mt-1;--u[i],u[n]+=Mt}u[n]-=d[n]}for(;u[--s]===0;)u.pop();for(;u[0]===0;u.shift())--t;return u[0]?(o.d=u,o.e=Ji(u,t),se?J(o,a,c):o):new f(c===3?-0:0)};D.modulo=D.mod=function(o){var e,t=this,n=t.constructor;return o=new n(o),!t.d||!o.s||o.d&&!o.d[0]?new n(NaN):!o.d||t.d&&!t.d[0]?J(new n(t),n.precision,n.rounding):(se=!1,n.modulo==9?(e=Ie(t,o.abs(),0,3,1),e.s*=o.s):e=Ie(t,o,0,n.modulo,1),e=e.times(o),se=!0,t.minus(e))};D.naturalExponential=D.exp=function(){return pr(this)};D.naturalLogarithm=D.ln=function(){return rn(this)};D.negated=D.neg=function(){var o=new this.constructor(this);return o.s=-o.s,J(o)};D.plus=D.add=function(o){var e,t,n,i,r,s,a,c,u,l,m=this,d=m.constructor;if(o=new d(o),!m.d||!o.d)return!m.s||!o.s?o=new d(NaN):m.d||(o=new d(o.d||m.s===o.s?m:NaN)),o;if(m.s!=o.s)return o.s=-o.s,m.minus(o);if(u=m.d,l=o.d,a=d.precision,c=d.rounding,!u[0]||!l[0])return l[0]||(o=new d(m)),se?J(o,a,c):o;if(r=nt(m.e/te),n=nt(o.e/te),u=u.slice(),i=r-n,i){for(i<0?(t=u,i=-i,s=l.length):(t=l,n=r,s=u.length),r=Math.ceil(a/te),s=r>s?r+1:s+1,i>s&&(i=s,t.length=1),t.reverse();i--;)t.push(0);t.reverse()}for(s=u.length,i=l.length,s-i<0&&(i=s,t=l,l=u,u=t),e=0;i;)e=(u[--i]=u[i]+l[i]+e)/Mt|0,u[i]%=Mt;for(e&&(u.unshift(e),++n),s=u.length;u[--s]==0;)u.pop();return o.d=u,o.e=Ji(u,n),se?J(o,a,c):o};D.precision=D.sd=function(o){var e,t=this;if(o!==void 0&&o!==!!o&&o!==1&&o!==0)throw Error(sn+o);return t.d?(e=Hs(t.d),o&&t.e+1>e&&(e=t.e+1)):e=NaN,e};D.round=function(){var o=this,e=o.constructor;return J(new e(o),o.e+1,e.rounding)};D.sine=D.sin=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+Math.max(t.e,t.sd())+te,n.rounding=1,t=Kc(n,Js(n,t)),n.precision=o,n.rounding=e,J(Xt>2?t.neg():t,o,e,!0)):new n(NaN)};D.squareRoot=D.sqrt=function(){var o,e,t,n,i,r,s=this,a=s.d,c=s.e,u=s.s,l=s.constructor;if(u!==1||!a||!a[0])return new l(!u||u<0&&(!a||a[0])?NaN:a?s:1/0);for(se=!1,u=Math.sqrt(+s),u==0||u==1/0?(e=je(a),(e.length+c)%2==0&&(e+="0"),u=Math.sqrt(e),c=nt((c+1)/2)-(c<0||c%2),u==1/0?e="5e"+c:(e=u.toExponential(),e=e.slice(0,e.indexOf("e")+1)+c),n=new l(e)):n=new l(u.toString()),t=(c=l.precision)+3;;)if(r=n,n=r.plus(Ie(s,r,t+2,1)).times(.5),je(r.d).slice(0,t)===(e=je(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!i&&e=="4999"){if(!i&&(J(r,c+1,0),r.times(r).eq(s))){n=r;break}t+=4,i=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(J(n,c+1,1),o=!n.times(n).eq(s));break}return se=!0,J(n,c,l.rounding,o)};D.tangent=D.tan=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+10,n.rounding=1,t=t.sin(),t.s=1,t=Ie(t,new n(1).minus(t.times(t)).sqrt(),o+10,0),n.precision=o,n.rounding=e,J(Xt==2||Xt==4?t.neg():t,o,e,!0)):new n(NaN)};D.times=D.mul=function(o){var e,t,n,i,r,s,a,c,u,l=this,m=l.constructor,d=l.d,p=(o=new m(o)).d;if(o.s*=l.s,!d||!d[0]||!p||!p[0])return new m(!o.s||d&&!d[0]&&!p||p&&!p[0]&&!d?NaN:!d||!p?o.s/0:o.s*0);for(t=nt(l.e/te)+nt(o.e/te),c=d.length,u=p.length,c<u&&(r=d,d=p,p=r,s=c,c=u,u=s),r=[],s=c+u,n=s;n--;)r.push(0);for(n=u;--n>=0;){for(e=0,i=c+n;i>n;)a=r[i]+p[n]*d[i-n-1]+e,r[i--]=a%Mt|0,e=a/Mt|0;r[i]=(r[i]+e)%Mt|0}for(;!r[--s];)r.pop();return e?++t:r.shift(),o.d=r,o.e=Ji(r,t),se?J(o,m.precision,m.rounding):o};D.toBinary=function(o,e){return yr(this,2,o,e)};D.toDecimalPlaces=D.toDP=function(o,e){var t=this,n=t.constructor;return t=new n(t),o===void 0?t:(pt(o,0,an),e===void 0?e=n.rounding:pt(e,0,8),J(t,o+t.e+1,e))};D.toExponential=function(o,e){var t,n=this,i=n.constructor;return o===void 0?t=qt(n,!0):(pt(o,0,an),e===void 0?e=i.rounding:pt(e,0,8),n=J(new i(n),o+1,e),t=qt(n,!0,o+1)),n.isNeg()&&!n.isZero()?"-"+t:t};D.toFixed=function(o,e){var t,n,i=this,r=i.constructor;return o===void 0?t=qt(i):(pt(o,0,an),e===void 0?e=r.rounding:pt(e,0,8),n=J(new r(i),o+i.e+1,e),t=qt(n,!1,o+n.e+1)),i.isNeg()&&!i.isZero()?"-"+t:t};D.toFraction=function(o){var e,t,n,i,r,s,a,c,u,l,m,d,p=this,f=p.d,y=p.constructor;if(!f)return new y(p);if(u=t=new y(1),n=c=new y(0),e=new y(n),r=e.e=Hs(f)-p.e-1,s=r%te,e.d[0]=Ge(10,s<0?te+s:s),o==null)o=r>0?e:u;else{if(a=new y(o),!a.isInt()||a.lt(u))throw Error(sn+a);o=a.gt(e)?r>0?e:u:a}for(se=!1,a=new y(je(f)),l=y.precision,y.precision=r=f.length*te*2;m=Ie(a,e,0,1,1),i=t.plus(m.times(n)),i.cmp(o)!=1;)t=n,n=i,i=u,u=c.plus(m.times(i)),c=i,i=e,e=a.minus(m.times(i)),a=i;return i=Ie(o.minus(t),n,0,1,1),c=c.plus(i.times(u)),t=t.plus(i.times(n)),c.s=u.s=p.s,d=Ie(u,n,r,1).minus(p).abs().cmp(Ie(c,t,r,1).minus(p).abs())<1?[u,n]:[c,t],y.precision=l,se=!0,d};D.toHexadecimal=D.toHex=function(o,e){return yr(this,16,o,e)};D.toNearest=function(o,e){var t=this,n=t.constructor;if(t=new n(t),o==null){if(!t.d)return t;o=new n(1),e=n.rounding}else{if(o=new n(o),e===void 0?e=n.rounding:pt(e,0,8),!t.d)return o.s?t:o;if(!o.d)return o.s&&(o.s=t.s),o}return o.d[0]?(se=!1,t=Ie(t,o,0,e,1).times(o),se=!0,J(t)):(o.s=t.s,t=o),t};D.toNumber=function(){return+this};D.toOctal=function(o,e){return yr(this,8,o,e)};D.toPower=D.pow=function(o){var e,t,n,i,r,s,a=this,c=a.constructor,u=+(o=new c(o));if(!a.d||!o.d||!a.d[0]||!o.d[0])return new c(Ge(+a,u));if(a=new c(a),a.eq(1))return a;if(n=c.precision,r=c.rounding,o.eq(1))return J(a,n,r);if(e=nt(o.e/te),e>=o.d.length-1&&(t=u<0?-u:u)<=Ic)return i=js(c,a,t,n),o.s<0?new c(1).div(i):J(i,n,r);if(s=a.s,s<0){if(e<o.d.length-1)return new c(NaN);if((o.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=Ge(+a,u),e=t==0||!isFinite(t)?nt(u*(Math.log("0."+je(a.d))/Math.LN10+a.e+1)):new c(t+"").e,e>c.maxE+1||e<c.minE-1?new c(e>0?s/0:0):(se=!1,c.rounding=a.s=1,t=Math.min(12,(e+"").length),i=pr(o.times(rn(a,n+t)),n),i.d&&(i=J(i,n+5,1),$n(i.d,n,r)&&(e=n+10,i=J(pr(o.times(rn(a,e+t)),e),e+5,1),+je(i.d).slice(n+1,n+15)+1==1e14&&(i=J(i,n+1,0)))),i.s=s,se=!0,c.rounding=r,J(i,n,r))};D.toPrecision=function(o,e){var t,n=this,i=n.constructor;return o===void 0?t=qt(n,n.e<=i.toExpNeg||n.e>=i.toExpPos):(pt(o,1,an),e===void 0?e=i.rounding:pt(e,0,8),n=J(new i(n),o,e),t=qt(n,o<=n.e||n.e<=i.toExpNeg,o)),n.isNeg()&&!n.isZero()?"-"+t:t};D.toSignificantDigits=D.toSD=function(o,e){var t=this,n=t.constructor;return o===void 0?(o=n.precision,e=n.rounding):(pt(o,1,an),e===void 0?e=n.rounding:pt(e,0,8)),J(new n(t),o,e)};D.toString=function(){var o=this,e=o.constructor,t=qt(o,o.e<=e.toExpNeg||o.e>=e.toExpPos);return o.isNeg()&&!o.isZero()?"-"+t:t};D.truncated=D.trunc=function(){return J(new this.constructor(this),this.e+1,1)};D.valueOf=D.toJSON=function(){var o=this,e=o.constructor,t=qt(o,o.e<=e.toExpNeg||o.e>=e.toExpPos);return o.isNeg()?"-"+t:t};function je(o){var e,t,n,i=o.length-1,r="",s=o[0];if(i>0){for(r+=s,e=1;e<i;e++)n=o[e]+"",t=te-n.length,t&&(r+=on(t)),r+=n;s=o[e],n=s+"",t=te-n.length,t&&(r+=on(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return r+s}function pt(o,e,t){if(o!==~~o||o<e||o>t)throw Error(sn+o)}function $n(o,e,t,n){var i,r,s,a;for(r=o[0];r>=10;r/=10)--e;return--e<0?(e+=te,i=0):(i=Math.ceil((e+1)/te),e%=te),r=Ge(10,te-e),a=o[i]%r|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==r||t>3&&a+1==r/2)&&(o[i+1]/r/100|0)==Ge(10,e-2)-1||(a==r/2||a==0)&&(o[i+1]/r/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==r||!n&&t>3&&a+1==r/2)&&(o[i+1]/r/1e3|0)==Ge(10,e-3)-1,s}function Yi(o,e,t){for(var n,i=[0],r,s=0,a=o.length;s<a;){for(r=i.length;r--;)i[r]*=e;for(i[0]+=lr.indexOf(o.charAt(s++)),n=0;n<i.length;n++)i[n]>t-1&&(i[n+1]===void 0&&(i[n+1]=0),i[n+1]+=i[n]/t|0,i[n]%=t)}return i.reverse()}function xc(o,e){var t,n,i;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),i=(1/eo(4,t)).toString()):(t=16,i="2.3283064365386962890625e-10"),o.precision+=t,e=En(o,1,e.times(i),new o(1));for(var r=t;r--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return o.precision-=t,e}var Ie=function(){function o(n,i,r){var s,a=0,c=n.length;for(n=n.slice();c--;)s=n[c]*i+a,n[c]=s%r|0,a=s/r|0;return a&&n.unshift(a),n}function e(n,i,r,s){var a,c;if(r!=s)c=r>s?1:-1;else for(a=c=0;a<r;a++)if(n[a]!=i[a]){c=n[a]>i[a]?1:-1;break}return c}function t(n,i,r,s){for(var a=0;r--;)n[r]-=a,a=n[r]<i[r]?1:0,n[r]=a*s+n[r]-i[r];for(;!n[0]&&n.length>1;)n.shift()}return function(n,i,r,s,a,c){var u,l,m,d,p,f,y,b,g,w,A,h,I,k,x,S,K,T,C,R,L=n.constructor,v=n.s==i.s?1:-1,F=n.d,_=i.d;if(!F||!F[0]||!_||!_[0])return new L(!n.s||!i.s||(F?_&&F[0]==_[0]:!_)?NaN:F&&F[0]==0||!_?v*0:v/0);for(c?(p=1,l=n.e-i.e):(c=Mt,p=te,l=nt(n.e/p)-nt(i.e/p)),C=_.length,K=F.length,g=new L(v),w=g.d=[],m=0;_[m]==(F[m]||0);m++);if(_[m]>(F[m]||0)&&l--,r==null?(k=r=L.precision,s=L.rounding):a?k=r+(n.e-i.e)+1:k=r,k<0)w.push(1),f=!0;else{if(k=k/p+2|0,m=0,C==1){for(d=0,_=_[0],k++;(m<K||d)&&k--;m++)x=d*c+(F[m]||0),w[m]=x/_|0,d=x%_|0;f=d||m<K}else{for(d=c/(_[0]+1)|0,d>1&&(_=o(_,d,c),F=o(F,d,c),C=_.length,K=F.length),S=C,A=F.slice(0,C),h=A.length;h<C;)A[h++]=0;R=_.slice(),R.unshift(0),T=_[0],_[1]>=c/2&&++T;do d=0,u=e(_,A,C,h),u<0?(I=A[0],C!=h&&(I=I*c+(A[1]||0)),d=I/T|0,d>1?(d>=c&&(d=c-1),y=o(_,d,c),b=y.length,h=A.length,u=e(y,A,b,h),u==1&&(d--,t(y,C<b?R:_,b,c))):(d==0&&(u=d=1),y=_.slice()),b=y.length,b<h&&y.unshift(0),t(A,y,h,c),u==-1&&(h=A.length,u=e(_,A,C,h),u<1&&(d++,t(A,C<h?R:_,h,c))),h=A.length):u===0&&(d++,A=[0]),w[m++]=d,u&&A[0]?A[h++]=F[S]||0:(A=[F[S]],h=1);while((S++<K||A[0]!==void 0)&&k--);f=A[0]!==void 0}w[0]||w.shift()}if(p==1)g.e=l,Gs=f;else{for(m=1,d=w[0];d>=10;d/=10)m++;g.e=m+l*p-1,J(g,a?r+g.e+1:r,s,f)}return g}}();function J(o,e,t,n){var i,r,s,a,c,u,l,m,d,p=o.constructor;e:if(e!=null){if(m=o.d,!m)return o;for(i=1,a=m[0];a>=10;a/=10)i++;if(r=e-i,r<0)r+=te,s=e,l=m[d=0],c=l/Ge(10,i-s-1)%10|0;else if(d=Math.ceil((r+1)/te),a=m.length,d>=a)if(n){for(;a++<=d;)m.push(0);l=c=0,i=1,r%=te,s=r-te+1}else break e;else{for(l=a=m[d],i=1;a>=10;a/=10)i++;r%=te,s=r-te+i,c=s<0?0:l/Ge(10,i-s-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(s<0?l:l%Ge(10,i-s-1)),u=t<4?(c||n)&&(t==0||t==(o.s<0?3:2)):c>5||c==5&&(t==4||n||t==6&&(r>0?s>0?l/Ge(10,i-s):0:m[d-1])%10&1||t==(o.s<0?8:7)),e<1||!m[0])return m.length=0,u?(e-=o.e+1,m[0]=Ge(10,(te-e%te)%te),o.e=-e||0):m[0]=o.e=0,o;if(r==0?(m.length=d,a=1,d--):(m.length=d+1,a=Ge(10,te-r),m[d]=s>0?(l/Ge(10,i-s)%Ge(10,s)|0)*a:0),u)for(;;)if(d==0){for(r=1,s=m[0];s>=10;s/=10)r++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;r!=a&&(o.e++,m[0]==Mt&&(m[0]=1));break}else{if(m[d]+=a,m[d]!=Mt)break;m[d--]=0,a=1}for(r=m.length;m[--r]===0;)m.pop()}return se&&(o.e>p.maxE?(o.d=null,o.e=NaN):o.e<p.minE&&(o.e=0,o.d=[0])),o}function qt(o,e,t){if(!o.isFinite())return $s(o);var n,i=o.e,r=je(o.d),s=r.length;return e?(t&&(n=t-s)>0?r=r.charAt(0)+"."+r.slice(1)+on(n):s>1&&(r=r.charAt(0)+"."+r.slice(1)),r=r+(o.e<0?"e":"e+")+o.e):i<0?(r="0."+on(-i-1)+r,t&&(n=t-s)>0&&(r+=on(n))):i>=s?(r+=on(i+1-s),t&&(n=t-i-1)>0&&(r=r+"."+on(n))):((n=i+1)<s&&(r=r.slice(0,n)+"."+r.slice(n)),t&&(n=t-s)>0&&(i+1===s&&(r+="."),r+=on(n))),r}function Ji(o,e){var t=o[0];for(e*=te;t>=10;t/=10)e++;return e}function Zi(o,e,t){if(e>Bc)throw se=!0,t&&(o.precision=t),Error(Xs);return J(new o(Hi),e,1,!0)}function Ot(o,e,t){if(e>dr)throw Error(Xs);return J(new o(ji),e,t,!0)}function Hs(o){var e=o.length-1,t=e*te+1;if(e=o[e],e){for(;e%10==0;e/=10)t--;for(e=o[0];e>=10;e/=10)t++}return t}function on(o){for(var e="";o--;)e+="0";return e}function js(o,e,t,n){var i,r=new o(1),s=Math.ceil(n/te+4);for(se=!1;;){if(t%2&&(r=r.times(e),qs(r.d,s)&&(i=!0)),t=nt(t/2),t===0){t=r.d.length-1,i&&r.d[t]===0&&++r.d[t];break}e=e.times(e),qs(e.d,s)}return se=!0,r}function Ws(o){return o.d[o.d.length-1]&1}function Zs(o,e,t){for(var n,i=new o(e[0]),r=0;++r<e.length;)if(n=new o(e[r]),n.s)i[t](n)&&(i=n);else{i=n;break}return i}function pr(o,e){var t,n,i,r,s,a,c,u=0,l=0,m=0,d=o.constructor,p=d.rounding,f=d.precision;if(!o.d||!o.d[0]||o.e>17)return new d(o.d?o.d[0]?o.s<0?0:1/0:1:o.s?o.s<0?0:o:0/0);for(e==null?(se=!1,c=f):c=e,a=new d(.03125);o.e>-2;)o=o.times(a),m+=5;for(n=Math.log(Ge(2,m))/Math.LN10*2+5|0,c+=n,t=r=s=new d(1),d.precision=c;;){if(r=J(r.times(o),c,1),t=t.times(++l),a=s.plus(Ie(r,t,c,1)),je(a.d).slice(0,c)===je(s.d).slice(0,c)){for(i=m;i--;)s=J(s.times(s),c,1);if(e==null)if(u<3&&$n(s.d,c-n,p,u))d.precision=c+=10,t=r=a=new d(1),l=0,u++;else return J(s,d.precision=f,p,se=!0);else return d.precision=f,s}s=a}}function rn(o,e){var t,n,i,r,s,a,c,u,l,m,d,p=1,f=10,y=o,b=y.d,g=y.constructor,w=g.rounding,A=g.precision;if(y.s<0||!b||!b[0]||!y.e&&b[0]==1&&b.length==1)return new g(b&&!b[0]?-1/0:y.s!=1?NaN:b?0:y);if(e==null?(se=!1,l=A):l=e,g.precision=l+=f,t=je(b),n=t.charAt(0),Math.abs(r=y.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)y=y.times(o),t=je(y.d),n=t.charAt(0),p++;r=y.e,n>1?(y=new g("0."+t),r++):y=new g(n+"."+t.slice(1))}else return u=Zi(g,l+2,A).times(r+""),y=rn(new g(n+"."+t.slice(1)),l-f).plus(u),g.precision=A,e==null?J(y,A,w,se=!0):y;for(m=y,c=s=y=Ie(y.minus(1),y.plus(1),l,1),d=J(y.times(y),l,1),i=3;;){if(s=J(s.times(d),l,1),u=c.plus(Ie(s,new g(i),l,1)),je(u.d).slice(0,l)===je(c.d).slice(0,l))if(c=c.times(2),r!==0&&(c=c.plus(Zi(g,l+2,A).times(r+""))),c=Ie(c,new g(p),l,1),e==null)if($n(c.d,l-f,w,a))g.precision=l+=f,u=s=y=Ie(m.minus(1),m.plus(1),l,1),d=J(y.times(y),l,1),i=a=1;else return J(c,g.precision=A,w,se=!0);else return g.precision=A,c;c=u,i+=2}}function $s(o){return String(o.s*o.s/0)}function fr(o,e){var t,n,i;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(i=e.length;e.charCodeAt(i-1)===48;--i);if(e=e.slice(n,i),e){if(i-=n,o.e=t=t-n-1,o.d=[],n=(t+1)%te,t<0&&(n+=te),n<i){for(n&&o.d.push(+e.slice(0,n)),i-=te;n<i;)o.d.push(+e.slice(n,n+=te));e=e.slice(n),n=te-e.length}else n-=i;for(;n--;)e+="0";o.d.push(+e),se&&(o.e>o.constructor.maxE?(o.d=null,o.e=NaN):o.e<o.constructor.minE&&(o.e=0,o.d=[0]))}else o.e=0,o.d=[0];return o}function Sc(o,e){var t,n,i,r,s,a,c,u,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),Ys.test(e))return fr(o,e)}else if(e==="Infinity"||e==="NaN")return+e||(o.s=NaN),o.e=NaN,o.d=null,o;if(hc.test(e))t=16,e=e.toLowerCase();else if(kc.test(e))t=2;else if(Tc.test(e))t=8;else throw Error(sn+e);for(r=e.search(/p/i),r>0?(c=+e.slice(r+1),e=e.substring(2,r)):e=e.slice(2),r=e.indexOf("."),s=r>=0,n=o.constructor,s&&(e=e.replace(".",""),a=e.length,r=a-r,i=js(n,new n(t),r,r*2)),u=Yi(e,t,Mt),l=u.length-1,r=l;u[r]===0;--r)u.pop();return r<0?new n(o.s*0):(o.e=Ji(u,l),o.d=u,se=!1,s&&(o=Ie(o,i,a*4)),c&&(o=o.times(Math.abs(c)<54?Ge(2,c):Jn.pow(2,c))),se=!0,o)}function Kc(o,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:En(o,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/eo(5,t)),e=En(o,2,e,e);for(var i,r=new o(5),s=new o(16),a=new o(20);t--;)i=e.times(e),e=e.times(r.plus(i.times(s.times(i).minus(a))));return e}function En(o,e,t,n,i){var r,s,a,c,u=1,l=o.precision,m=Math.ceil(l/te);for(se=!1,c=t.times(t),a=new o(n);;){if(s=Ie(a.times(c),new o(e++*e++),l,1),a=i?n.plus(s):n.minus(s),n=Ie(s.times(c),new o(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(r=m;s.d[r]===a.d[r]&&r--;);if(r==-1)break}r=a,a=n,n=s,s=r,u++}return se=!0,s.d.length=m+1,s}function eo(o,e){for(var t=o;--e;)t*=o;return t}function Js(o,e){var t,n=e.s<0,i=Ot(o,o.precision,1),r=i.times(.5);if(e=e.abs(),e.lte(r))return Xt=n?4:1,e;if(t=e.divToInt(i),t.isZero())Xt=n?3:2;else{if(e=e.minus(t.times(i)),e.lte(r))return Xt=Ws(t)?n?2:3:n?4:1,e;Xt=Ws(t)?n?1:4:n?3:2}return e.minus(i).abs()}function yr(o,e,t,n){var i,r,s,a,c,u,l,m,d,p=o.constructor,f=t!==void 0;if(f?(pt(t,1,an),n===void 0?n=p.rounding:pt(n,0,8)):(t=p.precision,n=p.rounding),!o.isFinite())l=$s(o);else{for(l=qt(o),s=l.indexOf("."),f?(i=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):i=e,s>=0&&(l=l.replace(".",""),d=new p(1),d.e=l.length-s,d.d=Yi(qt(d),10,i),d.e=d.d.length),m=Yi(l,10,i),r=c=m.length;m[--c]==0;)m.pop();if(!m[0])l=f?"0p+0":"0";else{if(s<0?r--:(o=new p(o),o.d=m,o.e=r,o=Ie(o,d,t,n,0,i),m=o.d,r=o.e,u=Gs),s=m[t],a=i/2,u=u||m[t+1]!==void 0,u=n<4?(s!==void 0||u)&&(n===0||n===(o.s<0?3:2)):s>a||s===a&&(n===4||u||n===6&&m[t-1]&1||n===(o.s<0?8:7)),m.length=t,u)for(;++m[--t]>i-1;)m[t]=0,t||(++r,m.unshift(1));for(c=m.length;!m[c-1];--c);for(s=0,l="";s<c;s++)l+=lr.charAt(m[s]);if(f){if(c>1)if(e==16||e==8){for(s=e==16?4:3,--c;c%s;c++)l+="0";for(m=Yi(l,i,e),c=m.length;!m[c-1];--c);for(s=1,l="1.";s<c;s++)l+=lr.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(r<0?"p":"p+")+r}else if(r<0){for(;++r;)l="0"+l;l="0."+l}else if(++r>c)for(r-=c;r--;)l+="0";else r<c&&(l=l.slice(0,r)+"."+l.slice(r))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return o.s<0?"-"+l:l}function qs(o,e){if(o.length>e)return o.length=e,!0}function Cc(o){return new this(o).abs()}function Rc(o){return new this(o).acos()}function Lc(o){return new this(o).acosh()}function Oc(o,e){return new this(o).plus(e)}function Mc(o){return new this(o).asin()}function Nc(o){return new this(o).asinh()}function vc(o){return new this(o).atan()}function _c(o){return new this(o).atanh()}function Vc(o,e){o=new this(o),e=new this(e);var t,n=this.precision,i=this.rounding,r=n+4;return!o.s||!e.s?t=new this(NaN):!o.d&&!e.d?(t=Ot(this,r,1).times(e.s>0?.25:.75),t.s=o.s):!e.d||o.isZero()?(t=e.s<0?Ot(this,n,i):new this(0),t.s=o.s):!o.d||e.isZero()?(t=Ot(this,r,1).times(.5),t.s=o.s):e.s<0?(this.precision=r,this.rounding=1,t=this.atan(Ie(o,e,r,1)),e=Ot(this,r,1),this.precision=n,this.rounding=i,t=o.s<0?t.minus(e):t.plus(e)):t=this.atan(Ie(o,e,r,1)),t}function Ec(o){return new this(o).cbrt()}function Fc(o){return J(o=new this(o),o.e+1,2)}function Dc(o,e,t){return new this(o).clamp(e,t)}function Wc(o){if(!o||typeof o!="object")throw Error($i+"Object expected");var e,t,n,i=o.defaults===!0,r=["precision",1,an,"rounding",0,8,"toExpNeg",-Vn,0,"toExpPos",0,Vn,"maxE",0,Vn,"minE",-Vn,0,"modulo",0,9];for(e=0;e<r.length;e+=3)if(t=r[e],i&&(this[t]=mr[t]),(n=o[t])!==void 0)if(nt(n)===n&&n>=r[e+1]&&n<=r[e+2])this[t]=n;else throw Error(sn+t+": "+n);if(t="crypto",i&&(this[t]=mr[t]),(n=o[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(zs);else this[t]=!1;else throw Error(sn+t+": "+n);return this}function qc(o){return new this(o).cos()}function Uc(o){return new this(o).cosh()}function ea(o){var e,t,n;function i(r){var s,a,c,u=this;if(!(u instanceof i))return new i(r);if(u.constructor=i,Us(r)){u.s=r.s,se?!r.d||r.e>i.maxE?(u.e=NaN,u.d=null):r.e<i.minE?(u.e=0,u.d=[0]):(u.e=r.e,u.d=r.d.slice()):(u.e=r.e,u.d=r.d?r.d.slice():r.d);return}if(c=typeof r,c==="number"){if(r===0){u.s=1/r<0?-1:1,u.e=0,u.d=[0];return}if(r<0?(r=-r,u.s=-1):u.s=1,r===~~r&&r<1e7){for(s=0,a=r;a>=10;a/=10)s++;se?s>i.maxE?(u.e=NaN,u.d=null):s<i.minE?(u.e=0,u.d=[0]):(u.e=s,u.d=[r]):(u.e=s,u.d=[r]);return}else if(r*0!==0){r||(u.s=NaN),u.e=NaN,u.d=null;return}return fr(u,r.toString())}else if(c!=="string")throw Error(sn+r);return(a=r.charCodeAt(0))===45?(r=r.slice(1),u.s=-1):(a===43&&(r=r.slice(1)),u.s=1),Ys.test(r)?fr(u,r):Sc(u,r)}if(i.prototype=D,i.ROUND_UP=0,i.ROUND_DOWN=1,i.ROUND_CEIL=2,i.ROUND_FLOOR=3,i.ROUND_HALF_UP=4,i.ROUND_HALF_DOWN=5,i.ROUND_HALF_EVEN=6,i.ROUND_HALF_CEIL=7,i.ROUND_HALF_FLOOR=8,i.EUCLID=9,i.config=i.set=Wc,i.clone=ea,i.isDecimal=Us,i.abs=Cc,i.acos=Rc,i.acosh=Lc,i.add=Oc,i.asin=Mc,i.asinh=Nc,i.atan=vc,i.atanh=_c,i.atan2=Vc,i.cbrt=Ec,i.ceil=Fc,i.clamp=Dc,i.cos=qc,i.cosh=Uc,i.div=Gc,i.exp=Xc,i.floor=zc,i.hypot=Qc,i.ln=Yc,i.log=Hc,i.log10=Zc,i.log2=jc,i.max=$c,i.min=Jc,i.mod=el,i.mul=tl,i.pow=nl,i.random=il,i.round=ol,i.sign=rl,i.sin=sl,i.sinh=al,i.sqrt=ul,i.sub=cl,i.sum=ll,i.tan=ml,i.tanh=dl,i.trunc=pl,o===void 0&&(o={}),o&&o.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)o.hasOwnProperty(t=n[e++])||(o[t]=this[t]);return i.config(o),i}function Gc(o,e){return new this(o).div(e)}function Xc(o){return new this(o).exp()}function zc(o){return J(o=new this(o),o.e+1,3)}function Qc(){var o,e,t=new this(0);for(se=!1,o=0;o<arguments.length;)if(e=new this(arguments[o++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return se=!0,new this(1/0);t=e}return se=!0,t.sqrt()}function Us(o){return o instanceof Jn||o&&o.toStringTag===Qs||!1}function Yc(o){return new this(o).ln()}function Hc(o,e){return new this(o).log(e)}function jc(o){return new this(o).log(2)}function Zc(o){return new this(o).log(10)}function $c(){return Zs(this,arguments,"lt")}function Jc(){return Zs(this,arguments,"gt")}function el(o,e){return new this(o).mod(e)}function tl(o,e){return new this(o).mul(e)}function nl(o,e){return new this(o).pow(e)}function il(o){var e,t,n,i,r=0,s=new this(1),a=[];if(o===void 0?o=this.precision:pt(o,1,an),n=Math.ceil(o/te),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));r<n;)i=e[r],i>=429e7?e[r]=crypto.getRandomValues(new Uint32Array(1))[0]:a[r++]=i%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);r<n;)i=e[r]+(e[r+1]<<8)+(e[r+2]<<16)+((e[r+3]&127)<<24),i>=214e7?crypto.randomBytes(4).copy(e,r):(a.push(i%1e7),r+=4);r=n/4}else throw Error(zs);else for(;r<n;)a[r++]=Math.random()*1e7|0;for(n=a[--r],o%=te,n&&o&&(i=Ge(10,te-o),a[r]=(n/i|0)*i);a[r]===0;r--)a.pop();if(r<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=te)a.shift();for(n=1,i=a[0];i>=10;i/=10)n++;n<te&&(t-=te-n)}return s.e=t,s.d=a,s}function ol(o){return J(o=new this(o),o.e+1,this.rounding)}function rl(o){return o=new this(o),o.d?o.d[0]?o.s:0*o.s:o.s||NaN}function sl(o){return new this(o).sin()}function al(o){return new this(o).sinh()}function ul(o){return new this(o).sqrt()}function cl(o,e){return new this(o).sub(e)}function ll(){var o=0,e=arguments,t=new this(e[o]);for(se=!1;t.s&&++o<e.length;)t=t.plus(e[o]);return se=!0,J(t,this.precision,this.rounding)}function ml(o){return new this(o).tan()}function dl(o){return new this(o).tanh()}function pl(o){return J(o=new this(o),o.e+1,1)}D[Symbol.for("nodejs.util.inspect.custom")]=D.toString;D[Symbol.toStringTag]="Decimal";var Jn=D.constructor=ea(mr);Hi=new Jn(Hi);ji=new Jn(ji);var N=Jn;import kl from"big.js";import io from"bn.js";import fl from"toformat";var yl=fl,ei=yl;import no from"big.js";import gl from"bn.js";import wl from"decimal.js-light";import ti from"bn.js";var ta=9007199254740991;function $(o){let e=me("Raydium_parseBigNumberish");if(o instanceof ti)return o;if(typeof o=="string"){if(o.match(/^-?[0-9]+$/))return new ti(o);e.logWithError(`invalid BigNumberish string: ${o}`)}return typeof o=="number"?(o%1&&e.logWithError(`BigNumberish number underflow: ${o}`),(o>=ta||o<=-ta)&&e.logWithError(`BigNumberish number overflow: ${o}`),new ti(String(o))):typeof o=="bigint"?new ti(o.toString()):(e.error(`invalid BigNumberish value: ${o}`),new ti(0))}var to=me("module/fraction"),br=ei(no),ni=ei(wl),Al={[0]:ni.ROUND_DOWN,[1]:ni.ROUND_HALF_UP,[2]:ni.ROUND_UP},Pl={[0]:no.roundDown,[1]:no.roundHalfUp,[2]:no.roundUp},be=class{constructor(e,t=new gl(1)){this.numerator=$(e),this.denominator=$(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new be(this.denominator,this.numerator)}add(e){let t=e instanceof be?e:new be($(e));return this.denominator.eq(t.denominator)?new be(this.numerator.add(t.numerator),this.denominator):new be(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof be?e:new be($(e));return this.denominator.eq(t.denominator)?new be(this.numerator.sub(t.numerator),this.denominator):new be(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof be?e:new be($(e));return new be(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof be?e:new be($(e));return new be(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||to.logWithError(`${e} is not an integer.`),e<=0&&to.logWithError(`${e} is not positive.`),ni.set({precision:e+1,rounding:Al[n]});let i=new ni(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return i.toFormat(i.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||to.logWithError(`${e} is not an integer.`),e<0&&to.logWithError(`${e} is negative.`),br.DP=e,br.RM=Pl[n]||1,new br(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var hl=me("Raydium_amount"),na=ei(kl);function Tl(o,e){let t="0",n="0";if(o.includes(".")){let i=o.split(".");i.length===2?([t,n]=i,n=n.padEnd(e,"0")):hl.logWithError(`invalid number string, num: ${o}`)}else t=o;return[t,n.slice(0,e)||n]}var Ae=class extends be{constructor(t,n,i=!0,r){let s=new io(0),a=gr.pow(new io(t.decimals));if(i)s=$(n);else{let c=new io(0),u=new io(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=Tl(n.toString(),t.decimals);c=$(l),u=$(m)}c=c.mul(a),s=c.add(u)}super(s,a);this.logger=me(r||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new Ae(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new Ae(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,i=0){return super.toSignificant(t,n,i)}toFixed(t=this.token.decimals,n,i=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,i)}toExact(t={groupSeparator:""}){return na.DP=this.token.decimals,new na(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as Il}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ia}from"@solana/spl-token";var un={chainId:101,address:Il.default.toBase58(),programId:ia.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},it={chainId:101,address:"So11111111111111111111111111111111111111112",programId:ia.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as hr}from"@solana/web3.js";import{PublicKey as Ke,SystemProgram as oa,SYSVAR_RENT_PUBKEY as Bl}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as xl}from"@solana/spl-token";function B({pubkey:o,isSigner:e=!1,isWritable:t=!0}){return{pubkey:o,isWritable:t,isSigner:e}}var wr=[B({pubkey:xl,isWritable:!1}),B({pubkey:oa.programId,isWritable:!1}),B({pubkey:Bl,isWritable:!1})];function Ar({publicKey:o,transformSol:e}){let t=Pr(o.toString());if(t instanceof Ke)return e&&t.equals(ze)?j:t;if(e&&t.toString()===ze.toBase58())return j;if(typeof t=="string"){if(t===Ke.default.toBase58())return Ke.default;try{return new Ke(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function Pr(o){try{return new Ke(o)}catch{return o}}var oo=new Ke("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),cn=new Ke("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),ct=new Ke("SysvarRent111111111111111111111111111111111"),ra=new Ke("SysvarC1ock11111111111111111111111111111111"),zt=new Ke("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),Sl=new Ke("Sysvar1nstructions1111111111111111111111111"),kr=oa.programId,$p=new Ke("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Jp=new Ke("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),ef=new Ke("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),tf=new Ke("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),nf=new Ke("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),of=new Ke("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),rf=new Ke("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),sf=new Ke("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),af=new Ke("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),uf=new Ke("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),cf=new Ke("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),j=new Ke("So11111111111111111111111111111111111111112"),ze=Ke.default;function tt(o){return Ar({publicKey:o,transformSol:!0})}var Tr=class{constructor({mint:e,decimals:t,symbol:n,name:i,skipMint:r=!1,isToken2022:s=!1}){if(e===ze.toBase58()||e instanceof hr&&ze.equals(e)){this.decimals=it.decimals,this.symbol=it.symbol,this.name=it.name,this.mint=new hr(it.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=i||e.toString().substring(0,6),this.mint=r?hr.default:Ar({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Ce=Tr;Ce.WSOL=new Tr(U(M({},it),{mint:it.address}));var Ir=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},ro=Ir;ro.SOL=new Ir(un);import Kl from"bn.js";var sa=new be(new Kl(100)),Qe=class extends be{toSignificant(e=5,t,n){return this.mul(sa).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(sa).toFixed(e,t,n)}};var Cl=me("Raydium_price"),ft=class extends be{constructor(t){let{baseToken:n,quoteToken:i,numerator:r,denominator:s}=t;super(r,s);this.baseToken=n,this.quoteToken=i,this.scalar=new be(Br(n.decimals),Br(i.decimals))}get raw(){return new be(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new ft({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&Cl.logWithError("mul token not equals");let n=super.mul(t);return new ft({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,i){return this.adjusted.toSignificant(t,n,i)}toFixed(t=this.quoteToken.decimals,n,i){return this.adjusted.toFixed(t,n,i)}};import{PublicKey as Rl}from"@solana/web3.js";import Ll from"bn.js";function aa(o){return typeof o=="object"&&o!==null&&![Ce,Ae,Rl,be,Ll,ft,Qe].some(e=>typeof e=="object"&&o instanceof e)}function Ze(o){return typeof o=="string"?Pr(o):Array.isArray(o)?o.map(e=>Ze(e)):aa(o)?Object.fromEntries(Object.entries(o).map(([e,t])=>[e,Ze(t)])):o}var yt=new Qt(0),ua=new Qt(1),oy=new Qt(2),ry=new Qt(3),sy=new Qt(5),gr=new Qt(10),ay=new Qt(100),uy=new Qt(1e3),cy=new Qt(1e4);function Br(o){return gr.pow($(o))}function so(o,e){let t=o.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function cr(o,e=1,t=[]){let n=[...o];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}var Nt=class{constructor(e){this._owner=e}get publicKey(){return Nt.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return Nt.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return Nt.isKeyPair(this._owner)}get isPublicKey(){return Nt.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!Nt.isKeyPair(e)}};import{PublicKey as Vl}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as El}from"@solana/spl-token";import{ComputeBudgetProgram as ca,Keypair as ma,PublicKey as Ol,Transaction as da,TransactionMessage as Ml,VersionedTransaction as pa}from"@solana/web3.js";var W={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee",TransferTip:"TransferTip"};import{TOKEN_PROGRAM_ID as Nl}from"@solana/spl-token";var la=me("Raydium_txUtil"),fa=1644;function ao(o){let e=[],t=[];return o.microLamports&&(e.push(ca.setComputeUnitPrice({microLamports:o.microLamports})),t.push(W.SetComputeUnitPrice)),o.units&&(e.push(ca.setComputeUnitLimit({units:o.units})),t.push(W.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function Fn(o,e){var n,i;let t=e!=null?e:"confirmed";return(i=await((n=o.getLatestBlockhash)==null?void 0:n.call(o,{commitment:t})))==null?void 0:i.blockhash}async function uo(o,e){return o.getSignatureStatuses([e]),new Promise((t,n)=>{let i=setTimeout(n,6e4);o.onSignature(e,r=>{if(clearTimeout(i),!r.err){t("");return}n(Object.assign(r.err,{txId:e}))},"confirmed")})}function xr(o,e){o.length<1&&la.logWithError(`no instructions provided: ${o.toString()}`),e.length<1&&la.logWithError(`no signers provided:, ${e.toString()}`);let t=new da;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...o);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<fa}catch{return!1}}function de(o,e){let[t,n]=Ol.findProgramAddressSync(o,e);return{publicKey:t,nonce:n}}function ii({instructions:o,payer:e,signers:t}){return xr(o,[e,...t])}function oi({instructions:o,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=ma.generate().publicKey.toString()}){let r=new Ml({payerKey:e,recentBlockhash:n,instructions:o}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new pa(r).serialize()).toString("base64").length<fa}catch{return!1}}var vl=o=>Buffer.isBuffer(o)?o:o instanceof Uint8Array?Buffer.from(o.buffer,o.byteOffset,o.byteLength):Buffer.from(o),_l=o=>{let e=o.serialize({requireAllSignatures:!1,verifySignatures:!1});o instanceof pa&&(e=vl(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function Pn(o){let e=[];return o.forEach(t=>{t instanceof da&&(t.recentBlockhash||(t.recentBlockhash=Nl.toBase58()),t.feePayer||(t.feePayer=ma.generate().publicKey)),e.push(_l(t))}),console.log("simulate tx string:",e),e}function oe(o,e,t){return de([o.toBuffer(),(t!=null?t:El).toBuffer(),e.toBuffer()],new Vl("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as ae}from"@solana/web3.js";var ya=new ae("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),ba=new ae("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),ga=new ae("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),ri=new ae("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Ry=new ae("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),wa=new ae("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),Sr=new ae("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),co=new ae("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),Ly=new ae("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),Aa=new ae("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),kn=new ae("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),si=new ae("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),lo=new ae("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),Oy=new ae("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),Pa=new ae("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),Fl=new ae("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),Dl=new ae("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),Wl=new ae("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),ql=new ae("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),mo=new ae("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),ka=new ae("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),My=new ae("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),Ul=new ae("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Gl=new ae("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),Xl=new ae("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),po=new ae("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),zl=new ae("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),fo=new ae("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),Ql=new ae("7AFUeLVRjBfzqK3tTGw8hN48KLQWSk6DTE8xprWdPqix"),ai={IDO_PROGRAM_ID_V1:Fl,IDO_PROGRAM_ID_V2:Dl,IDO_PROGRAM_ID_V3:Wl,IDO_PROGRAM_ID_V4:ql};var Ny={SERUM_MARKET:ae.default,OPENBOOK_MARKET:new ae("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),UTIL1216:ae.default,FarmV3:new ae("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FarmV5:new ae("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FarmV6:new ae("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),AmmV4:new ae("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AmmStable:new ae("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM:new ae("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),CLMM_LOCK_PROGRAM_ID:new ae("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),CLMM_LOCK_AUTH_ID:new ae("8qmHNvu2Kr2C7U8mJL4Vz1vTDxMhVuXKREwU7TNoaVEo"),Router:new ae("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:Ul,CREATE_CPMM_POOL_AUTH:Gl,CREATE_CPMM_POOL_FEE_ACC:Xl,FEE_DESTINATION_ID:new ae("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR"),LOCK_CPMM_PROGRAM:zl,LCOK_CPMM_AUTH:Ql};import vt from"bn.js";var ui=1e4;function Pe(o,e,t,n){if(e===void 0)return{amount:o,fee:void 0,expirationTime:void 0};let i=U(M({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),r=t.epoch<i.newerTransferFee.epoch?i.olderTransferFee:i.newerTransferFee,s=new vt(r.maximumFee.toString()),a=t.epoch<i.newerTransferFee.epoch?(Number(i.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(r.transferFeeBasisPoints===ui){let c=new vt(r.maximumFee.toString());return{amount:o.add(c),fee:c,expirationTime:a}}else{let c=ln(o.mul(new vt(ui)),new vt(ui-r.transferFeeBasisPoints)),u=new vt(r.maximumFee.toString()),l=c.sub(o).gt(u)?o.add(u):c,m=ln(l.mul(new vt(r.transferFeeBasisPoints)),new vt(ui)),d=m.gt(s)?s:m;return{amount:l,fee:d,expirationTime:a}}else{let c=ln(o.mul(new vt(r.transferFeeBasisPoints)),new vt(ui)),u=c.gt(s)?s:c;return{amount:o,fee:u,expirationTime:a}}}function _t(o,e){return o===void 0?e:e===void 0?o:Math.min(o,e)}function ln(o,e){let{div:t,mod:n}=o.divmod(e);return n.gt(new vt(0))?t.add(new vt(1)):t}import{PublicKey as ha,AddressLookupTableAccount as yo}from"@solana/web3.js";async function Kr({connection:o,address:e}){let t=await Lt(o,[...new Set(e.map(i=>i.toString()))].map(i=>new ha(i))),n={};for(let i=0;i<e.length;i++){let r=t[i],s=e[i];if(!r)continue;let a=new yo({key:s,state:yo.deserialize(r.data)});n[s.toString()]=a,bo[s.toString()]=a}return n}var bo={"2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17":new yo({key:new ha("2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17"),state:yo.deserialize(Buffer.from("AQAAAP//////////d49+DAAAAAAAAQZMWvw7GUNJdaccNBVnb57OKakxL2BHLYvhRwVILRsgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMGRm/lIRcy/+ytunLDm+e8jOW7xfcSayxDmzpAAAAABt324ddloZPZy+FGzut5rBy0he1fWzeROoz1hX7/AKkG3fbh7nWP3hhCXbzkbM3athr8TYO5DSf+vfko2KGL/AVKU1D4XciC1hSlVnJ4iilt3x6rq9CmBniISTL07vagBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvDQdRqCgtphMF/imcN7mY5YRx2xE1A3MQ+L4QRaYK9u4GRfZP3LsAd00a+IkCpA22UNQMKdq5BFbJuwuOLqc8zxCTDlqxBG8J0HcxtfogQHDK06ukzfaXiNDKAob1MqBHS9lJxDYCwz8gd5DtFqNSTKG5l1zxIaKpDP/sffi2is1H9aKveyXSu5StXElYRl9SD5As0DHE4N0GLnf84/siiKXVyp4Ez121kLcUui/jLLFZEz/BwZK3Ilf9B9OcsEAeDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu9N9LMnrw/JNO0hqMVB4rk/2ou4AB1loQ7FZoPwut2o4KZB+0p9xnbrQKw038qjpHar+PyDwvxBRcu5hpHw3dguezeWv+IwvgW5icu8EGkhGa9AkFPPJT7VMSFb8xowveU=","base64"))})};import{PublicKey as Dn,sendAndConfirmTransaction as Cr,SystemProgram as Yl,Transaction as ci,TransactionMessage as li,VersionedTransaction as mi}from"@solana/web3.js";import Hl from"axios";var go=2e3,wo=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.loopMultiTxStatus=!!e.loopMultiTxStatus}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await Hl.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=ao(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}addTipInstruction(e){var t;return e?(this.endInstructions.push(Yl.transfer({fromPubkey:(t=e.feePayer)!=null?t:this.feePayer,toPubkey:new Dn(e.address),lamports:BigInt(e.amount.toString())})),this.endInstructionTypes.push(W.TransferTip),!0):!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:i=[],endInstructionTypes:r=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...i),this.endInstructionTypes.push(...r),this.lookupTableAddress.push(...s.filter(a=>a!==Dn.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0(M({},t||{})):this.build(t)}build(e){var n;let t=new ci;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,((n=this.owner)==null?void 0:n.signer)&&!this.signers.some(i=>i.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async i=>{var u;let{recentBlockHash:r,skipPreflight:s=!0,sendAndConfirm:a}=i||{},c=r!=null?r:await Fn(this.connection,this.blockhashCommitment);if(t.recentBlockhash=c,this.signers.length&&t.sign(...this.signers),Pn([t]),(u=this.owner)!=null&&u.isKeyPair)return{txId:a?await Cr(this.connection,t,this.signers.find(m=>m.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(t.serialize(),{skipPreflight:s}),signedTx:t};if(this.signAllTransactions){let l=await this.signAllTransactions([t]);if(this.signers.length)for(let m of l)try{m.sign(...this.signers)}catch{}return{txId:await this.connection.sendRawTransaction(l[0].serialize(),{skipPreflight:s}),signedTx:l[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){var u;let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:i}=this.build(n),r=t.filter(l=>l.transaction.instructions.length>0),s=[i,...r.map(l=>l.transaction)],a=[this.signers,...r.map(l=>l.signers)],c=[...this.instructionTypes,...r.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:c,execute:async l=>{var g;let{sequentially:m,onTxUpdate:d,skipTxCount:p=0,recentBlockHash:f,skipPreflight:y=!0}=l||{},b=f!=null?f:await Fn(this.connection,this.blockhashCommitment);if((g=this.owner)!=null&&g.isKeyPair){if(m){let w=[],A=0;for(let h of s){if(++A,A<=p)continue;let I=await Cr(this.connection,h,this.signers.find(k=>k.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:y});w.push(I)}return{txIds:w,signedTxs:s}}return{txIds:await await Promise.all(s.map(async w=>(w.recentBlockhash=b,await this.connection.sendRawTransaction(w.serialize(),{skipPreflight:y})))),signedTxs:s}}if(this.signAllTransactions){let w=s.map((h,I)=>(h.recentBlockhash=b,a[I].length&&h.sign(...a[I]),h));Pn(w);let A=await this.signAllTransactions(w);if(m){let h=0,I=[],k=async()=>{if(!A[h])return;let x=await this.connection.sendRawTransaction(A[h].serialize(),{skipPreflight:y});I.push({txId:x,status:"sent",signedTx:A[h]}),d==null||d([...I]),h++;let S=!1,K=null,T=null,C=R=>{K!==null&&clearInterval(K),T!==null&&this.connection.removeSignatureListener(T);let L=I.findIndex(v=>v.txId===x);if(L>-1){if(I[L].status==="error"||I[L].status==="success")return;I[L].status=R.err?"error":"success"}d==null||d([...I]),R.err||k()};this.loopMultiTxStatus&&(K=setInterval(async()=>{var R;if(S){clearInterval(K);return}try{let L=await this.connection.getTransaction(x,{commitment:"confirmed",maxSupportedTransactionVersion:0});L&&(S=!0,clearInterval(K),C({err:((R=L.meta)==null?void 0:R.err)||null}),console.log("tx status from getTransaction:",x))}catch(L){S=!0,clearInterval(K),console.error("getTransaction timeout:",L,x)}},go)),T=this.connection.onSignature(x,R=>{if(S){this.connection.removeSignatureListener(T);return}S=!0,C(R)},"confirmed"),this.connection.getSignatureStatus(x)};return await k(),{txIds:I.map(x=>x.txId),signedTxs:A}}else{let h=[];for(let I=0;I<A.length;I+=1){let k=await this.connection.sendRawTransaction(A[I].serialize(),{skipPreflight:y});h.push(k)}return{txIds:h,signedTxs:A}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){var y;let f=e||{},{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:i,recentBlockhash:r}=f,s=We(f,["lookupTableCache","lookupTableAddress","forerunCreate","recentBlockhash"]),a=M(M({},this.cluster==="devnet"?{}:bo),t),c=Array.from(new Set([...n,...this.lookupTableAddress])),u=[];for(let b of c)a[b]===void 0&&u.push(new Dn(b));let l=await Kr({connection:this.connection,address:u});for(let[b,g]of Object.entries(l))a[b]=g;let m=i?Dn.default.toBase58():r!=null?r:await Fn(this.connection,this.blockhashCommitment),d=new li({payerKey:this.feePayer,recentBlockhash:m,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(a));((y=this.owner)==null?void 0:y.signer)&&!this.signers.some(b=>b.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new mi(d);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async b=>{var A;let{skipPreflight:g=!0,sendAndConfirm:w}=b||{};if(Pn([p]),(A=this.owner)!=null&&A.isKeyPair){let h=await this.connection.sendTransaction(p,{skipPreflight:g});return w&&await uo(this.connection,h),{txId:h,signedTx:p}}if(this.signAllTransactions){let h=await this.signAllTransactions([p]);if(this.signers.length)for(let I of h)try{I.sign(this.signers)}catch{}return{txId:await this.connection.sendTransaction(h[0],{skipPreflight:g}),signedTx:h[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}async buildV0MultiTx(e){var u;let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:i}=await this.buildV0(n),r=t.filter(l=>l.builder.instructions.length>0),s=[i,...r.map(l=>l.transaction)],a=[this.signers,...r.map(l=>l.signers)],c=[...this.instructionTypes,...r.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(l,m)=>{l.sign(a[m])}),{builder:this,transactions:s,signers:a,instructionTypes:c,buildProps:n,execute:async l=>{var y;let{sequentially:m,onTxUpdate:d,recentBlockHash:p,skipPreflight:f=!0}=l||{};if(p&&s.forEach(b=>b.message.recentBlockhash=p),Pn(s),(y=this.owner)!=null&&y.isKeyPair){if(m){let b=[];for(let g of s){let w=await this.connection.sendTransaction(g,{skipPreflight:f});await uo(this.connection,w),b.push(w)}return{txIds:b,signedTxs:s}}return{txIds:await Promise.all(s.map(async b=>await this.connection.sendTransaction(b,{skipPreflight:f}))),signedTxs:s}}if(this.signAllTransactions){let b=await this.signAllTransactions(s);if(m){let g=0,w=[],A=async()=>{if(!b[g])return;let h=await this.connection.sendTransaction(b[g],{skipPreflight:f});w.push({txId:h,status:"sent",signedTx:b[g]}),d==null||d([...w]),g++;let I=!1,k=null,x=null,S=K=>{k!==null&&clearInterval(k),x!==null&&this.connection.removeSignatureListener(x);let T=w.findIndex(C=>C.txId===h);if(T>-1){if(w[T].status==="error"||w[T].status==="success")return;w[T].status=K.err?"error":"success"}d==null||d([...w]),K.err||A()};this.loopMultiTxStatus&&(k=setInterval(async()=>{var K;if(I){clearInterval(k);return}try{let T=await this.connection.getTransaction(h,{commitment:"confirmed",maxSupportedTransactionVersion:0});T&&(I=!0,clearInterval(k),S({err:((K=T.meta)==null?void 0:K.err)||null}),console.log("tx status from getTransaction:",h))}catch(T){I=!0,clearInterval(k),console.error("getTransaction timeout:",T,h)}},go)),x=this.connection.onSignature(h,K=>{if(I){this.connection.removeSignatureListener(x);return}I=!0,S(K)},"confirmed"),this.connection.getSignatureStatus(h)};return A(),{txIds:[],signedTxs:b}}else{let g=[];for(let w=0;w<b.length;w+=1){let A=await this.connection.sendTransaction(b[w],{skipPreflight:f});g.push(A)}return{txIds:g,signedTxs:b}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){var d;let m=e||{},{splitIns:t=[],computeBudgetConfig:n}=m,i=We(m,["splitIns","computeBudgetConfig"]),r=n?ao(n):{instructions:[],instructionTypes:[]},s=this.signers.reduce((p,f)=>U(M({},p),{[f.publicKey.toBase58()]:f}),{}),a=[],c=[],u=[],l=0;if(this.allInstructions.forEach(p=>{let f=[...u,p],y=n?[...r.instructions,...f]:f,g=[...new Set(f.map(w=>w.keys.filter(A=>A.isSigner).map(A=>A.pubkey.toString())).flat()).values()].map(w=>new Dn(w));if(p!==t[l]&&u.length<12&&(ii({instructions:y,payer:this.feePayer,signers:g})||ii({instructions:f,payer:this.feePayer,signers:g})))u.push(p);else{if(u.length===0)throw Error("item ins too big");l+=p===t[l]?1:0,ii({instructions:n?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:g})?a.push(new ci().add(...r.instructions,...u)):a.push(new ci().add(...u)),c.push(Array.from(new Set(u.map(w=>w.keys.filter(A=>A.isSigner).map(A=>A.pubkey.toString())).flat())).map(w=>s[w]).filter(w=>w!==void 0)),u=[p]}}),u.length>0){let f=[...new Set(u.map(y=>y.keys.filter(b=>b.isSigner).map(b=>b.pubkey.toString())).flat()).values()].map(y=>s[y]).filter(y=>y!==void 0);ii({instructions:n?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:f.map(y=>y.publicKey)})?a.push(new ci().add(...r.instructions,...u)):a.push(new ci().add(...u)),c.push(f)}return a.forEach(p=>p.feePayer=this.feePayer),(d=this.owner)!=null&&d.signer&&c.forEach(p=>{p.some(f=>f.publicKey.equals(this.owner.publicKey))||p.push(this.owner.signer)}),{builder:this,transactions:a,signers:c,instructionTypes:this.instructionTypes,execute:async p=>{var h;let{sequentially:f,onTxUpdate:y,skipTxCount:b=0,recentBlockHash:g,skipPreflight:w=!0}=p||{},A=g!=null?g:await Fn(this.connection,this.blockhashCommitment);if(a.forEach(async(I,k)=>{I.recentBlockhash=A,c[k].length&&I.sign(...c[k])}),Pn(a),(h=this.owner)!=null&&h.isKeyPair){if(f){let I=0,k=[];for(let x of a){if(++I,I<=b){k.push("tx skipped");continue}let S=await Cr(this.connection,x,this.signers.find(K=>K.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:w});k.push(S)}return{txIds:k,signedTxs:a}}return{txIds:await Promise.all(a.map(async I=>await this.connection.sendRawTransaction(I.serialize(),{skipPreflight:w}))),signedTxs:a}}if(this.signAllTransactions){let I=await this.signAllTransactions(a.slice(b,a.length)),k=[...a.slice(0,b),...I];if(f){let x=0,S=[],K=async()=>{if(!k[x])return;x<b&&(S.push({txId:"",status:"success",signedTx:k[x]}),y==null||y([...S]),x++,K());let T=await this.connection.sendRawTransaction(k[x].serialize(),{skipPreflight:w});S.push({txId:T,status:"sent",signedTx:k[x]}),y==null||y([...S]),x++;let C=!1,R=null,L=null,v=F=>{R!==null&&clearInterval(R),L!==null&&this.connection.removeSignatureListener(L);let _=S.findIndex(Z=>Z.txId===T);if(_>-1){if(S[_].status==="error"||S[_].status==="success")return;S[_].status=F.err?"error":"success"}y==null||y([...S]),F.err||K()};this.loopMultiTxStatus&&(R=setInterval(async()=>{var F;if(C){clearInterval(R);return}try{let _=await this.connection.getTransaction(T,{commitment:"confirmed",maxSupportedTransactionVersion:0});_&&(C=!0,clearInterval(R),v({err:((F=_.meta)==null?void 0:F.err)||null}),console.log("tx status from getTransaction:",T))}catch(_){C=!0,clearInterval(R),console.error("getTransaction timeout:",_,T)}},go)),L=this.connection.onSignature(T,F=>{if(C){this.connection.removeSignatureListener(L);return}C=!0,v(F)},"confirmed"),this.connection.getSignatureStatus(T)};return await K(),{txIds:S.map(T=>T.txId),signedTxs:k}}else{let x=[];for(let S=0;S<k.length;S+=1){let K=await this.connection.sendRawTransaction(k[S].serialize(),{skipPreflight:w});x.push(K)}return{txIds:x,signedTxs:k}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:i||{}}}async sizeCheckBuildV0(e){var A;let w=e||{},{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:i={},lookupTableAddress:r=[]}=w,s=We(w,["computeBudgetConfig","splitIns","lookupTableCache","lookupTableAddress"]),a=M(M({},this.cluster==="devnet"?{}:bo),i),c=Array.from(new Set([...this.lookupTableAddress,...r])),u=[];for(let h of c)a[h]===void 0&&u.push(new Dn(h));let l=await Kr({connection:this.connection,address:u});for(let[h,I]of Object.entries(l))a[h]=I;let m=t?ao(t):{instructions:[],instructionTypes:[]},d=await Fn(this.connection,this.blockhashCommitment),p=this.signers.reduce((h,I)=>U(M({},h),{[I.publicKey.toBase58()]:I}),{}),f=[],y=[],b=[],g=0;if(this.allInstructions.forEach(h=>{let I=[...b,h],k=t?[...m.instructions,...I]:I;if(h!==n[g]&&b.length<12&&(oi({instructions:k,payer:this.feePayer,lookupTableAddressAccount:a})||oi({instructions:I,payer:this.feePayer,lookupTableAddressAccount:a})))b.push(h);else{if(b.length===0)throw Error("item ins too big");g+=h===n[g]?1:0;let x={};for(let S of[...new Set(c)])a[S]!==void 0&&(x[S]=a[S]);if(t&&oi({instructions:[...m.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:d})){let S=new li({payerKey:this.feePayer,recentBlockhash:d,instructions:[...m.instructions,...b]}).compileToV0Message(Object.values(a));f.push(new mi(S))}else{let S=new li({payerKey:this.feePayer,recentBlockhash:d,instructions:[...b]}).compileToV0Message(Object.values(a));f.push(new mi(S))}y.push(Array.from(new Set(b.map(S=>S.keys.filter(K=>K.isSigner).map(K=>K.pubkey.toString())).flat())).map(S=>p[S]).filter(S=>S!==void 0)),b=[h]}}),b.length>0){let I=[...new Set(b.map(k=>k.keys.filter(x=>x.isSigner).map(x=>x.pubkey.toString())).flat()).values()].map(k=>p[k]).filter(k=>k!==void 0);if(t&&oi({instructions:[...m.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:d})){let k=new li({payerKey:this.feePayer,recentBlockhash:d,instructions:[...m.instructions,...b]}).compileToV0Message(Object.values(a));f.push(new mi(k))}else{let k=new li({payerKey:this.feePayer,recentBlockhash:d,instructions:[...b]}).compileToV0Message(Object.values(a));f.push(new mi(k))}y.push(I)}return(A=this.owner)!=null&&A.signer&&y.forEach(h=>{h.some(I=>I.publicKey.equals(this.owner.publicKey))||h.push(this.owner.signer)}),{builder:this,transactions:f,buildProps:e,signers:y,instructionTypes:this.instructionTypes,execute:async h=>{var T;let{sequentially:I,onTxUpdate:k,skipTxCount:x=0,recentBlockHash:S,skipPreflight:K=!0}=h||{};if(f.map(async(C,R)=>{y[R].length&&C.sign(y[R]),S&&(C.message.recentBlockhash=S)}),Pn(f),(T=this.owner)!=null&&T.isKeyPair){if(I){let C=0,R=[];for(let L of f){if(++C,C<=x){console.log("skip tx: ",C),R.push("tx skipped");continue}let v=await this.connection.sendTransaction(L,{skipPreflight:K});await uo(this.connection,v),R.push(v)}return{txIds:R,signedTxs:f}}return{txIds:await Promise.all(f.map(async C=>await this.connection.sendTransaction(C,{skipPreflight:K}))),signedTxs:f}}if(this.signAllTransactions){let C=await this.signAllTransactions(f.slice(x,f.length)),R=[...f.slice(0,x),...C];if(I){let L=0,v=[],F=async()=>{if(!R[L])return;if(L<x){v.push({txId:"",status:"success",signedTx:R[L]}),k==null||k([...v]),L++,F();return}let _=await this.connection.sendTransaction(R[L],{skipPreflight:K});v.push({txId:_,status:"sent",signedTx:R[L]}),k==null||k([...v]),L++;let Z=!1,ce=null,ve=null,Je=ge=>{ce!==null&&clearInterval(ce),ve!==null&&this.connection.removeSignatureListener(ve);let _e=v.findIndex(ut=>ut.txId===_);if(_e>-1){if(v[_e].status==="error"||v[_e].status==="success")return;v[_e].status=ge.err?"error":"success"}k==null||k([...v]),ge.err||F()};this.loopMultiTxStatus&&(ce=setInterval(async()=>{var ge;if(Z){clearInterval(ce);return}try{let _e=await this.connection.getTransaction(_,{commitment:"confirmed",maxSupportedTransactionVersion:0});_e&&(Z=!0,clearInterval(ce),Je({err:((ge=_e.meta)==null?void 0:ge.err)||null}),console.log("tx status from getTransaction:",_))}catch(_e){Z=!0,clearInterval(ce),console.error("getTransaction timeout:",_e,_)}},go)),ve=this.connection.onSignature(_,ge=>{if(Z){this.connection.removeSignatureListener(ve);return}Z=!0,Je(ge)},"confirmed"),this.connection.getSignatureStatus(_)};return F(),{txIds:[],signedTxs:R}}else{let L=[];for(let v=0;v<R.length;v+=1){let F=await this.connection.sendTransaction(R[v],{skipPreflight:K});L.push(F)}return{txIds:L,signedTxs:R}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}};var Ye={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SERVICE_1_BASE_HOST:"https://service-v1.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://tokens.jup.ag/tokens?tags=lst,community",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",OWNER_LOCK_POSITION:"/position/clmm-lock/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",CPMM_LOCK:"https://dynamic-ipfs.raydium.io/lock/cpmm/position"},Ab=M({},Ye);var Ta="ray_tab_hash",Rr="ray_req_hash",jl=()=>{if(typeof window===void 0)return"";let o=sessionStorage.getItem(Ta);return o||(o=`ray-${Date.now()}`,sessionStorage.setItem(Ta,o)),o},Ao=async n=>{var i=n,{logCount:o=1e3,removeLastLog:e}=i,t=We(i,["logCount","removeLastLog"]);if(typeof window===void 0)return new Promise(s=>s());let r=JSON.parse(localStorage.getItem(Rr)||"[]").slice(0,o-1);e&&r.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),r.unshift(U(M({},t),{time:Date.now(),session:jl()}));try{localStorage.setItem(Rr,JSON.stringify(r))}catch{if(e){let s=!1,a=JSON.stringify(t.data).substring(0,100);for(r[0].data=a+(a.length>100?"...":"");!s;){r.pop();let c=JSON.stringify(t.data).substring(0,100);r[0].data=c+(c.length>100?"...":"");try{localStorage.setItem(Rr,JSON.stringify(r)),s=!0}catch{s=!1}}return new Promise(c=>c())}return Ao(U(M({},t),{logCount:o,removeLastLog:!0}))}};var Po=me("Raydium_Api"),Lr=new Map;var ko=class{constructor({cluster:e,timeout:t,logRequests:n,logCount:i,urlConfigs:r}){this.cluster=e,this.urlConfigs=r||{},this.logCount=i||1e3,this.api=Ia.create({baseURL:this.urlConfigs.BASE_HOST||Ye.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:c,url:u}=s;return Po.debug(`${a==null?void 0:a.toUpperCase()} ${c}${u}`),s},s=>(Po.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:c,status:u}=s,{method:l,baseURL:m,url:d}=a;return n&&Ao({status:u,url:`${m}${d}`,params:a.params,data:c,logCount:this.logCount}),Po.debug(`${l==null?void 0:l.toUpperCase()} ${m}${d}  ${u}`),c},s=>{let{config:a,response:c={}}=s,{status:u}=c,{method:l,baseURL:m,url:d}=a;return n&&Ao({status:u,url:`${m}${d}`,params:a.params,data:s.message,logCount:this.logCount}),Po.error(`${l.toUpperCase()} ${m}${d} ${u||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||Ye.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||Ye.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||Ye.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await Ia.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(i=>i.numSlots);return n.reduce((i,r)=>i+r,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||Ye.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||Ye.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||Ye.TOKEN_LIST)).data}async getJupTokenList(){return this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||Ye.JUP_TOKEN_LIST})}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||Ye.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:i="desc",page:r=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||Ye.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${i}&page=${r}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||Ye.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],i=t.filter(s=>Lr.has(s)?(n.push(Lr.get(s)),!1):!0),r=[];return i.length&&(r=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||Ye.POOL_KEY_BY_ID)+`?ids=${i.join(",")}`)).data.filter(Boolean),r.forEach(a=>{Lr.set(a.id,a)})),n.concat(r)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:i="all",sort:r="default",order:s="desc",page:a=1}=e,[c,u]=[t&&tt(t).toBase58(),n&&n!=="undefined"?tt(n).toBase58():""],[l,m]=u&&c>u?[u,c]:[c,u];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||Ye.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${m}&poolType=${i}&poolSortField=${r}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||Ye.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||Ye.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||Ye.CHECK_AVAILABILITY)).data}};var ho="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",Ba="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{PublicKey as Co,SystemProgram as Bm}from"@solana/web3.js";import{AccountLayout as Gn,createAssociatedTokenAccountInstruction as qr,TOKEN_PROGRAM_ID as pn,TOKEN_2022_PROGRAM_ID as xm}from"@solana/spl-token";var Or=(...o)=>o.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Le=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=me(t)}createTxBuilder(e){return this.scope.checkOwner(),new wo({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Or(e))}logInfo(...e){this.logger.info(Or(e))}logAndCreateError(...e){let t=Or(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as Am,SystemProgram as Pm}from"@solana/web3.js";import km from"bn.js";import{createCloseAccountInstruction as hm,createInitializeAccountInstruction as Tm,createTransferInstruction as Im,TOKEN_PROGRAM_ID as Un}from"@solana/spl-token";import{Keypair as ym,PublicKey as Fa}from"@solana/web3.js";import bm from"bn.js";import{TOKEN_PROGRAM_ID as gm}from"@solana/spl-token";function Zl(o){return o instanceof Uint8Array||o!=null&&typeof o=="object"&&o.constructor.name==="Uint8Array"}function Mr(o,...e){if(!Zl(o))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(o.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${o.length}`)}function Nr(o,e=!0){if(o.destroyed)throw new Error("Hash instance has been destroyed");if(e&&o.finished)throw new Error("Hash#digest() has already been called")}function xa(o,e){Mr(o);let t=e.outputLen;if(o.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var Io=o=>new DataView(o.buffer,o.byteOffset,o.byteLength),Vt=(o,e)=>o<<32-e|o>>>e;var tg=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function $l(o){if(typeof o!="string")throw new Error(`utf8ToBytes expected string, got ${typeof o}`);return new Uint8Array(new TextEncoder().encode(o))}function vr(o){return typeof o=="string"&&(o=$l(o)),Mr(o),o}var To=class{clone(){return this._cloneInto()}},ng={}.toString;function Sa(o){let e=n=>o().update(vr(n)).digest(),t=o();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>o(),e}function Jl(o,e,t,n){if(typeof o.setBigUint64=="function")return o.setBigUint64(e,t,n);let i=BigInt(32),r=BigInt(4294967295),s=Number(t>>i&r),a=Number(t&r),c=n?4:0,u=n?0:4;o.setUint32(e+c,s,n),o.setUint32(e+u,a,n)}var Ka=(o,e,t)=>o&e^~o&t,Ca=(o,e,t)=>o&e^o&t^e&t,Bo=class extends To{constructor(e,t,n,i){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Io(this.buffer)}update(e){Nr(this);let{view:t,buffer:n,blockLen:i}=this;e=vr(e);let r=e.length;for(let s=0;s<r;){let a=Math.min(i-this.pos,r-s);if(a===i){let c=Io(e);for(;i<=r-s;s+=i)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Nr(this),xa(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:i,isLE:r}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>i-s&&(this.process(n,0),s=0);for(let m=s;m<i;m++)t[m]=0;Jl(n,i-8,BigInt(this.length*8),r),this.process(n,0);let a=Io(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<u;m++)a.setUint32(4*m,l[m],r)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:i,finished:r,destroyed:s,pos:a}=this;return e.length=i,e.pos=a,e.finished=r,e.destroyed=s,i%t&&e.buffer.set(n),e}};var em=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),mn=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),dn=new Uint32Array(64),_r=class extends Bo{constructor(){super(64,32,8,!1),this.A=mn[0]|0,this.B=mn[1]|0,this.C=mn[2]|0,this.D=mn[3]|0,this.E=mn[4]|0,this.F=mn[5]|0,this.G=mn[6]|0,this.H=mn[7]|0}get(){let{A:e,B:t,C:n,D:i,E:r,F:s,G:a,H:c}=this;return[e,t,n,i,r,s,a,c]}set(e,t,n,i,r,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=r|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let m=0;m<16;m++,t+=4)dn[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let d=dn[m-15],p=dn[m-2],f=Vt(d,7)^Vt(d,18)^d>>>3,y=Vt(p,17)^Vt(p,19)^p>>>10;dn[m]=y+dn[m-7]+f+dn[m-16]|0}let{A:n,B:i,C:r,D:s,E:a,F:c,G:u,H:l}=this;for(let m=0;m<64;m++){let d=Vt(a,6)^Vt(a,11)^Vt(a,25),p=l+d+Ka(a,c,u)+em[m]+dn[m]|0,y=(Vt(n,2)^Vt(n,13)^Vt(n,22))+Ca(n,i,r)|0;l=u,u=c,c=a,a=s+p|0,s=r,r=i,i=n,n=p+y|0}n=n+this.A|0,i=i+this.B|0,r=r+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,i,r,s,a,c,u,l)}roundClean(){dn.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var Ra=Sa(()=>new _r);import{PublicKey as dm}from"@solana/web3.js";import va,{isBN as _a}from"bn.js";import{bits as tm,BitStructure as mg,blob as nm,Blob as dg,cstr as pg,f32 as fg,f32be as yg,f64 as bg,f64be as gg,greedy as wg,Layout as im,ns64 as Ag,ns64be as Pg,nu64 as om,nu64be as kg,offset as hg,s16 as Tg,s16be as Ig,s24 as Bg,s24be as xg,s32 as rm,s32be as Sg,s40 as Kg,s40be as Cg,s48 as Rg,s48be as Lg,s8 as Og,seq as sm,struct as Mg,Structure as am,u16 as um,u16be as Ng,u24 as vg,u24be as _g,u32 as cm,u32be as Vg,u40 as Eg,u40be as Fg,u48 as Dg,u48be as Wg,u8 as lm,UInt as mm,union as qg,Union as Ug,unionLayoutDiscriminator as Gg,utf8 as Xg}from"@solana/buffer-layout";var xo=im,La=am;var Vr=mm;var Oa=lm,Yt=um;var Er=cm;var Ma=om;var xe=rm;var Na=sm;var we=nm;var Fr=tm;var hn=class extends xo{constructor(t,n,i){super(t,i);this.blob=we(t),this.signed=n}decode(t,n=0){let i=new va(this.blob.decode(t,n),10,"le");return this.signed?i.fromTwos(this.span*8).clone():i}encode(t,n,i=0){return typeof t=="number"&&(t=new va(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,i)}},So=class extends xo{constructor(t){super(8,t);this._lower=Fr(Er(),!1),this._upper=Fr(Er(),!1)}addBoolean(t){this._lower.fields.length<32?this._lower.addBoolean(t):this._upper.addBoolean(t)}decode(t,n=0){let i=this._lower.decode(t,n),r=this._upper.decode(t,n+this._lower.span);return M(M({},i),r)}encode(t,n,i=0){return this._lower.encode(t,n,i)+this._upper.encode(t,n,i+this._lower.span)}};function X(o){return new Vr(1,o)}function ot(o){return new Vr(4,o)}function P(o){return new hn(8,!1,o)}function ee(o){return new hn(16,!1,o)}function Va(o){return new hn(1,!0,o)}function Wn(o){return new hn(8,!0,o)}function Ea(o){return new hn(16,!0,o)}var Ko=class extends xo{constructor(t,n,i,r){super(t.span,r);this.layout=t,this.decoder=n,this.encoder=i}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,i){return this.layout.encode(this.encoder(t),n,i)}getSpan(t,n){return this.layout.getSpan(t,n)}};function O(o){return new Ko(we(32),e=>new dm(e),e=>e.toBuffer(),o)}function Oe(o){return new Ko(Oa(),pm,fm,o)}function pm(o){if(o===0)return!1;if(o===1)return!0;throw new Error("Invalid bool: "+o)}function fm(o){return o?1:0}var Dr=class extends La{decode(e,t){return super.decode(e,t)}};function q(o,e,t){return new Dr(o,e,t)}function H(o,e,t){let n,i=typeof e=="number"?e:_a(e)?e.toNumber():new Proxy(e,{get(r,s){if(!n){let a=Reflect.get(r,"count");n=_a(a)?a.toNumber():a,Reflect.set(r,"count",n)}return Reflect.get(r,s)},set(r,s,a){return s==="count"&&(n=a),Reflect.set(r,s,a)}});return Na(o,i,t)}var qn=q([O("mint"),O("owner"),P("amount"),ot("delegateOption"),O("delegate"),X("state"),ot("isNativeOption"),P("isNative"),P("delegatedAmount"),ot("closeAuthorityOption"),O("closeAuthority")]);var pw=me("Raydium_Util");function Da({owner:o,solAccountResp:e,tokenAccountResp:t}){let n=[],i=[];for(let{pubkey:r,account:s}of t.value){let a=qn.decode(s.data),{mint:c,amount:u}=a;n.push({publicKey:r,mint:c,amount:u,isAssociated:oe(o,c,s.owner).publicKey.equals(r),isNative:!1,programId:s.owner}),i.push({pubkey:r,accountInfo:a,programId:s.owner})}return e&&n.push({mint:Fa.default,amount:new bm(String(e.lamports)),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:i}}function Ve({fromPublicKey:o,programId:e=gm,assignSeed:t}){let n=t?btoa(t).slice(0,32):ym.generate().publicKey.toBase58().slice(0,32);return{publicKey:wm(o,n,e),seed:n}}function wm(o,e,t){let n=Buffer.concat([o.toBuffer(),Buffer.from(e),t.toBuffer()]),i=Ra(n);return new Fa(i)}function Wr(o){let{mint:e,tokenAccount:t,owner:n,programId:i=Un}=o;return Tm(t,e,n,i)}function Ht(o){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:i,programId:r=Un}=o;return hm(e,t,i,n,r)}async function jt(o){let{connection:e,amount:t,commitment:n,payer:i,owner:r,skipCloseAccount:s}=o,a=await e.getMinimumBalanceForRentExemption(qn.span,n),c=$(t).add(new km(a)),u=Ve({fromPublicKey:i,programId:Un});return{addresses:{newAccount:u.publicKey},signers:[],instructions:[Pm.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:u.seed,newAccountPubkey:u.publicKey,lamports:c.toNumber(),space:qn.span,programId:Un}),Wr({mint:new Am(it.address),tokenAccount:u.publicKey,owner:r,programId:Un})],instructionTypes:[W.CreateAccount,W.InitAccount],endInstructionTypes:s?[]:[W.CloseAccount],endInstructions:s?[]:[Ht({tokenAccount:u.publicKey,payer:i,owner:r})]}}function Wa({source:o,destination:e,owner:t,amount:n,multiSigners:i=[],tokenProgram:r=Un}){return Im(o,e,t,BigInt(String(n)),i,r)}var pi=class extends Le{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._accountListener=[];this._clientOwnedToken=!1;this._notSubscribeAccountChange=!1;this._accountFetchTime=0;let{tokenAccounts:n,tokenAccountRawInfos:i,notSubscribeAccountChange:r}=t;this._tokenAccounts=n||[],this._tokenAccountRawInfos=i||[],this._notSubscribeAccountChange=r!=null?r:!0,this._clientOwnedToken=!!(n||i)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}set notSubscribeAccountChange(t){this._notSubscribeAccountChange=t}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:n}){return t&&(this._tokenAccounts=t),n&&(this._tokenAccountRawInfos=n),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(n=>n!==t),this}getAssociatedTokenAccount(t,n){return oe(this.scope.ownerPubKey,t,n).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<(this._notSubscribeAccountChange?1e3*5:1e3*60*3))return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let i=M(M({},{}),t),[r,s,a]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:pn},i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:xm},i.commitment)]),{tokenAccounts:c,tokenAccountRawInfos:u}=Da({owner:this.scope.ownerPubKey,solAccountResp:r,tokenAccountResp:{context:s.context,value:[...s.value,...a.value]}});return this._tokenAccounts=c,this._tokenAccountRawInfos=u,this._accountFetchTime=Date.now(),this._notSubscribeAccountChange||(this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>{this.fetchWalletTokenAccounts({forceUpdate:!0}),this._accountListener.forEach(l=>l({tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos}))},{commitment:t==null?void 0:t.commitment})),{tokenAccounts:c,tokenAccountRawInfos:u}}clearAccountChangeCkb(){this._accountChangeListenerId!==void 0&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId)}async getCreatedTokenAccount({mint:t,programId:n=pn,associatedOnly:i=!0}){await this.fetchWalletTokenAccounts();let r=this._tokenAccounts.filter(({mint:a})=>a==null?void 0:a.equals(t)).sort((a,c)=>a.amount.lt(c.amount)?1:-1),s=this.getAssociatedTokenAccount(t,n);for(let a of r){let{publicKey:c}=a;if(c&&(!i||i&&s.equals(c)))return c}}async getOrCreateTokenAccount(t){var y,b,g,w;await this.fetchWalletTokenAccounts();let{mint:n,createInfo:i,associatedOnly:r,owner:s,notUseTokenAccount:a=!1,skipCloseAccount:c=!1,checkCreateATAOwner:u=!1,assignSeed:l}=t,m=new Co(t.tokenProgram||pn),d=this.getAssociatedTokenAccount(n,new Co(m)),p=(a?[]:this.tokenAccountRawInfos).filter(A=>A.accountInfo.mint.equals(n)&&(!r||A.pubkey.equals(d))).sort((A,h)=>A.accountInfo.amount.lt(h.accountInfo.amount)?1:-1);if(i===void 0||p.length>0)return p.length>0?{account:p[0].pubkey}:{};let f={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(r){let A=qr(s,d,s,n,m),h=this.tokenAccountRawInfos.find(I=>I.pubkey.equals(d));if(u){let I=await this.scope.connection.getAccountInfo(d);if(I===null)(y=f.instructions)==null||y.push(A),f.instructionTypes.push(W.CreateATA);else if(!(I.owner.equals(m)&&Gn.decode(I.data).mint.equals(n)&&Gn.decode(I.data).owner.equals(s)))throw Error(`create ata check error -> mint: ${n.toString()}, ata: ${d.toString()}`)}else h===void 0&&(f.instructions.push(A),f.instructionTypes.push(W.CreateATA));if(n.equals(j)&&i.amount){let I=await jt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:i.payer||this.scope.ownerPubKey,amount:(b=i.amount)!=null?b:0,skipCloseAccount:c});f.instructions.push(...I.instructions||[]),f.endInstructions.push(...I.endInstructions||[]),f.instructionTypes.push(...I.instructionTypes||[]),f.endInstructionTypes.push(...I.endInstructionTypes||[]),i.amount&&(f.instructions.push(Wa({source:I.addresses.newAccount,destination:d,owner:this.scope.ownerPubKey,amount:i.amount,tokenProgram:pn})),f.instructionTypes.push(W.TransferAmount))}return!c&&h===void 0&&(f.endInstructions.push(Ht({owner:s,payer:i.payer||s,tokenAccount:d,programId:m})),f.endInstructionTypes.push(W.CloseAccount)),{account:d,instructionParams:f}}else{let A=Ve({fromPublicKey:s,programId:m,assignSeed:l}),h=await this.scope.connection.getMinimumBalanceForRentExemption(Gn.span),I=Bm.createAccountWithSeed({fromPubkey:s,basePubkey:s,seed:A.seed,newAccountPubkey:A.publicKey,lamports:h+Number((w=(g=i.amount)==null?void 0:g.toString())!=null?w:0),space:Gn.span,programId:m});return f.instructions.push(I,Wr({mint:n,tokenAccount:A.publicKey,owner:this.scope.ownerPubKey,programId:m})),f.instructionTypes.push(W.CreateAccount),f.instructionTypes.push(W.InitAccount),c||(f.endInstructions.push(Ht({owner:s,payer:i.payer||s,tokenAccount:A.publicKey,programId:m})),f.endInstructionTypes.push(W.CloseAccount)),{account:A.publicKey,instructionParams:f}}}async checkOrCreateAta({mint:t,programId:n=pn,autoUnwrapWSOLToSOL:i}){var c;await this.fetchWalletTokenAccounts();let r=(c=this.scope.account.tokenAccounts.find(({mint:u})=>(u==null?void 0:u.toBase58())===t.toBase58()))==null?void 0:c.publicKey,s=this.scope.ownerPubKey,a={};if(!r){let u=this.getAssociatedTokenAccount(t,n),l=await qr(s,u,s,t,n);a.instructions=[l],a.instructionTypes=[W.CreateATA],r=u}return i&&j.toBase58()===t.toBase58()&&(a.endInstructions=[Ht({owner:s,payer:s,tokenAccount:r,programId:n})],a.endInstructionTypes=[W.CloseAccount]),{pubKey:r,newInstructions:a}}async handleTokenAccount(t){let{side:n,amount:i,mint:r,programId:s=pn,tokenAccount:a,payer:c=this.scope.ownerPubKey,bypassAssociatedCheck:u,skipCloseAccount:l,checkCreateATAOwner:m}=t,d=this.getAssociatedTokenAccount(r,s);if(new Co(j).equals(r)){let p=await jt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:c,amount:i,skipCloseAccount:l});return M({tokenAccount:p.addresses.newAccount},p)}else if(!a||n==="out"&&!d.equals(a)&&!u){let p=[],f=qr(this.scope.ownerPubKey,d,this.scope.ownerPubKey,r,s);if(m){let y=await this.scope.connection.getAccountInfo(d);if(y===null)p.push(f);else if(!(y.owner.equals(pn)&&Gn.decode(y.data).mint.equals(r)&&Gn.decode(y.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${r.toString()}, ata: ${d.toString()}`)}else p.push(f);return{tokenAccount:d,instructions:p,instructionTypes:[W.CreateATA]}}return{tokenAccount:a}}async processTokenAccount(t){let{mint:n,programId:i=pn,amount:r,useSOLBalance:s,handleTokenAccount:a,feePayer:c}=t,u,l=this.createTxBuilder(c);if(n.equals(new Co(j))&&s){let m=await this.handleTokenAccount({side:"in",amount:r||0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:p}=m,f=We(m,["tokenAccount"]);u=p,l.addInstruction(f)}else if(u=await this.getCreatedTokenAccount({mint:n,associatedOnly:!1,programId:i}),!u&&a){let d=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:p}=d,f=We(d,["tokenAccount"]);u=p,l.addInstruction(f)}return M({tokenAccount:u},l.AllTxData)}};import{PublicKey as ke,SystemProgram as Um}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as Gm}from"@solana/spl-token";import{PublicKey as Ga}from"@solana/web3.js";var Ur=q([X("instruction")]),Gr=q([X("instruction")]),Sm=q([P("rewardState"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardLastUpdateTime"),P("totalReward"),P("totalRewardEmissioned"),P("rewardClaimed"),P("rewardPerSecond"),ee("accRewardPerShare"),O("rewardVault"),O("rewardMint"),O("rewardSender"),P("rewardType"),H(P(),15,"padding")]),Km=q([P("state"),P("nonce"),O("lpVault"),O("rewardVault"),O(),O(),P(),P(),P("totalReward"),ee("perShareReward"),P("lastSlot"),P("perSlotReward")]),Cm=q([P("state"),P("nonce"),O("lpVault"),O("rewardVaultA"),P("totalRewardA"),ee("perShareRewardA"),P("perSlotRewardA"),X("option"),O("rewardVaultB"),we(7),P("totalRewardB"),ee("perShareRewardB"),P("perSlotRewardB"),P("lastSlot"),O()]),Rm=q([P(),P("state"),P("nonce"),P("validRewardTokenNum"),ee("rewardMultiplier"),P("rewardPeriodMax"),P("rewardPeriodMin"),P("rewardPeriodExtend"),O("lpMint"),O("lpVault"),H(Sm,5,"rewardInfos"),O("creator"),O(),H(P(),32,"padding")]),Lm=new Proxy(Km,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return U(M({},i),{version:3,rewardInfos:[{rewardVault:i.rewardVault,totalReward:i.totalReward,perSlotReward:i.perSlotReward,perShareReward:i.perShareReward}]})}:Reflect.get(o,e,t)}}),Om=new Proxy(Cm,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return U(M({},i),{version:5,rewardInfos:[{rewardVault:i.rewardVaultA,totalReward:i.totalRewardA,perSlotReward:i.perSlotRewardA,perShareReward:i.perShareRewardA},{rewardVault:i.rewardVaultB,totalReward:i.totalRewardB,perSlotReward:i.perSlotRewardB,perShareReward:i.perShareRewardB}]})}:Reflect.get(o,e,t)}}),Ro=new Proxy(Rm,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return U(M({},i),{version:6,rewardInfos:i.rewardInfos.map(r=>{var s;return U(M({},r),{rewardType:((s=Object.entries(fn).find(a=>String(a[1])===r.rewardType.toString()))!=null?s:["Standard SPL"])[0]})})})}:Reflect.get(o,e,t)}}),Mm=q([P("isSet"),P("rewardPerSecond"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardType")]),Xr=q([X("instruction"),P("nonce"),H(Mm,5,"rewardTimeInfo")]),zr=q([X("instruction"),P("rewardReopenTime"),P("rewardEndTime"),P("rewardPerSecond")]),Qr=q([X("instruction"),P("isSet"),P("rewardPerSecond"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardType")]),Xw=q([P("state"),O("id"),O("owner"),P("deposited"),H(P(),1,"rewardDebts")]),Yr=q([P("state"),O("id"),O("owner"),P("deposited"),H(ee(),1,"rewardDebts"),P(""),P("voteLockedBalance"),H(P(),15)]),zw=q([P("state"),O("id"),O("owner"),P("deposited"),H(P(),2,"rewardDebts")]),qa=q([P("state"),O("id"),O("owner"),P("deposited"),H(ee(),2,"rewardDebts"),H(P(),17)]),Ua=q([P(),P("state"),O("id"),O("owner"),P("deposited"),H(ee(),5,"rewardDebts"),H(P(),16)]),gt=q([X("instruction"),P("amount")]),Nm=q([O("mint"),O("grantAuthority"),P("baselineVoteWeightScaledFactor"),P("maxExtraLockupVoteWeightScaledFactor"),P("lockupSaturationSecs"),Va("digitShift"),H(X(),7,"reserved1"),H(P(),7,"reserved2")]),vm=q([we(8),O("governanceProgramId"),O("realm"),O("realmGoverningTokenMint"),O("realmAuthority"),H(X(),32,"reserved1"),H(Nm,4,"votingMints"),Wn("timeOffset"),X("bump"),H(X(),7,"reserved2"),H(P(),11,"reserved3")]),_m=q([Wn("startTime"),Wn("endTime"),X("kind"),H(X(),15,"reserved")]),Vm=q([H(_m,1,"lockup"),P("amountDeposited_native"),P("amountInitiallyLockedNative"),Oe("isUsed"),Oe("allowClawback"),X("votingMintConfigIdx"),H(X(),29,"reserved")]),Em=q([we(8),O("voterAuthority"),O("registrar"),H(Vm,32,"deposits"),X("voterBump"),X("voterWweightRecordBump"),H(X(),94,"reserved")]);var eA=me("Raydium_farm_config"),Xa=new Ga("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),za=new Ga("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1");var Qa={3:Yr,5:qa,6:Ua},Hr=o=>[3,4,5,6].indexOf(o)!==-1,jr=o=>{var s;let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=o,i=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`,r={3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${i}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${i}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${i}`}};return(s=r[e])==null?void 0:s.call(r)},fn={"Standard SPL":0,"Option tokens":1},It={[ya.toString()]:3,[ba.toString()]:4,[ga.toString()]:5,[ri.toString()]:6};import{PublicKey as le,SystemProgram as ja,SYSVAR_CLOCK_PUBKEY as bi,SYSVAR_RENT_PUBKEY as Wm,TransactionInstruction as xt}from"@solana/web3.js";import Za from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as OA,createAssociatedTokenAccountInstruction as MA,TOKEN_PROGRAM_ID as Zt}from"@solana/spl-token";import Fm from"bn.js";var Dm=me("Raydium.farm.util");function fi({programId:o,poolId:e,mint:t,type:n}){let{publicKey:i}=de([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],o);return i}function Bt({programId:o,poolId:e,owner:t,version:n}){let{publicKey:i}=de([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],o);return i}var Ya=({programId:o,poolId:e})=>de([e.toBuffer()],o);function Ha(o){return{isSet:new Fm(1),rewardPerSecond:$(o.perSecond),rewardOpenTime:$(o.openTime),rewardEndTime:$(o.endTime),rewardType:$(fn[o.rewardType])}}function Zr(o){return $(o.endTime).sub($(o.openTime)).mul($(o.perSecond))}function yi(o){let e=Qa[o];return e||Dm.logWithError("invalid version",o),e}var qm=me("Raydium_farm_instruction"),GA={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function gi(o){let{version:e,id:t,ledger:n,programId:i,owner:r}=o,s={3:9,5:10}[e];s||qm.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(Ur.span);Ur.encode({instruction:s},a);let c=[B({pubkey:t}),B({pubkey:n}),B({pubkey:r,isWritable:!1}),B({pubkey:ja.programId,isWritable:!1}),B({pubkey:Wm,isWritable:!1})];return{instruction:new xt({programId:i,keys:c,data:a}),instructionType:W.FarmV3CreateLedger}}function $a(o){var n;let e=Buffer.alloc(Xr.span);Xr.encode({instruction:0,nonce:new Za(o.nonce),rewardTimeInfo:o.rewardInfoConfig},e);let t=[...wr,B({pubkey:o.farmId}),B({pubkey:o.farmAuthority,isWritable:!1}),B({pubkey:o.lpVault}),B({pubkey:o.lpMint,isWritable:!1}),B({pubkey:o.lockVault}),B({pubkey:o.lockMint,isWritable:!1}),B({pubkey:(n=o.lockUserAccount)!=null?n:ze}),B({pubkey:o.owner,isWritable:!1,isSigner:!0})];for(let i of o.rewardInfo)t.push(B({pubkey:i.rewardMint,isWritable:!1}),B({pubkey:i.rewardVault}),B({pubkey:i.userRewardToken}));return{instruction:new xt({programId:o.programId,keys:t,data:e}),instructionType:W.FarmV6Create}}function Ja(o){let e=Buffer.alloc(Gr.span);Gr.encode({instruction:5},e);let t=[B({pubkey:Zt,isWritable:!1}),B({pubkey:o.id}),B({pubkey:o.authority,isWritable:!1}),B({pubkey:o.lpVault,isWritable:!1}),B({pubkey:o.rewardVault}),B({pubkey:o.userRewardToken}),B({pubkey:o.owner,isWritable:!1,isSigner:!0})];return{instruction:new xt({programId:o.programId,keys:t,data:e}),instructionType:W.FarmV6CreatorWithdraw}}function $r({payer:o,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:i}){let r=Buffer.alloc(zr.span);zr.encode({instruction:3,rewardReopenTime:$(i.openTime),rewardEndTime:$(i.endTime),rewardPerSecond:$(i.perSecond)},r);let s=[B({pubkey:Zt,isWritable:!1}),B({pubkey:n.id}),B({pubkey:n.lpVault,isWritable:!1}),B({pubkey:e}),B({pubkey:t}),B({pubkey:o,isWritable:!1,isSigner:!0})];return new xt({programId:n.programId,keys:s,data:r})}function Jr({payer:o,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:i}){let r=Buffer.alloc(Qr.span);Qr.encode({instruction:4,isSet:new Za(1),rewardPerSecond:$(i.perSecond),rewardOpenTime:$(i.openTime),rewardEndTime:$(i.endTime),rewardType:$(fn[i.rewardType])},r);let s=[...wr,B({pubkey:t.id}),B({pubkey:t.authority,isWritable:!1}),B({pubkey:i.mint,isWritable:!1}),B({pubkey:n}),B({pubkey:e}),B({pubkey:o,isWritable:!1,isSigner:!0})];return new xt({programId:t.programId,keys:s,data:r})}function wi(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s}=o,[a,c]=[new le(e.programId),new le(e.id)],u=Bt({programId:a,poolId:c,owner:r,version:6}),l=Buffer.alloc(gt.span);gt.encode({instruction:2,amount:$(s)},l);let m=[B({pubkey:Zt,isWritable:!1}),B({pubkey:c}),B({pubkey:new le(t.authority),isWritable:!1}),B({pubkey:new le(t.lpVault)}),B({pubkey:u}),B({pubkey:r,isWritable:!1,isSigner:!0}),B({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(B({pubkey:new le(t.rewardInfos[d].vault)})),m.push(B({pubkey:i[d]}));return new xt({programId:a,keys:m,data:l})}function Ai(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new le(e.programId),new le(e.id)],l=Bt({programId:c,poolId:u,owner:r,version:5}),m=Buffer.alloc(gt.span);gt.encode({instruction:12,amount:$(s)},m);let d=[B({pubkey:u}),B({pubkey:new le(t.authority),isWritable:!1}),B({pubkey:l}),B({pubkey:r,isWritable:!1,isSigner:!0}),B({pubkey:n}),B({pubkey:new le(t.lpVault)}),B({pubkey:i[0]}),B({pubkey:new le(t.rewardInfos[0].vault)}),B({pubkey:bi,isWritable:!1}),B({pubkey:Zt,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(B({pubkey:i[p]})),d.push(B({pubkey:new le(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(B({pubkey:p}));return new xt({programId:c,keys:d,data:m})}function eu(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new le(e.programId),new le(e.id)],l=q([X("instruction"),P("amount")]),m=[B({pubkey:u}),B({pubkey:new le(t.authority),isWritable:!1}),B({pubkey:a[0]}),B({pubkey:r,isSigner:!0,isWritable:!1}),B({pubkey:n}),B({pubkey:new le(t.lpVault)}),B({pubkey:i[0]}),B({pubkey:new le(t.rewardInfos[0].vault)}),B({pubkey:bi,isWritable:!1}),B({pubkey:Zt,isWritable:!1}),B({pubkey:i[1]}),B({pubkey:new le(t.rewardInfos[1].vault)})],d=Buffer.alloc(l.span);return l.encode({instruction:2,amount:s},d),new xt({keys:m,programId:c,data:d})}function Pi(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new le(e.programId),new le(e.id)],l=Bt({programId:c,poolId:u,owner:r,version:3}),m=Buffer.alloc(gt.span);gt.encode({instruction:11,amount:$(s)},m);let d=[B({pubkey:u}),B({pubkey:new le(t.authority),isWritable:!1}),B({pubkey:l}),B({pubkey:r,isWritable:!1,isSigner:!0}),B({pubkey:n}),B({pubkey:new le(t.lpVault)}),B({pubkey:i[0]}),B({pubkey:new le(t.rewardInfos[0].vault)}),B({pubkey:bi,isWritable:!1}),B({pubkey:Zt,isWritable:!1})];if(a)for(let p of a)d.push(B({pubkey:p}));return new xt({programId:c,keys:d,data:m})}function tu(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new le(e.programId),new le(e.id)],l=Bt({programId:c,poolId:u,owner:r,version:3}),m=Buffer.alloc(gt.span);gt.encode({instruction:10,amount:$(s)},m);let d=[B({pubkey:u}),B({pubkey:new le(t.authority),isWritable:!1}),B({pubkey:l}),B({pubkey:r,isWritable:!1,isSigner:!0}),B({pubkey:n}),B({pubkey:new le(t.lpVault)}),B({pubkey:i[0]}),B({pubkey:new le(t.rewardInfos[0].vault)}),B({pubkey:bi,isWritable:!1}),B({pubkey:Zt,isWritable:!1})];if(a)for(let p of a)d.push(B({pubkey:p}));return new xt({programId:c,keys:d,data:m})}function nu(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new le(e.programId),new le(e.id)],l=Bt({programId:c,poolId:u,owner:r,version:5}),m=Buffer.alloc(gt.span);gt.encode({instruction:11,amount:$(s)},m);let d=[B({pubkey:u}),B({pubkey:new le(t.authority),isWritable:!1}),B({pubkey:l}),B({pubkey:r,isWritable:!1,isSigner:!0}),B({pubkey:n}),B({pubkey:new le(t.lpVault)}),B({pubkey:i[0]}),B({pubkey:new le(t.rewardInfos[0].vault)}),B({pubkey:bi,isWritable:!1}),B({pubkey:Zt,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(B({pubkey:i[p]})),d.push(B({pubkey:new le(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(B({pubkey:p}));return new xt({programId:c,keys:d,data:m})}function iu(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s}=o,[a,c]=[new le(e.programId),new le(e.id)],u=Bt({programId:a,poolId:c,owner:r,version:6}),l=Buffer.alloc(gt.span);gt.encode({instruction:1,amount:$(s)},l);let m=[B({pubkey:Zt,isWritable:!1}),B({pubkey:ja.programId,isWritable:!1}),B({pubkey:c}),B({pubkey:new le(t.authority),isWritable:!1}),B({pubkey:new le(t.lpVault)}),B({pubkey:u}),B({pubkey:r,isWritable:!1,isSigner:!0}),B({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(B({pubkey:new le(t.rewardInfos[d].vault)})),m.push(B({pubkey:i[d]}));return new xt({programId:a,keys:m,data:l})}var ki=class extends Le{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(ze)){let n=await jt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:Zr(U(M({},t),{openTime:t.openTime.toString(),endTime:t.endTime.toString()}))});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:i=ri,txVersion:r,feePayer:s}){this.checkDisabled(),this.scope.checkOwner();let c={lpMint:new ke(e.lpMint.address),lockInfo:{lockMint:Xa,lockVault:za},version:6,rewardInfos:t,programId:i},u=this.createTxBuilder(s),l=n!=null?n:this.scope.ownerPubKey,m=Ve({fromPublicKey:l,programId:c.programId}),d=await this.scope.connection.getMinimumBalanceForRentExemption(Ro.span);u.addInstruction({instructions:[Um.createAccountWithSeed({fromPubkey:l,basePubkey:l,seed:m.seed,newAccountPubkey:m.publicKey,lamports:d,space:Ro.span,programId:c.programId})]});let{publicKey:p,nonce:f}=Ya({programId:new ke(c.programId),poolId:m.publicKey}),y=fi({programId:c.programId,poolId:m.publicKey,mint:c.lpMint,type:"lpVault"}),b=[],g=[];for(let k of c.rewardInfos){k.openTime>=k.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",k.openTime.toString()),isNaN(fn[k.rewardType])&&this.logAndCreateError("rewardType error",k.rewardType),Number(k.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",k.perSecond),b.push(Ha(k));let{rewardPubKey:x,newInstruction:S}=await this._getUserRewardInfo({rewardInfo:k,payer:l});S&&u.addInstruction(S),x||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let K=k.mint.equals(ze)?new ke(it.address):k.mint;g.push({rewardMint:K,rewardVault:fi({programId:c.programId,poolId:m.publicKey,mint:K,type:"rewardVault"}),userRewardToken:x})}let{account:w,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({mint:new ke(c.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});A&&u.addInstruction(A),w||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:h,instructionType:I}=$a({farmId:m.publicKey,owner:this.scope.ownerPubKey,farmAuthority:p,lpVault:y,lpMint:c.lpMint,lockVault:c.lockInfo.lockVault,lockMint:c.lockInfo.lockMint,lockUserAccount:w,programId:c.programId,rewardInfo:g,rewardInfoConfig:b,nonce:f});return u.addInstruction({instructions:[h],instructionTypes:[I]}).versionBuild({txVersion:r,extInfo:{farmId:m.publicKey,farmAuthority:p,lpVault:y,lockUserAccount:w,nonce:f}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:i,feePayer:r}){var g;let s=It[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Ze((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,l=n.mint.equals(ze)?new ke(it.address):n.mint,m=c.rewardInfos.findIndex(w=>new ke(w.mint.address).equals(l)),d=a.rewardInfos[m];d||this.logAndCreateError("configuration does not exist","rewardMint",l);let p=(g=d.vault)!=null?g:ze,f=this.createTxBuilder(r),{rewardPubKey:y,newInstruction:b}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return b&&f.addInstruction(b),y||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),f.addInstruction({instructions:[$r({payer:this.scope.ownerPubKey,rewardVault:p,userRewardTokenPub:y,farmKeys:c,rewardInfo:n})],instructionTypes:[W.FarmV6Restart]}).versionBuild({txVersion:i})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:i,feePayer:r}){var m;let s=It[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Ze((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.forEach(d=>{d.openTime>=d.endTime&&this.logAndCreateError("start time error","newRewardInfo",d)});let u=t||this.scope.ownerPubKey,l=this.createTxBuilder(r);for(let d of n){let p=d.mint.equals(ze)?new ke(it.address):d.mint,f=c.rewardInfos.findIndex(h=>new ke(h.mint.address).equals(p)),y=a.rewardInfos[f];y||this.logAndCreateError("configuration does not exist","rewardMint",p);let b=(m=y.vault)!=null?m:ze,{rewardPubKey:g,newInstruction:w}=await this._getUserRewardInfo({rewardInfo:d,payer:u});w&&l.addInstruction(w),g||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let A=$r({payer:this.scope.ownerPubKey,rewardVault:b,userRewardTokenPub:g,farmKeys:c,rewardInfo:d});l.addInstruction({instructions:[A],instructionTypes:[W.FarmV6Restart]})}return l.versionBuild({txVersion:i})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:i,payer:r,feePayer:s}=e,a=It[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Ze((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=r!=null?r:this.scope.ownerPubKey,l=this.createTxBuilder(s),m=i.mint.equals(ze)?new ke(it.address):i.mint,d=fi({programId:new ke(n.programId),poolId:new ke(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:p,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:i,payer:u});return f&&l.addInstruction(f),p||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),i.mint=m,l.addInstruction({instructions:[Jr({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:c,rewardVault:d,rewardInfo:i})],instructionTypes:[W.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:i,payer:r,feePayer:s}=e,a=It[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Ze((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=r!=null?r:this.scope.ownerPubKey,l=this.createTxBuilder(s);for(let m of i){let d=m.mint.equals(ze)?new ke(it.address):m.mint,p=fi({programId:new ke(n.programId),poolId:new ke(n.id),mint:d,type:"rewardVault"}),{rewardPubKey:f,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:m,payer:u});y&&l.addInstruction(y),f||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let b=Jr({payer:this.scope.ownerPubKey,userRewardTokenPub:f,farmKeys:c,rewardVault:p,rewardInfo:U(M({},m),{mint:d})});l.addInstruction({instructions:[b],instructionTypes:[W.FarmV6CreatorAddReward]})}return l.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:i,feePayer:r,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:u,computeBudgetConfig:l,txTipConfig:m}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:d,programId:p}=n,f=It[p];f===4&&this.logAndCreateError("V4 has suspended deposits:",n.programId),Hr(f)||this.logAndCreateError("invalid farm program:",n.programId);let[y,b]=[new ke(n.programId),new ke(n.id)],g=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],w=Bt({programId:y,poolId:b,owner:this.scope.ownerPubKey,version:f}),A=this.createTxBuilder(r);A.addCustomComputeBudget(l),A.addTipInstruction(m);let h={};for(let v of this.scope.account.tokenAccounts)if(a){let F=oe(this.scope.ownerPubKey,v.mint,v.programId).publicKey;v.publicKey&&F.equals(v.publicKey)&&(h[v.mint.toString()]=v.publicKey)}else h[v.mint.toString()]=v.publicKey;let I=g.lpMint,k=h[I.address];k||this.logAndCreateError("you don't have any lp","lp zero",h);let x=[];for(let v of d){let F=s&&v.mint.address===j.toString(),_=h[v.mint.address];if(!_){let{account:Z,instructionParams:ce}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:v.mint.programId,mint:new ke(v.mint.address),notUseTokenAccount:F,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!F,associatedOnly:F?!1:a,checkCreateATAOwner:c});_=Z,ce&&A.addInstruction(ce)}h[v.mint.address]=_,x.push(_)}let S,K=await this.scope.connection.getAccountInfo(w);if(K&&(S=yi(f).decode(K.data)),n.programId!==ri.toString()&&!S){let{instruction:v,instructionType:F}=gi({id:b,programId:y,version:f,ledger:w,owner:this.scope.ownerPubKey});A.addInstruction({instructions:[v],instructionTypes:[F]})}let T=jr({version:f,rewardInfos:d,rewardTokenAccountsPublicKeys:x});T&&this.logAndCreateError(T);let C={amount:$(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:g,lpAccount:k,rewardAccounts:x,userAuxiliaryLedgers:u==null?void 0:u.map(v=>new ke(v))},R=f===6?iu(C):f===5?nu(C):tu(C),L={3:W.FarmV3Deposit,5:W.FarmV5Deposit,6:W.FarmV6Deposit};return A.addInstruction({instructions:[R],instructionTypes:[L[f]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:i,deposited:r,useSOLBalance:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:l,computeBudgetConfig:m,txTipConfig:d}=e,{rewardInfos:p}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let f=It[n.programId];Hr(f)||this.logAndCreateError("invalid farm program:",n.programId);let y=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],b=this.createTxBuilder(a);b.addCustomComputeBudget(m),b.addTipInstruction(d);let g={};for(let T of this.scope.account.tokenAccounts)if(c){let C=oe(this.scope.ownerPubKey,T.mint).publicKey;T.publicKey&&C.equals(T.publicKey)&&(g[T.mint.toString()]=T.publicKey)}else g[T.mint.toString()]=T.publicKey;if(f!==4){let T=Bt({programId:new ke(n.programId),poolId:new ke(n.id),owner:this.scope.ownerPubKey,version:f}),C=await this.scope.connection.getAccountInfo(T);if(C)yi(f).decode(C.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(f!==6){let{instruction:R,instructionType:L}=gi({id:new ke(y.id),programId:new ke(y.programId),version:f,ledger:T,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[R],instructionTypes:[L]})}}r&&r.isZero()&&!(l||[]).length&&this.logAndCreateError("no deposited lp",{farmId:n.id});let w=y.lpMint.address,A=s&&w===j.toString(),h=g[w.toString()];if(!h){let{account:T,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.lpMint.programId,mint:new ke(w),notUseTokenAccount:A,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:A?!1:c,checkCreateATAOwner:u});h=T,C&&b.addInstruction(C)}g[w.toString()]=h;let I=[];for(let T of p){let C=s&&T.mint.address===j.toString(),R=g[T.mint.address];if(!R){let{account:L,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:T.mint.programId,mint:new ke(T.mint.address),notUseTokenAccount:C,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!C,associatedOnly:C?!1:c,checkCreateATAOwner:u});R=L,v&&b.addInstruction(v)}g[T.mint.address]=R,I.push(R)}let k=jr({version:f,rewardInfos:p,rewardTokenAccountsPublicKeys:I});k&&this.logAndCreateError(k);let x={amount:$(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:y,lpAccount:h,rewardAccounts:I,userAuxiliaryLedgers:l==null?void 0:l.map(T=>new ke(T))},S=f===6?wi(x):f===5?Ai(x):f===4?eu(x):Pi(x),K={3:W.FarmV3Withdraw,4:W.FarmV4Withdraw,5:W.FarmV5Withdraw,6:W.FarmV6Withdraw};return b.addInstruction({instructions:[S],instructionTypes:[K[f]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n,computeBudgetConfig:i,txTipConfig:r,feePayer:s}){var y;this.scope.checkOwner();let a=Ze((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c=It[e.programId];c!==6&&this.logAndCreateError("invalid farm version",c);let u=a.rewardInfos.find(b=>tt(b.mint.address).equals(tt(t)));u||this.logAndCreateError("withdraw mint error","rewardInfos",e);let l=(y=u==null?void 0:u.vault)!=null?y:ze,m=this.createTxBuilder(s),d;if(t.equals(ze)||t.equals(ke.default)){let b=await jt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:Zr(U(M({},u),{openTime:u.openTime,endTime:u.endTime,perSecond:new N(u.perSecond).mul(10**u.mint.decimals).toString()}))});d=b.addresses.newAccount,m.addInstruction(b)}else{let b=await this.scope.account.getCreatedTokenAccount({mint:t});b===null?(d=await this.scope.account.getAssociatedTokenAccount(t),m.addInstruction({instructions:[Gm(this.scope.ownerPubKey,d,this.scope.ownerPubKey,t)],instructionTypes:[W.CreateATA]})):d=b}let{instruction:p,instructionType:f}=Ja({programId:a.programId,id:a.id,authority:a.authority,lpVault:a.lpVault,rewardVault:l,userRewardToken:d,owner:this.scope.ownerPubKey});return m.addCustomComputeBudget(i),m.addTipInstruction(r),m.addInstruction({instructions:[p],instructionTypes:[f]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:c,computeBudgetConfig:u}=e,l=this.createTxBuilder(i),m={};for(let f of this.scope.account.tokenAccounts)if(r){let y=oe(this.scope.ownerPubKey,f.mint).publicKey;f.publicKey&&y.equals(f.publicKey)&&(m[f.mint.toString()]=f.publicKey)}else m[f.mint.toString()]=f.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(f=>f.id).join(",")})).reduce((f,y)=>U(M({},f),{[y.id]:y}),{});for(let f of Object.values(t)){let{programId:y,lpMint:b,rewardInfos:g,id:w}=f,A=It[y],h=b.address,I=n&&h===j.toString(),k=m[h];if(!k){let{account:R,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.programId,mint:new ke(h),notUseTokenAccount:I,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:I?!1:r,checkCreateATAOwner:s});k=R,L&&l.addInstruction(L)}m[h.toString()]=k;let x=[];for(let R of g){let L=n&&R.mint.address===j.toString(),v=m[R.mint.address];if(!v){let{account:F,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:R.mint.programId,mint:new ke(R.mint.address),notUseTokenAccount:L,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!L,associatedOnly:L?!1:r,checkCreateATAOwner:s});v=F,_&&l.addInstruction(_)}m[R.mint.address]=v,x.push(v)}let S=p[w],K={amount:yt,owner:this.scope.ownerPubKey,farmInfo:f,farmKeys:S,lpAccount:k,rewardAccounts:x,userAuxiliaryLedgers:a==null?void 0:a.map(R=>new ke(R))},T=A===6?wi(K):A===5?Ai(K):Pi(K),C={3:W.FarmV3Withdraw,5:W.FarmV5Withdraw,6:W.FarmV6Withdraw};l.addInstruction({instructions:[T],instructionTypes:[C[A]]})}return c===1?l.sizeCheckBuild({computeBudgetConfig:u}):l.sizeCheckBuildV0({computeBudgetConfig:u})}};import{PublicKey as qe}from"@solana/web3.js";import{AccountLayout as Od,NATIVE_MINT as Go,TOKEN_PROGRAM_ID as bn}from"@solana/spl-token";import{Keypair as _o,PublicKey as G,SystemProgram as en,TransactionInstruction as $e}from"@solana/web3.js";import cs from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ri,TOKEN_2022_PROGRAM_ID as Me,TOKEN_PROGRAM_ID as he}from"@solana/spl-token";import td from"bn.js";import St from"bn.js";var Re=new St(0),wt=new St(1),$t=new St(-1),At=new St(1).shln(64),Lo=new St(1).shln(128),es=At.sub(wt),hi=64,ou=Lo.subn(1),rt=-443636,lt=-rt,Kt=new St("4295048016"),Ct=new St("79226673521066979257578248091"),Oo=new St("4295048017"),Mo=new St("79226673521066979257578248090"),ru=16,su="59543866431248",au="184467440737095516",uu="15793534762490258745",No=new St(10).pow(new St(6));var cu={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},kP=new St("18446744073700000000");import ue from"bn.js";function vo(o){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,o,!1),new Uint8Array(e)}function ts(o,e){let t=0;for(let n=o-1;n>=0&&!e.testn(n);n--)t++;return t}function ns(o,e){let t=0;for(let n=0;n<o&&!e.testn(n);n++)t++;return t}function Ti(o,e){for(let t=0;t<o;t++)if(e.testn(t))return!1;return!0}function lu(o,e){return Ti(o,e)?null:ts(o,e)}function mu(o,e){return Ti(o,e)?null:ns(o,e)}var SP=Buffer.from("amm_config","utf8"),Xm=Buffer.from("pool","utf8"),zm=Buffer.from("pool_vault","utf8"),Qm=Buffer.from("pool_reward_vault","utf8"),du=Buffer.from("position","utf8"),Ym=Buffer.from("tick_array","utf8"),Hm=Buffer.from("operation","utf8"),jm=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Zm=Buffer.from("observation","utf8");function pu(o,e,t,n){return de([Xm,e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}function is(o,e,t){return de([zm,e.toBuffer(),t.toBuffer()],o)}function fu(o,e,t){return de([Qm,e.toBuffer(),t.toBuffer()],o)}function pe(o,e,t){return de([Ym,e.toBuffer(),vo(t)],o)}function Et(o,e,t,n){return de([du,e.toBuffer(),vo(t),vo(n)],o)}function mt(o,e){return de([du,e.toBuffer()],o)}function Tn(o){return de([Buffer.from("metadata","utf8"),zt.toBuffer(),o.toBuffer()],zt)}function Ii(o){return de([Hm],o)}function Ee(o,e){return de([jm,e.toBuffer()],o)}function yu(o,e){return de([Zm,e.toBuffer()],o)}var bu=Buffer.from("locked_position","utf8");function os(o,e){return de([bu,e.toBuffer()],o)}function Bi(o,e){return de([bu,e.toBuffer()],o)}var $m=Buffer.from("support_mint","utf8");function rs(o,e){return de([$m,e.toBuffer()],o)}import{PublicKey as Pt}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as gu}from"@solana/spl-token";import Se from"bn.js";import Ut from"bn.js";var xi=class{static getfeeGrowthInside(e,t,n){let i=new Ut(0),r=new Ut(0);e.tickCurrent>=t.tick?(i=t.feeGrowthOutsideX64A,r=t.feeGrowthOutsideX64B):(i=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),r=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new Ut(0),a=new Ut(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let c=re.wrappingSubU128(re.wrappingSubU128(e.feeGrowthGlobalX64A,i),s),u=re.wrappingSubU128(re.wrappingSubU128(e.feeGrowthGlobalX64B,r),a);return{feeGrowthInsideX64A:c,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,i){let{feeGrowthInsideX64A:r,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=re.mulDivFloor(re.wrappingSubU128(r,t.feeGrowthInsideLastX64A),t.liquidity,At),c=t.tokenFeesOwedA.add(a),u=re.mulDivFloor(re.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,At),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,i){let{feeGrowthInsideX64A:r,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=re.mulDivFloor(re.wrappingSubU128(r,t.feeGrowthInsideLastX64A),t.liquidity,At),c=t.tokenFeesOwedA.add(a),u=re.mulDivFloor(re.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,At),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,i){let r=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=re.wrappingSubU128(c,u.growthInsideLastX64),m=re.mulDivFloor(l,t.liquidity,At),d=u.rewardAmountOwed.add(m);r.push(d)}return r}static GetPositionRewards(e,t,n,i){let r=[],s=this.getRewardGrowthInside(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=re.wrappingSubU128(c,u.growthInsideLastX64),m=re.mulDivFloor(l,t.liquidity,At),d=u.rewardAmountOwed.add(m);r.push(d)}return r}static getRewardGrowthInside(e,t,n,i){let r=[];for(let s=0;s<i.length;s++){let a=new Ut(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new Ut(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),r.push(re.wrappingSubU128(re.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),c))}return r}static getRewardGrowthInsideV2(e,t,n,i){let r=[];for(let s=0;s<i.length;s++){let a=new Ut(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new Ut(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),r.push(re.wrappingSubU128(re.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),c))}return r}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:i,add:r,epochInfo:s}){var b,g,w,A;let a=ie.priceToSqrtPriceX64(new N(e.price),e.mintA.decimals,e.mintB.decimals),c=ie.getSqrtPriceX64FromTick(t.tickLower),u=ie.getSqrtPriceX64FromTick(t.tickUpper),l=r?1+i:1-i,m=ye.getAmountsFromLiquidity(a,c,u,n,r),[d,p]=[Pe(m.amountA,(b=e.mintA.extensions)==null?void 0:b.feeConfig,s,!0),Pe(m.amountB,(g=e.mintB.extensions)==null?void 0:g.feeConfig,s,!0)],[f,y]=[Pe(new Ut(new N(m.amountA.toString()).mul(l).toFixed(0)),(w=e.mintA.extensions)==null?void 0:w.feeConfig,s,!0),Pe(new Ut(new N(m.amountB.toString()).mul(l).toFixed(0)),(A=e.mintB.extensions)==null?void 0:A.feeConfig,s,!0)];return{liquidity:n,amountA:d,amountB:p,amountSlippageA:f,amountSlippageB:y,expirationTime:_t(d.expirationTime,p.expirationTime)}}};var Jm=15,fe=class{static async getTickArrays(e,t,n,i,r,s,a){let c=[],u=Y.getTickArrayStartIndexByTick(i,r),l=Y.getInitializedTickArrayInRange(s,a,r,u,Math.floor(Jm/2));for(let p=0;p<l.length;p++){let{publicKey:f}=pe(t,n,l[p]);c.push(f)}let m=(await Lt(e,c)).map(p=>p!==null?Si.decode(p.data):null),d={};for(let p=0;p<c.length;p++){let f=m[p];f!==null&&(d[f.startTickIndex]=U(M({},f),{address:c[p]}))}return d}static nextInitializedTick(e,t,n,i,r,s){let{initializedTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,i,r,s);for(;a==null||a.liquidityGross.lten(0);){if(u=Y.getNextTickArrayStartIndex(u,r,s),this.checkIsValidStartIndex(u,r))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,c,u]=[m,d,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,i,r){let s=Math.floor(e/fe.tickCount(t)),a=n?Y.searchLowBitFromStart(i,r,s-1,1,t):Y.searchHightBitFromStart(i,r,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,i){let r;if(i){let a=Xe-1;for(;a>=0;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){r=c;break}a=a-1}}else{let a=0;for(;a<Xe;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){r=c;break}a=a+1}}let{publicKey:s}=pe(e,t,n.startTickIndex);return{nextTick:r,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,i,r,s){let a=Y.getTickArrayStartIndexByTick(i,r),c=Math.floor((i-a)/r),u=n[a];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;c>=0;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c-1}else for(c=c+1;c<Xe;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c+1}let{publicKey:m}=pe(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(Y.checkIsOutOfBoundary(e)){if(e>lt)return!1;let n=Y.getTickArrayStartIndexByTick(rt,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return Xe*e}};var ss=14,Jt=class{static maxTickInTickarrayBitmap(e){return e*Xe*In}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(i+=1);let r=n*i;return e<0?{minValue:-r,maxValue:-r+n}:{minValue:r,maxValue:r+n}}static nextInitializedTickArrayStartIndex(e,t,n,i){if(!fe.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let r=this.maxTickInTickarrayBitmap(n),s=i?t-fe.tickCount(n):t+fe.tickCount(n);if(s<-r||s>=r)return{isInit:!1,tickIndex:t};let a=n*Xe,c=s/a+512;s<0&&s%a!=0&&c--;let u=Math.abs(c);if(i){let l=e.shln(1024-u-1),m=lu(1024,l);if(m!==null){let d=(u-m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-r}}else{let l=e.shrn(u),m=mu(1024,l);if(m!==null){let d=(u+m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:r-fe.tickCount(n)}}}},Ki=class{static getBitmapOffset(e,t){if(!fe.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=Jt.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&i--,i}static getBitmap(e,t,n){let i=this.getBitmapOffset(e,t);return e<0?{offset:i,tickarrayBitmap:n.negativeTickArrayBitmap[i]}:{offset:i,tickarrayBitmap:n.positiveTickArrayBitmap[i]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:i}=this.extensionTickBoundary(t);if(e>=i&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=Jt.maxTickInTickarrayBitmap(e),n=-t;if(lt<=t)throw Error(`extensionTickBoundary check error: ${lt}, ${t}`);if(n<=rt)throw Error(`extensionTickBoundary check error: ${n}, ${rt}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:i}=this.getBitmap(e,t,n),r=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:Y.mergeTickArrayBitmap(i).testn(r),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,i){let r=fe.tickCount(t),s=n?e-r:e+r,{tickarrayBitmap:a}=this.getBitmap(s,t,i);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,i){let{minValue:r,maxValue:s}=Jt.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(i){let c=Y.mergeTickArrayBitmap(e).shln(In-1-a),u=Ti(512,c)?null:ts(512,c);if(u!==null){let l=t-u*fe.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:r}}else{let c=Y.mergeTickArrayBitmap(e).shrn(a),u=Ti(512,c)?null:ns(512,c);if(u!==null){let l=t+u*fe.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-fe.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%Jt.maxTickInTickarrayBitmap(t),i=Math.floor(n/fe.tickCount(t));return e<0&&n!=0&&(i=In-i),i}};var Be=class{static getOutputAmountAndRemainAccounts(e,t,n,i,r,s=!1){let a=n.toBase58()===e.mintA.address,c=[],{isExist:u,startIndex:l,nextAccountMeta:m}=this.getFirstInitializedTickArray(e,a);if(!u||l===void 0||!m)throw new Error("Invalid tick array");c.push(m);let{allTrade:d,amountCalculated:p,accounts:f,sqrtPriceX64:y,feeAmount:b}=Bn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i,l,r,s);return c.push(...f),{allTrade:d,expectedAmountOut:p.mul($t),remainingAccounts:c,executionPrice:y,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,i,r){let s=n.toBase58()===e.mintB.address,a=[],{isExist:c,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!c||u===void 0||!l)throw new Error("Invalid tick array");try{let y=this.preInitializedTickArrayStartIndex(e,s);if(y.isExist){let{publicKey:b}=pe(e.programId,e.id,y.nextStartIndex);a.push(b)}}catch{}a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:p,feeAmount:f}=Bn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i.mul($t),u,r);return a.push(...d),{expectedAmountIn:m,remainingAccounts:a,executionPrice:p,feeAmount:f}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:i}=Be.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?Ki.checkTickArrayIsInit(fe.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):Y.checkTickArrayIsInitialized(Y.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=pe(e.programId,e.id,i);return{isExist:!0,startIndex:i,nextAccountMeta:a}}let{isExist:r,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,fe.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(r){let{publicKey:a}=pe(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/fe.tickCount(e.tickSpacing)),i=t?Y.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):Y.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=fe.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:i,tickIndex:r}=Jt.nextInitializedTickArrayStartIndex(Y.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(i)return{isExist:!0,nextStartIndex:r};t=r;let{isInit:s,tickIndex:a}=Ki.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<rt||t>lt)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:i,rewardInfos:r}){var a,c,u;let s=[];for(let l=0;l<r.length;l++){let m=r[l],d=(u=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?u:(c=await e.getAccountInfo(m.tokenMint))==null?void 0:c.owner;if(d===void 0)throw Error("get new reward mint info error");let p=U(M({},m),{perSecond:re.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Pt(d)});if(p.tokenMint.equals(Pt.default))continue;if(n<=p.openTime.toNumber()||i.eq(Re)){s.push(p);continue}let f=new Se(Math.min(p.endTime.toNumber(),n)),y=f.sub(p.lastUpdateTime),b=re.mulDivFloor(y,p.emissionsPerSecondX64,i),g=p.rewardGrowthGlobalX64.add(b),w=re.mulDivFloor(y,p.emissionsPerSecondX64,At),A=p.rewardTotalEmissioned.add(w);s.push(U(M({},p),{rewardGrowthGlobalX64:g,rewardTotalEmissioned:A,lastUpdateTime:f}))}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:i}=this.tickRange(e);for(let r of t){let s=Y.getTickArrayStartIndexByTick(r,e);if(s>=n||s<i)return!0}return!1}static tickRange(e){let t=Jt.maxTickInTickarrayBitmap(e),n=-t;return t>lt&&(t=fe.getArrayStartIndex(lt,e)+fe.tickCount(e)),n<rt&&(n=fe.getArrayStartIndex(rt,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!fe.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/fe.tickCount(t)*In}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let i=await Ue(e,t.map(s=>({pubkey:s})),{batchRequest:n}),r={};for(let s of i)s.accountInfo!==null&&(r[s.pubkey.toString()]=Au.decode(s.accountInfo.data));return r}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let i={},r=[];for(let c of t){let u=Y.getTickArrayStartIndexByTick(c.tickCurrent,c.tickSpacing),l=Y.getInitializedTickArrayInRange(c.tickArrayBitmap,c.exBitmapInfo,c.tickSpacing,u,7);for(let m of l){let{publicKey:d}=pe(c.programId,c.id,m);r.push({pubkey:d}),i[d.toString()]=c.id}}let s=await Ue(e,r,{batchRequest:n}),a={};for(let c of s){if(!c.accountInfo)continue;let u=i[c.pubkey.toString()];if(!u)continue;a[u.toString()]===void 0&&(a[u.toString()]={});let l=Si.decode(c.accountInfo.data);a[u.toString()][l.startTickIndex]=U(M({},l),{address:c.pubkey})}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:i=!1,updateOwnerRewardAndFee:r=!0}){var a;let s=[];for(let c=0;c<e.length;c++){let u=e[c];u!==null&&(s.find(l=>l.equals(u.state.programId))||s.push(u.state.programId))}if(n){let c=n.tokenAccounts.map(d=>d.accountInfo.mint),u=[];for(let d of c)for(let p of s)u.push(mt(p,d).publicKey);let l=await Lt(t,u,{batchRequest:i}),m={};for(let d of l){if(d===null)continue;let p=Ci.decode(d.data),f=p.poolId.toString(),y=e.find(S=>S.state.id.toBase58()===f);if(y===void 0)continue;let b=y.state,g=Y._getTickPriceLegacy({poolInfo:b,tick:p.tickLower,baseIn:!0}),w=Y._getTickPriceLegacy({poolInfo:b,tick:p.tickUpper,baseIn:!0}),{amountA:A,amountB:h}=ye.getAmountsFromLiquidity(b.sqrtPriceX64,g.tickSqrtPriceX64,w.tickSqrtPriceX64,p.liquidity,!1),I=1/(1-Math.sqrt(Math.sqrt(g.price.div(w.price).toNumber())));y.positionAccount=[...(a=y.positionAccount)!=null?a:[],{poolId:p.poolId,nftMint:p.nftMint,priceLower:g.price,priceUpper:w.price,amountA:A,amountB:h,tickLower:p.tickLower,tickUpper:p.tickUpper,liquidity:p.liquidity,feeGrowthInsideLastX64A:p.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:p.feeGrowthInsideLastX64B,tokenFeesOwedA:p.tokenFeesOwedA,tokenFeesOwedB:p.tokenFeesOwedB,rewardInfos:p.rewardInfos.map(S=>U(M({},S),{pendingReward:new Se(0)})),leverage:I,tokenFeeAmountA:new Se(0),tokenFeeAmountB:new Se(0)}];let k=await Y.getTickArrayAddressByTick(y.state.programId,p.poolId,p.tickLower,y.state.tickSpacing),x=await Y.getTickArrayAddressByTick(y.state.programId,p.poolId,p.tickUpper,y.state.tickSpacing);m[`${y.state.programId.toString()}-${p.poolId.toString()}-${p.tickLower}`]=k,m[`${y.state.programId.toString()}-${p.poolId.toString()}-${p.tickUpper}`]=x}if(r){let d=Object.values(m),p=await Lt(t,d,{batchRequest:i}),f={};for(let y=0;y<d.length;y++){let b=p[y];if(b===null)continue;let g=d[y].toString();f[g]=Si.decode(b.data)}for(let{state:y,positionAccount:b}of e)if(!!b)for(let g of b){let w=`${y.programId.toString()}-${y.id.toString()}-${g.tickLower}`,A=`${y.programId.toString()}-${y.id.toString()}-${g.tickUpper}`,h=f[m[w].toString()],I=f[m[A].toString()],k=h.ticks[Y.getTickOffsetInArray(g.tickLower,y.tickSpacing)],x=I.ticks[Y.getTickOffsetInArray(g.tickUpper,y.tickSpacing)],{tokenFeeAmountA:S,tokenFeeAmountB:K}=await xi.GetPositionFees(y,g,k,x),T=await xi.GetPositionRewards(y,g,k,x);g.tokenFeeAmountA=S.gte(new Se(0))?S:new Se(0),g.tokenFeeAmountB=K.gte(new Se(0))?K:new Se(0);for(let C=0;C<T.length;C++)g.rewardInfos[C].pendingReward=T[C].gte(new Se(0))?T[C]:new Se(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountIn:r,slippage:s,priceLimit:a=new N(0),catchLiquidityInsufficient:c=!1}){var R;let u,l=n.toBase58()===e.mintA.address,[m,d]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new N(0))?u=l?Kt.add(new Se(1)):Ct.sub(new Se(1)):u=ie.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=Pe(r,m,i,!1),{allTrade:f,expectedAmountOut:y,remainingAccounts:b,executionPrice:g,feeAmount:w}=Be.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub((R=p.fee)!=null?R:Re),u,c),A=Pe(y,d,i,!1),h=ie.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),I=l?h:new N(1).div(h),k=y.mul(new Se(Math.floor((1-s)*1e10))).div(new Se(1e10)),x=Pe(k,d,i,!1),S=l?e.currentPrice:new N(1).div(e.currentPrice),K=new N(I).sub(S).abs(),T=S,C=new Qe(new N(K).mul(10**15).toFixed(0),new N(T).mul(10**15).toFixed(0));return{allTrade:f,realAmountIn:p,amountOut:A,minAmountOut:x,expirationTime:_t(p.expirationTime,A.expirationTime),currentPrice:e.currentPrice,executionPrice:I,priceImpact:C,fee:w,remainingAccounts:b,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:i,slippage:r,epochInfo:s,catchLiquidityInsufficient:a=!1}){let c=i.address===e.mintB.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA],[m,d]=[new Ce(U(M({},u),{mint:u.address,isToken2022:u.programId===gu.toBase58()})),new Ce(U(M({},l),{mint:l.address,isToken2022:l.programId===gu.toBase58()}))],{allTrade:p,realAmountIn:f,amountOut:y,minAmountOut:b,expirationTime:g,currentPrice:w,executionPrice:A,priceImpact:h,fee:I,remainingAccounts:k,executionPriceX64:x}=Be.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Pt(u.address),amountIn:n,slippage:r,epochInfo:s,catchLiquidityInsufficient:a}),S=U(M({},f),{amount:new Ae(m,f.amount),fee:f.fee===void 0?void 0:new Ae(m,f.fee)}),K=U(M({},y),{amount:new Ae(d,y.amount),fee:y.fee===void 0?void 0:new Ae(d,y.fee)}),T=U(M({},b),{amount:new Ae(d,b.amount),fee:b.fee===void 0?void 0:new Ae(d,b.fee)}),C=new ft({baseToken:m,denominator:new Se(10).pow(new Se(20+m.decimals)),quoteToken:d,numerator:w.mul(new N(10**(20+d.decimals))).toFixed(0)}),R=new ft({baseToken:m,denominator:new Se(10).pow(new Se(20+m.decimals)),quoteToken:d,numerator:A.mul(new N(10**(20+d.decimals))).toFixed(0)}),L=new Ae(m,I);return{allTrade:p,realAmountIn:S,amountOut:K,minAmountOut:T,expirationTime:g,currentPrice:C,executionPrice:R,priceImpact:h,fee:L,remainingAccounts:k,executionPriceX64:x}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountOut:r,slippage:s,priceLimit:a=new N(0)}){var T;let c=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new N(0))?l=c?Ct.sub(new Se(1)):Kt.add(new Se(1)):l=ie.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let m=Pe(r,u[n.toString()],i,!0),{expectedAmountIn:d,remainingAccounts:p,executionPrice:f,feeAmount:y}=Be.getInputAmountAndRemainAccounts(e,t,n,m.amount.sub((T=m.fee)!=null?T:Re),l),b=c?e.mintB.address:e.mintA.address,g=Pe(d,u[b],i,!1),w=ie.sqrtPriceX64ToPrice(f,e.mintA.decimals,e.mintB.decimals),A=c?w:new N(1).div(w),h=d.mul(new Se(Math.floor((1+s)*1e10))).div(new Se(1e10)),I=Pe(h,u[b],i,!0),k=c?e.currentPrice:new N(1).div(e.currentPrice),x=new N(A).sub(k).abs(),S=k,K=new Qe(new N(x).mul(10**15).toFixed(0),new N(S).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:I,realAmountOut:m,expirationTime:_t(g.expirationTime,m.expirationTime),currentPrice:e.currentPrice,executionPrice:A,priceImpact:K,fee:y,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:i}){var f,y,b;let r=e[t],s=Y.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=Y.getTickPrice({poolInfo:e,tick:i,baseIn:!0}).price.toNumber(),c=Math.max(s,r.priceMin),l=Math.min(a,r.priceMax)-c,m=a-s,d=r.priceMax-r.priceMin,p;return l<=0?p=0:m===l?p=d/l:d===l?p=l/m:p=l/d*(l/m),{feeApr:r.feeApr*p,rewardsApr:[((f=r.rewardApr[0])!=null?f:0)*p,((y=r.rewardApr[1])!=null?y:0)*p,((b=r.rewardApr[2])!=null?b:0)*p],apr:r.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:i,liquidity:r,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:c}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=i[tt(e.mintA.address).toString()],d=i[tt(e.mintB.address).toString()],p=e.mintA.decimals,f=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let y=ie.priceToSqrtPriceX64(new N(e.price),e.mintA.decimals,e.mintB.decimals),b=ie.getSqrtPriceX64FromTick(s),g=ie.getSqrtPriceX64FromTick(a),{amountSlippageA:w,amountSlippageB:A}=ye.getAmountsFromLiquidityWithSlippage(y,b,g,t,!1,!1,0),{amountSlippageA:h,amountSlippageB:I}=ye.getAmountsFromLiquidityWithSlippage(y,b,g,r,!1,!1,0),k=new N(w.toString()).div(new N(10).pow(p)).mul(m.value).add(new N(A.toString()).div(new N(10).pow(f)).mul(d.value)),x=new N(h.toString()).div(new N(10).pow(p)).mul(m.value).add(new N(I.toString()).div(new N(10).pow(f)).mul(d.value)),S=new N(1).div(k.add(x)),T=new N(l.volumeFee).mul(365).div(u).mul(S).mul(100).toNumber(),C=3600*24*365,R=e.rewardDefaultInfos.map(L=>{var _,Z;let v=L.mint.decimals,F=i[L.mint.address];return c<((_=L.startTime)!=null?_:0)||c>((Z=L.endTime)!=null?Z:0)||!L.perSecond||!F||v===void 0?0:new N(F.value).mul(new N(L.perSecond).mul(C)).div(new N(10).pow(v)).mul(S).mul(100).toNumber()});return{feeApr:T,rewardsApr:R,apr:T+R.reduce((L,v)=>L+v,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:i,amount:r,slippage:s,add:a,epochInfo:c,amountHasFee:u}){var g,w;let l=ie.priceToSqrtPriceX64(new N(e.price),e.mintA.decimals,e.mintB.decimals),m=ie.getSqrtPriceX64FromTick(n),d=ie.getSqrtPriceX64FromTick(i),p=Pe(r,(g=e[t?"mintA":"mintB"].extensions)==null?void 0:g.feeConfig,c,!u),f=new Se(new N(p.amount.sub((w=p.fee)!=null?w:Re).toString()).toFixed(0)),y;if(l.lte(m))y=t?ye.getLiquidityFromTokenAmountA(m,d,f,!a):new Se(0);else if(l.lte(d)){let A=ye.getLiquidityFromTokenAmountA(l,d,f,!a),h=ye.getLiquidityFromTokenAmountB(m,l,f);y=t?A:h}else y=t?new Se(0):ye.getLiquidityFromTokenAmountB(m,d,f);let b=await Be.getAmountsFromLiquidity({epochInfo:c,poolInfo:e,tickLower:n,tickUpper:i,liquidity:y,slippage:s,add:a});return{liquidity:y,amountA:t?p:b.amountA,amountB:t?b.amountB:p,amountSlippageA:t?p:b.amountSlippageA,amountSlippageB:t?b.amountSlippageB:p,expirationTime:b.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:i,liquidity:r,slippage:s,add:a}){var b,g,w,A;let c=ie.getSqrtPriceX64FromTick(n),u=ie.getSqrtPriceX64FromTick(i),l=a?1+s:1-s,m=ye.getAmountsFromLiquidity(ie.priceToSqrtPriceX64(new N(t.price),t.mintA.decimals,t.mintB.decimals),c,u,r,a),[d,p]=[Pe(m.amountA,(b=t.mintA.extensions)==null?void 0:b.feeConfig,e,!0),Pe(m.amountB,(g=t.mintB.extensions)==null?void 0:g.feeConfig,e,!0)],[f,y]=[Pe(m.amountA.muln(l),(w=t.mintA.extensions)==null?void 0:w.feeConfig,e,!0),Pe(m.amountB.muln(l),(A=t.mintB.extensions)==null?void 0:A.feeConfig,e,!0)];return{liquidity:r,amountA:d,amountB:p,amountSlippageA:f,amountSlippageB:y,expirationTime:_t(d.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let i=t.filter(c=>!n[c.id]).map(c=>new Pt(c.id));(await Lt(e,i)).forEach((c,u)=>{!c||(n[i[u].toBase58()]=xn.decode(c.data))});let s=t.map(c=>Ee(new Pt(c.programId),new Pt(c.id)).publicKey),a=await Be.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((c,u)=>U(M({},c),{[u.id]:U(M({},n[u.id]),{id:new Pt(u.id),version:6,programId:new Pt(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:U(M({},u.config),{id:new Pt(u.config.id),fundOwner:""}),currentPrice:new N(u.price),exBitmapAccount:Ee(new Pt(u.programId),new Pt(u.id)).publicKey,exBitmapInfo:a[Ee(new Pt(u.programId),new Pt(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber(),rewardInfos:n[u.id].rewardInfos})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};var as={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function wu(o){return U(M({},o),{type:"Concentrated",programId:o.programId.toString(),id:o.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:o.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:o.ammConfig.tradeFeeRate,openTime:o.startTime.toString(),tvl:0,day:as,week:as,month:as,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:U(M({},o.ammConfig),{id:o.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]})})}var re=class{static mulDivRoundingUp(e,t,n){let i=e.mul(t),r=i.div(n);return i.mod(n).eq(Re)||(r=r.add(wt)),r}static mulDivFloor(e,t,n){if(n.eq(Re))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(Re))throw new Error("division by 0");return e.mul(t).add(n.sub(wt)).div(n)}static x64ToDecimal(e,t){return new N(e.toString()).div(N.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new ue(e.mul(N.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(Lo).sub(t).mod(Lo)}};function He(o,e){return us(o.mul(e),64,256)}function ed(o,e,t){let n=o.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function us(o,e,t){let n=o.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var ie=class{static sqrtPriceX64ToPrice(e,t,n){return re.x64ToDecimal(e).pow(2).mul(N.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return re.decimalToX64(e.mul(N.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,i){if(!e.gt(Re))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(Re))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,i){if(!e.gt(Re))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(Re))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,i){if(n.eq(Re))return e;let r=t.shln(hi);if(i){let s=r,a=r.add(n.mul(e));return a.gte(s)?re.mulDivCeil(s,e,a):re.mulDivRoundingUp(s,wt,s.div(e).add(n))}else{let s=n.mul(e);if(!r.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=r.sub(s);return re.mulDivCeil(r,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,i){let r=n.shln(hi);if(i)return e.add(r.div(t));{let s=re.mulDivRoundingUp(r,wt,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<rt||e>lt)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new ue("18445821805675395072"):new ue("18446744073709551616");return(t&2)!=0&&(n=He(n,new ue("18444899583751176192"))),(t&4)!=0&&(n=He(n,new ue("18443055278223355904"))),(t&8)!=0&&(n=He(n,new ue("18439367220385607680"))),(t&16)!=0&&(n=He(n,new ue("18431993317065453568"))),(t&32)!=0&&(n=He(n,new ue("18417254355718170624"))),(t&64)!=0&&(n=He(n,new ue("18387811781193609216"))),(t&128)!=0&&(n=He(n,new ue("18329067761203558400"))),(t&256)!=0&&(n=He(n,new ue("18212142134806163456"))),(t&512)!=0&&(n=He(n,new ue("17980523815641700352"))),(t&1024)!=0&&(n=He(n,new ue("17526086738831433728"))),(t&2048)!=0&&(n=He(n,new ue("16651378430235570176"))),(t&4096)!=0&&(n=He(n,new ue("15030750278694412288"))),(t&8192)!=0&&(n=He(n,new ue("12247334978884435968"))),(t&16384)!=0&&(n=He(n,new ue("8131365268886854656"))),(t&32768)!=0&&(n=He(n,new ue("3584323654725218816"))),(t&65536)!=0&&(n=He(n,new ue("696457651848324352"))),(t&131072)!=0&&(n=He(n,new ue("26294789957507116"))),(t&262144)!=0&&(n=He(n,new ue("37481735321082"))),e>0&&(n=ou.div(n)),n}static getTickFromPrice(e,t,n){return ie.getTickFromSqrtPriceX64(ie.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Ct)||e.lt(Kt))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new ue(t-64),i=ed(n,32,128),r=new ue("8000000000000000","hex"),s=0,a=new ue(0),c=t>=64?e.shrn(t-63):e.shln(63-t);for(;r.gt(new ue(0))&&s<ru;){c=c.mul(c);let f=c.shrn(127);c=c.shrn(63+f.toNumber()),a=a.add(r.mul(f)),r=r.shrn(1),s+=1}let u=a.shrn(32),m=i.add(u).mul(new ue(su)),d=us(m.sub(new ue(au)),64,128).toNumber(),p=us(m.add(new ue(uu)),64,128).toNumber();return d==p?d:ie.getSqrtPriceX64FromTick(p).lte(e)?p:d}},Sn=class{static getTickWithPriceAndTickspacing(e,t,n,i){let s=ie.getTickFromSqrtPriceX64(ie.priceToSqrtPriceX64(e,n,i))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,i){let r=Sn.getTickWithPriceAndTickspacing(e,t,n,i),s=ie.getSqrtPriceX64FromTick(r);return ie.sqrtPriceX64ToPrice(s,n,i)}},ye=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(Re))throw new Error("sqrtPriceX64A must greater than 0");let r=n.ushln(hi),s=t.sub(e);return i?re.mulDivRoundingUp(re.mulDivCeil(r,s,t),wt,e):re.mulDivFloor(r,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(Re))throw new Error("sqrtPriceX64A must greater than 0");return i?re.mulDivCeil(n,t.sub(e),At):re.mulDivFloor(n,t.sub(e),At)}static getLiquidityFromTokenAmountA(e,t,n,i){e.gt(t)&&([e,t]=[t,e]);let r=n.mul(e).mul(t),s=t.sub(e),a=r.div(s);return i?re.mulDivRoundingUp(a,wt,es):a.shrn(hi)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),re.mulDivFloor(n,es,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,i,r){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return ye.getLiquidityFromTokenAmountA(t,n,i,!1);if(e.lt(n)){let s=ye.getLiquidityFromTokenAmountA(e,n,i,!1),a=ye.getLiquidityFromTokenAmountB(t,e,r);return s.lt(a)?s:a}else return ye.getLiquidityFromTokenAmountB(t,n,r)}static getAmountsFromLiquidity(e,t,n,i,r){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:ye.getTokenAmountAFromLiquidity(t,n,i,r),amountB:new ue(0)};if(e.lt(n)){let s=ye.getTokenAmountAFromLiquidity(e,n,i,r),a=ye.getTokenAmountBFromLiquidity(t,e,i,r);return{amountA:s,amountB:a}}else return{amountA:new ue(0),amountB:ye.getTokenAmountBFromLiquidity(t,n,i,r)}}static getAmountsFromLiquidityWithSlippage(e,t,n,i,r,s,a){let{amountA:c,amountB:u}=ye.getAmountsFromLiquidity(e,t,n,i,s),l=r?1+a:1-a,m=new ue(new N(c.toString()).mul(l).toFixed(0)),d=new ue(new N(u.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:i,slippage:r,add:s,epochInfo:a,amountAddFee:c}){var w,A,h,I;let u=ie.priceToSqrtPriceX64(new N(e.price),e.mintA.decimals,e.mintB.decimals),l=ie.getSqrtPriceX64FromTick(t),m=ie.getSqrtPriceX64FromTick(n),d=s?1+r:1-r,p=ye.getAmountsFromLiquidity(u,l,m,i,s),[f,y]=[Pe(p.amountA,(w=e.mintA.extensions)==null?void 0:w.feeConfig,a,c),Pe(p.amountB,(A=e.mintB.extensions)==null?void 0:A.feeConfig,a,c)],[b,g]=[Pe(new ue(new N(p.amountA.toString()).mul(d).toFixed(0)),(h=e.mintA.extensions)==null?void 0:h.feeConfig,a,c),Pe(new ue(new N(p.amountB.toString()).mul(d).toFixed(0)),(I=e.mintB.extensions)==null?void 0:I.feeConfig,a,c)];return{liquidity:i,amountA:f,amountB:y,amountSlippageA:b,amountSlippageB:g,expirationTime:_t(f.expirationTime,y.expirationTime)}}},Bn=class{static swapCompute(e,t,n,i,r,s,a,c,u,l,m,d,p,f,y=!1){if(d.eq(Re))throw new Error("amountSpecified must not be 0");if(f||(f=s?Kt.add(wt):Ct.sub(wt)),s){if(f.lt(Kt))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(f.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(f.gt(Ct))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(f.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let b=d.gt(Re),g={amountSpecifiedRemaining:d,amountCalculated:Re,sqrtPriceX64:m,tick:u>p?Math.min(p+fe.tickCount(l)-1,u):p,accounts:[],liquidity:c,feeAmount:new ue(0)},w=p,A=n[p],h=0,I=!s&&A.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(Re)&&!g.sqrtPriceX64.eq(f);){h>10;let k={};k.sqrtPriceStartX64=g.sqrtPriceX64;let x=Y.nextInitTick(A,g.tick,l,s,I),S=x||null,K=null;if(!(S!=null&&S.liquidityGross.gtn(0))){let C=Be.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:i,exBitmapInfo:r},w,s);if(!C.isExist){if(y)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}w=C.nextStartIndex;let{publicKey:R}=pe(e,t,w);K=R,A=n[w];try{S=Y.firstInitializedTick(A,s)}catch{throw Error("not found next tick info")}}k.tickNext=S.tick,k.initialized=S.liquidityGross.gtn(0),p!==w&&K&&(g.accounts.push(K),p=w),k.tickNext<rt?k.tickNext=rt:k.tickNext>lt&&(k.tickNext=lt),k.sqrtPriceNextX64=ie.getSqrtPriceX64FromTick(k.tickNext);let T;if(s&&k.sqrtPriceNextX64.lt(f)||!s&&k.sqrtPriceNextX64.gt(f)?T=f:T=k.sqrtPriceNextX64,[g.sqrtPriceX64,k.amountIn,k.amountOut,k.feeAmount]=Bn.swapStepCompute(g.sqrtPriceX64,T,g.liquidity,g.amountSpecifiedRemaining,a,s),g.feeAmount=g.feeAmount.add(k.feeAmount),b?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(k.amountIn.add(k.feeAmount)),g.amountCalculated=g.amountCalculated.sub(k.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(k.amountOut),g.amountCalculated=g.amountCalculated.add(k.amountIn.add(k.feeAmount))),g.sqrtPriceX64.eq(k.sqrtPriceNextX64)){if(k.initialized){let C=S.liquidityNet;s&&(C=C.mul($t)),g.liquidity=ye.addDelta(g.liquidity,C)}I=k.tickNext!=g.tick&&!s&&A.startTickIndex===k.tickNext,g.tick=s?k.tickNext-1:k.tickNext}else if(g.sqrtPriceX64!=k.sqrtPriceStartX64){let C=ie.getTickFromSqrtPriceX64(g.sqrtPriceX64);I=C!=g.tick&&!s&&A.startTickIndex===C,g.tick=C}++h}try{let{nextStartIndex:k,isExist:x}=fe.nextInitializedTickArray(g.tick,l,s,i,r);x&&p!==k&&(g.accounts.push(pe(e,t,k).publicKey),p=k)}catch{}return{allTrade:!0,amountSpecifiedRemaining:Re,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,i,r,s){let a={sqrtPriceX64Next:new ue(0),amountIn:new ue(0),amountOut:new ue(0),feeAmount:new ue(0)},c=i.gte(Re);if(c){let l=re.mulDivFloor(i,No.sub(new ue(r.toString())),No);a.amountIn=s?ye.getTokenAmountAFromLiquidity(t,e,n,!0):ye.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(a.amountIn)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=ie.getNextSqrtPriceX64FromInput(e,n,l,s)}else a.amountOut=s?ye.getTokenAmountBFromLiquidity(t,e,n,!1):ye.getTokenAmountAFromLiquidity(e,t,n,!1),i.mul($t).gte(a.amountOut)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=ie.getNextSqrtPriceX64FromOutput(e,n,i.mul($t),s);let u=t.eq(a.sqrtPriceX64Next);return s?(u&&c||(a.amountIn=ye.getTokenAmountAFromLiquidity(a.sqrtPriceX64Next,e,n,!0)),u&&!c||(a.amountOut=ye.getTokenAmountBFromLiquidity(a.sqrtPriceX64Next,e,n,!1))):(a.amountIn=u&&c?a.amountIn:ye.getTokenAmountBFromLiquidity(e,a.sqrtPriceX64Next,n,!0),a.amountOut=u&&!c?a.amountOut:ye.getTokenAmountAFromLiquidity(e,a.sqrtPriceX64Next,n,!1)),!c&&a.amountOut.gt(i.mul($t))&&(a.amountOut=i.mul($t)),c&&!a.sqrtPriceX64Next.eq(t)?a.feeAmount=i.sub(a.amountIn):a.feeAmount=re.mulDivCeil(a.amountIn,new ue(r),No.sub(new ue(r))),[a.sqrtPriceX64Next,a.amountIn,a.amountOut,a.feeAmount]}};var Xe=60,In=512,Y=class{static getTickArrayAddressByTick(e,t,n,i){let r=Y.getTickArrayStartIndexByTick(n,i),{publicKey:s}=pe(e,t,r);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=Y.getTickArrayStartIndexByTick(e,t),i=Math.floor((e-n)/t);if(i<0||i>=Xe)throw new Error("tick offset in array overflow");return i}static getTickArrayBitIndex(e,t){let n=fe.tickCount(t),i=e/n;return e<0&&e%n!=0?i=Math.ceil(i)-1:i=Math.floor(i),i}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*fe.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*Xe,i=Math.floor(e/n)+512;return Math.abs(i)}static checkTickArrayIsInitialized(e,t,n){let i=n*Xe,r=Math.floor(t/i)+512,s=Math.abs(r);return{isInitialized:e.testn(s),startIndex:(s-512)*i}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*Xe:e+t*Xe}static mergeTickArrayBitmap(e){let t=new td(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,i,r){let s=Math.floor(i/(n*Xe));return[...Y.searchLowBitFromStart(e,t,s-1,r,n),...Y.searchHightBitFromStart(e,t,s,r,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return Y.searchHightBitFromStart(e,t,-7680,In,n)}static getAllInitializedTickArrayInfo(e,t,n,i,r){let s=[],a=Y.getAllInitializedTickArrayStartIndex(n,i,r);for(let c of a){let{publicKey:u}=pe(e,t,c);s.push({tickArrayStartIndex:c,tickArrayAddress:u})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,i,r){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>Y.mergeTickArrayBitmap(u)),a=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n--,a.length===i)break}let c=fe.tickCount(r);return a.map(u=>u*c)}static searchHightBitFromStart(e,t,n,i,r){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>Y.mergeTickArrayBitmap(u)),a=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n++,a.length===i)break}let c=fe.tickCount(r);return a.map(u=>u*c)}static checkIsOutOfBoundary(e){return e<rt||e>lt}static nextInitTick(e,t,n,i,r){if(fe.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(i)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(r||(a=a+1);a<Xe;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=Xe-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<Xe;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let i=ie.getSqrtPriceX64FromTick(t),r=ie.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:r,tickSqrtPriceX64:i}:{tick:t,price:new N(1).div(r),tickSqrtPriceX64:i}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let i=n?t:new N(1).div(t),r=Sn.getTickWithPriceAndTickspacing(i,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=ie.getSqrtPriceX64FromTick(r),a=ie.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:r,price:a}:{tick:r,price:new N(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let i=ie.getSqrtPriceX64FromTick(t),r=ie.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:r,tickSqrtPriceX64:i}:{tick:t,price:new N(1).div(r),tickSqrtPriceX64:i}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let i=n?t:new N(1).div(t),r=Sn.getTickWithPriceAndTickspacing(i,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=ie.getSqrtPriceX64FromTick(r),a=ie.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:r,price:a}:{tick:r,price:new N(1).div(a)}}};var Pu=q([we(8),X("bump"),Yt("index"),O(""),ot("protocolFeeRate"),ot("tradeFeeRate"),Yt("tickSpacing"),H(P(),8,"")]),nd=q([ot("blockTimestamp"),Wn("tickCumulative"),H(P(),4)]),ku=q([we(8),Oe("initialized"),P("recentEpoch"),Yt("observationIndex"),O("poolId"),H(nd,100,"observations"),H(P(),4)]),id=q([X("rewardState"),P("openTime"),P("endTime"),P("lastUpdateTime"),ee("emissionsPerSecondX64"),P("rewardTotalEmissioned"),P("rewardClaimed"),O("tokenMint"),O("tokenVault"),O("creator"),ee("rewardGrowthGlobalX64")]),xn=q([we(8),X("bump"),O("ammConfig"),O("creator"),O("mintA"),O("mintB"),O("vaultA"),O("vaultB"),O("observationId"),X("mintDecimalsA"),X("mintDecimalsB"),Yt("tickSpacing"),ee("liquidity"),ee("sqrtPriceX64"),xe("tickCurrent"),ot(),ee("feeGrowthGlobalX64A"),ee("feeGrowthGlobalX64B"),P("protocolFeesTokenA"),P("protocolFeesTokenB"),ee("swapInAmountTokenA"),ee("swapOutAmountTokenB"),ee("swapInAmountTokenB"),ee("swapOutAmountTokenA"),X("status"),H(X(),7,""),H(id,3,"rewardInfos"),H(P(),16,"tickArrayBitmap"),P("totalFeesTokenA"),P("totalFeesClaimedTokenA"),P("totalFeesTokenB"),P("totalFeesClaimedTokenB"),P("fundFeesTokenA"),P("fundFeesTokenB"),P("startTime"),H(P(),15*4-3,"padding")]),od=q([ee("growthInsideLastX64"),P("rewardAmountOwed")]),Ci=q([we(8),X("bump"),O("nftMint"),O("poolId"),xe("tickLower"),xe("tickUpper"),ee("liquidity"),ee("feeGrowthInsideLastX64A"),ee("feeGrowthInsideLastX64B"),P("tokenFeesOwedA"),P("tokenFeesOwedB"),H(od,3,"rewardInfos"),H(P(),8,"")]),vk=q([we(8),X("bump"),O("poolId"),xe("tickLowerIndex"),xe("tickUpperIndex"),ee("liquidity"),ee("feeGrowthInsideLastX64A"),ee("feeGrowthInsideLastX64B"),P("tokenFeesOwedA"),P("tokenFeesOwedB"),H(ee(),3,"rewardGrowthInside"),H(P(),8,"")]),rd=q([xe("tick"),Ea("liquidityNet"),ee("liquidityGross"),ee("feeGrowthOutsideX64A"),ee("feeGrowthOutsideX64B"),H(ee(),3,"rewardGrowthsOutsideX64"),H(ot(),13,"")]),Si=q([we(8),O("poolId"),xe("startTickIndex"),H(rd,Xe,"ticks"),X("initializedTickCount"),H(X(),115,"")]),hu=q([we(329),H(O(),100,"whitelistMints")]),Au=q([we(8),O("poolId"),H(H(P(),8),ss,"positiveTickArrayBitmap"),H(H(P(),8),ss,"negativeTickArrayBitmap")]),_k=q([P(),X("bump"),O("owner"),O("poolId"),O("positionId"),O("nftAccount"),H(P(),8)]),Vk=q([we(8),X("bump"),O("lockOwner"),O("poolId"),O("positionId"),O("nftAccount"),O("lockNftMint"),P("recentEpoch"),H(P(),8)]);ku.span;var Tu=me("Raydium_Clmm"),kt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],openPositionWithTokenEx:[77,255,174,82,125,29,201,46],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},Iu=[188,37,179,131,82,150,84,73],Bu=[16,72,250,198,14,162,212,19],Te=class{static createPoolInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,f){let y=q([ee("sqrtPriceX64"),P("zero")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:en.programId,isSigner:!1,isWritable:!1},{pubkey:ct,isSigner:!1,isWritable:!1},...(f==null?void 0:f.map(A=>({pubkey:A,isSigner:!1,isWritable:!1})))||[]],g=Buffer.alloc(y.span);y.encode({sqrtPriceX64:p,zero:Re},g);let w=Buffer.from([...kt.createPool,...g]);return new $e({keys:b,programId:e,data:w})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:i,mintB:r,ammConfigId:s,initialPriceX64:a,extendMintAccount:c}=e,[u,l]=[new G(i.address),new G(r.address)],{publicKey:m}=pu(t,s,u,l),{publicKey:d}=yu(t,m),{publicKey:p}=is(t,m,u),{publicKey:f}=is(t,m,l),y=Ee(t,m).publicKey,b=[this.createPoolInstruction(t,m,n,s,d,u,p,new G(i.programId||he),l,f,new G(r.programId||he),y,a,c)];return{signers:[],instructions:b,instructionTypes:[W.CreateAccount,W.ClmmCreatePool],address:{poolId:m,observationId:d,exBitmapAccount:y,mintAVault:p,mintBVault:f},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,f,y,b,g,w,A,h,I,k,x,S,K,T){let C=q([xe("tickLowerIndex"),xe("tickUpperIndex"),xe("tickArrayLowerStartIndex"),xe("tickArrayUpperStartIndex"),ee("liquidity"),P("amountMaxA"),P("amountMaxB"),Oe("withMetadata"),X("optionBaseFlag"),Oe("baseFlag")]),R=[...T?[{pubkey:T,isSigner:!1,isWritable:!0}]:[]],L=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:en.programId,isSigner:!1,isWritable:!1},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Ri,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:Me,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...R],v=Buffer.alloc(C.span);C.encode({tickLowerIndex:w,tickUpperIndex:A,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:I,liquidity:k,amountMaxA:x,amountMaxB:S,withMetadata:K==="create",baseFlag:!1,optionBaseFlag:0},v);let F=Buffer.from([...kt.openPosition,...v]);return new $e({keys:L,programId:e,data:F})}static openPositionFromLiquidityInstruction22(e,t,n,i,r,s,a,c,u,l,m,d,p,f,y,b,g,w,A,h,I,k,x,S,K){let T=q([xe("tickLowerIndex"),xe("tickUpperIndex"),xe("tickArrayLowerStartIndex"),xe("tickArrayUpperStartIndex"),ee("liquidity"),P("amountMaxA"),P("amountMaxB"),Oe("withMetadata"),X("optionBaseFlag"),Oe("baseFlag")]),C=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],R=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:en.programId,isSigner:!1,isWritable:!1},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Ri,isSigner:!1,isWritable:!1},{pubkey:Me,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...C],L=Buffer.alloc(T.span);T.encode({tickLowerIndex:g,tickUpperIndex:w,tickArrayLowerStartIndex:A,tickArrayUpperStartIndex:h,liquidity:I,amountMaxA:k,amountMaxB:x,withMetadata:S==="create",baseFlag:!1,optionBaseFlag:0},L);let v=Buffer.from([...kt.openPositionWithTokenEx,...L]);return new $e({keys:R,programId:e,data:v})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d=[],[p,f]=[new G(e.programId),new G(e.id)],y;if(l)y=new G((await l(1))[0]);else{let K=_o.generate();d.push(K),y=K.publicKey}let b=Y.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=Y.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:w}=pe(p,f,b),{publicKey:A}=pe(p,f,g),{publicKey:h}=m?oe(n.wallet,y,Me):oe(n.wallet,y,he),{publicKey:I}=Tn(y),{publicKey:k}=mt(p,y),{publicKey:x}=Et(p,f,i,r),S=m?this.openPositionFromLiquidityInstruction22(p,n.feePayer,f,n.wallet,y,h,x,w,A,k,n.tokenAccountA,n.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(e.mintA.address),new G(e.mintB.address),i,r,b,g,s,a,c,u,Be.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ee(p,f).publicKey:void 0):this.openPositionFromLiquidityInstruction(p,n.feePayer,f,n.wallet,y,h,I,x,w,A,k,n.tokenAccountA,n.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(e.mintA.address),new G(e.mintB.address),i,r,b,g,s,a,c,u,Be.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ee(p,f).publicKey:void 0);return{signers:d,instructions:[S],instructionTypes:[W.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:y,tickArrayLower:w,tickArrayUpper:A,positionNftAccount:h,metadataAccount:I,personalPosition:k,protocolPosition:x}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d=[],[p,f]=[new G(e.programId),new G(e.id)],y;if(l)y=new G((await l(1))[0]);else{let K=_o.generate();d.push(K),y=K.publicKey}let b=Y.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=Y.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:w}=pe(p,f,b),{publicKey:A}=pe(p,f,g),{publicKey:h}=m?oe(n.wallet,y,Me):oe(n.wallet,y,he),{publicKey:I}=Tn(y),{publicKey:k}=mt(p,y),{publicKey:x}=Et(p,f,i,r),S=m?this.openPositionFromBaseInstruction22(p,n.feePayer,f,n.wallet,y,h,x,w,A,k,n.tokenAccountA,n.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(e.mintA.address),new G(e.mintB.address),i,r,b,g,u,s,a,c,Be.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ee(p,f).publicKey:void 0):this.openPositionFromBaseInstruction(p,n.feePayer,f,n.wallet,y,h,I,x,w,A,k,n.tokenAccountA,n.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(e.mintA.address),new G(e.mintB.address),i,r,b,g,u,s,a,c,Be.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ee(p,f).publicKey:void 0);return{address:{nftMint:y,tickArrayLower:w,tickArrayUpper:A,positionNftAccount:h,metadataAccount:I,personalPosition:k,protocolPosition:x},instructions:[S],signers:d,instructionTypes:[W.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,f,y,b,g,w,A,h,I,k,x,S,K,T){let C=q([xe("tickLowerIndex"),xe("tickUpperIndex"),xe("tickArrayLowerStartIndex"),xe("tickArrayUpperStartIndex"),ee("liquidity"),P("amountMaxA"),P("amountMaxB"),Oe("withMetadata"),X("optionBaseFlag"),Oe("baseFlag")]),R=[...T?[{pubkey:T,isSigner:!1,isWritable:!0}]:[]],L=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:en.programId,isSigner:!1,isWritable:!1},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Ri,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:Me,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...R],v=Buffer.alloc(C.span);C.encode({tickLowerIndex:w,tickUpperIndex:A,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:I,liquidity:new cs(0),amountMaxA:x==="MintA"?S:K,amountMaxB:x==="MintA"?K:S,withMetadata:k==="create",baseFlag:x==="MintA",optionBaseFlag:1},v);let F=Buffer.from([...kt.openPosition,...v]);return new $e({keys:L,programId:e,data:F})}static openPositionFromBaseInstruction22(e,t,n,i,r,s,a,c,u,l,m,d,p,f,y,b,g,w,A,h,I,k,x,S,K){let T=q([xe("tickLowerIndex"),xe("tickUpperIndex"),xe("tickArrayLowerStartIndex"),xe("tickArrayUpperStartIndex"),ee("liquidity"),P("amountMaxA"),P("amountMaxB"),Oe("withMetadata"),X("optionBaseFlag"),Oe("baseFlag")]),C=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],R=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:en.programId,isSigner:!1,isWritable:!1},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Ri,isSigner:!1,isWritable:!1},{pubkey:Me,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...C],L=Buffer.alloc(T.span);T.encode({tickLowerIndex:g,tickUpperIndex:w,tickArrayLowerStartIndex:A,tickArrayUpperStartIndex:h,liquidity:new cs(0),amountMaxA:k==="MintA"?x:S,amountMaxB:k==="MintA"?S:x,withMetadata:I==="create",baseFlag:k==="MintA",optionBaseFlag:1},L);let v=Buffer.from([...kt.openPositionWithTokenEx,...L]);return new $e({keys:R,programId:e,data:v})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d,p=[];if(l)d=new G((await l(1))[0]);else{let K=_o.generate();p.push(K),d=K.publicKey}let[f,y]=[new G(e.programId),new G(e.id)],b=Y.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=Y.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:w}=pe(f,y,b),{publicKey:A}=pe(f,y,g),{publicKey:h}=m?oe(n.wallet,d,Me):oe(n.wallet,d,he),{publicKey:I}=Tn(d),{publicKey:k}=mt(f,d),{publicKey:x}=Et(f,y,i,r),S=m?this.openPositionFromLiquidityInstruction22(f,n.wallet,y,n.wallet,d,h,x,w,A,k,n.tokenAccountA,n.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(t.mintA.address),new G(t.mintB.address),i,r,b,g,s,a,c,u,Be.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ee(f,y).publicKey:void 0):this.openPositionFromLiquidityInstruction(f,n.wallet,y,n.wallet,d,h,I,x,w,A,k,n.tokenAccountA,n.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(t.mintA.address),new G(t.mintB.address),i,r,b,g,s,a,c,u,Be.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ee(f,y).publicKey:void 0);return{address:{nftMint:d,tickArrayLower:w,tickArrayUpper:A,positionNftAccount:h,metadataAccount:I,personalPosition:k,protocolPosition:x},instructions:[S],signers:p,instructionTypes:[W.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,i,r,s){let a=q([]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:en.programId,isSigner:!1,isWritable:!1},{pubkey:s?Me:he,isSigner:!1,isWritable:!1}],u=Buffer.alloc(a.span);a.encode({},u);let l=Buffer.from([...kt.closePosition,...u]);return new $e({keys:c,programId:e,data:l})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:i,nft2022:r}){let s=new G(e.programId),a=r?oe(n.wallet,i.nftMint,Me).publicKey:oe(n.wallet,i.nftMint,he).publicKey,{publicKey:c}=mt(s,i.nftMint),u=[];return u.push(this.closePositionInstruction(s,n.wallet,i.nftMint,a,c,r)),{address:{positionNftAccount:a,personalPosition:c},signers:[],instructions:u,instructionTypes:[W.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,f,y,b,g,w){let A=q([ee("liquidity"),P("amountMaxA"),P("amountMaxB"),X("optionBaseFlag"),Oe("baseFlag")]),h=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Me,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...h],k=Buffer.alloc(A.span);A.encode({liquidity:y,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},k);let x=Buffer.from([...kt.increaseLiquidity,...k]);return new $e({keys:I,programId:e,data:x})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:r,amountMaxA:s,amountMaxB:a,nft2022:c}){let[u,l]=[new G(e.programId),new G(e.id)],m=Y.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=Y.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=pe(u,l,m),{publicKey:f}=pe(u,l,d),{publicKey:y}=c?oe(i.wallet,n.nftMint,Me):oe(i.wallet,n.nftMint,he),{publicKey:b}=mt(u,n.nftMint),{publicKey:g}=Et(u,l,n.tickLower,n.tickUpper),w=this.increasePositionFromLiquidityInstruction(u,i.wallet,y,b,l,g,p,f,i.tokenAccountA,i.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(e.mintA.address),new G(e.mintB.address),r,s,a,Be.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?Ee(u,l).publicKey:void 0);return{address:{tickArrayLower:p,tickArrayUpper:f,positionNftAccount:y,personalPosition:b,protocolPosition:g},signers:[],instructions:[w],instructionTypes:[W.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,base:r,baseAmount:s,otherAmountMax:a,nft2022:c}){let[u,l]=[new G(e.programId),new G(e.id)],m=Y.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=Y.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=pe(u,l,m),{publicKey:f}=pe(u,l,d),{publicKey:y}=c?oe(i.wallet,n.nftMint,Me):oe(i.wallet,n.nftMint,he),{publicKey:b}=mt(u,n.nftMint),{publicKey:g}=Et(u,l,n.tickLower,n.tickUpper);return{address:{tickArrayLower:p,tickArrayUpper:f,positionNftAccount:y,personalPosition:b,protocolPosition:g},instructions:[this.increasePositionFromBaseInstruction(u,i.wallet,y,b,l,g,p,f,i.tokenAccountA,i.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(e.mintA.address),new G(e.mintB.address),r,s,a,Be.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?Ee(u,l).publicKey:void 0)],signers:[],instructionTypes:[W.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,f,y,b,g,w){let A=q([ee("liquidity"),P("amountMaxA"),P("amountMaxB"),X("optionBaseFlag"),Oe("baseFlag")]),h=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Me,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...h],k=Buffer.alloc(A.span);A.encode({liquidity:new cs(0),amountMaxA:y==="MintA"?b:g,amountMaxB:y==="MintA"?g:b,baseFlag:y==="MintA",optionBaseFlag:1},k);let x=Buffer.from([...kt.increaseLiquidity,...k]);return new $e({keys:I,programId:e,data:x})}static decreaseLiquidityInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,f,y,b,g,w,A){let h=q([ee("liquidity"),P("amountMinA"),P("amountMinB")]),I=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[],...y.map(K=>[{pubkey:K.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:K.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:K.rewardMint,isSigner:!1,isWritable:!1}]).flat()],k=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Me,isSigner:!1,isWritable:!1},{pubkey:oo,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...I],x=Buffer.alloc(h.span);h.encode({liquidity:b,amountMinA:g,amountMinB:w},x);let S=Buffer.from([...kt.decreaseLiquidity,...x]);return new $e({keys:k,programId:e,data:S})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:r,amountMinA:s,amountMinB:a,programId:c,nft2022:u}){let[l,m]=[new G(e.programId),new G(e.id)],d=Y.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=Y.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:f}=pe(l,m,d),{publicKey:y}=pe(l,m,p),{publicKey:b}=u?oe(i.wallet,n.nftMint,Me):oe(i.wallet,n.nftMint,c),{publicKey:g}=mt(l,n.nftMint),{publicKey:w}=Et(l,m,n.tickLower,n.tickUpper),A=[];for(let k=0;k<e.rewardDefaultInfos.length;k++)A.push({poolRewardVault:new G(t.rewardInfos[k].vault),ownerRewardVault:i.rewardAccounts[k],rewardMint:new G(e.rewardDefaultInfos[k].mint.address)});let h=[],I=this.decreaseLiquidityInstruction(l,i.wallet,b,g,m,w,f,y,i.tokenAccountA,i.tokenAccountB,new G(t.vault.A),new G(t.vault.B),new G(e.mintA.address),new G(e.mintB.address),A,r,s,a,Be.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,p])?Ee(l,m).publicKey:void 0);return h.push(I),{address:{tickArrayLower:f,tickArrayUpper:y,positionNftAccount:b,personalPosition:g,protocolPosition:w},signers:[],instructions:h,instructionTypes:[W.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,f,y,b,g){let w=q([P("amount"),P("otherAmountThreshold"),ee("sqrtPriceLimitX64"),Oe("isBaseInput")]),A=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...m.map(x=>({pubkey:x,isSigner:!1,isWritable:!0}))],h=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Me,isSigner:!1,isWritable:!1},{pubkey:oo,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...A],I=Buffer.alloc(w.span);w.encode({amount:p,otherAmountThreshold:f,sqrtPriceLimitX64:y,isBaseInput:b},I);let k=Buffer.from([...kt.swap,...I]);return new $e({keys:h,programId:e,data:k})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,inputMint:r,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new G(e.programId),new G(e.id)],[d,p]=[new G(t.vault.A),new G(t.vault.B)],[f,y]=[new G(e.mintA.address),new G(e.mintB.address)],b=e.mintA.address===r.toString(),g=[this.swapInstruction(l,i.wallet,m,new G(e.config.id),b?i.tokenAccountA:i.tokenAccountB,b?i.tokenAccountB:i.tokenAccountA,b?d:p,b?p:d,b?f:y,b?y:f,u,n,s,a,c,!0,Ee(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[W.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,outputMint:r,amountOut:s,amountInMax:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new G(e.programId),new G(e.id)],[d,p]=[new G(t.vault.A),new G(t.vault.B)],[f,y]=[new G(e.mintA.address),new G(e.mintB.address)],b=e.mintA.address===r.toBase58(),g=[this.swapInstruction(l,i.wallet,m,new G(e.config.id),b?i.tokenAccountB:i.tokenAccountA,b?i.tokenAccountA:i.tokenAccountB,b?p:d,b?d:p,b?y:f,b?f:y,u,n,s,a,c,!1,Ee(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[W.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,i,r,s,a,c,u,l,m,d){let p=q([P("openTime"),P("endTime"),ee("emissionsPerSecondX64")]),f=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:en.programId,isSigner:!1,isWritable:!1},{pubkey:ct,isSigner:!1,isWritable:!1}],y=Buffer.alloc(p.span);p.encode({openTime:$(l),endTime:$(m),emissionsPerSecondX64:d},y);let b=Buffer.from([...kt.initReward,...y]);return new $e({keys:f,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[r,s]=[new G(e.programId),new G(e.id)],a=fu(r,s,i.mint).publicKey,c=Ii(r).publicKey,u=[this.initRewardInstruction(r,n.wallet,s,c,new G(e.config.id),n.tokenAccount,i.programId,i.mint,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:c},signers:[],instructions:u,instructionTypes:[W.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,i,r,s,a,c,u,l,m,d){let p=q([X("rewardIndex"),ee("emissionsPerSecondX64"),P("openTime"),P("endTime")]),f=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Me,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0}],y=Buffer.alloc(p.span);p.encode({rewardIndex:u,emissionsPerSecondX64:d,openTime:$(l),endTime:$(m)},y);let b=Buffer.from([...kt.setRewardEmissions,...y]);return new $e({keys:f,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[r,s]=[new G(e.programId),new G(e.id)],a,c,u;for(let d=0;d<e.rewardDefaultInfos.length;d++)e.rewardDefaultInfos[d].mint.address===i.mint.toString()&&(a=d,c=new G(t.rewardInfos[d].vault),u=new G(t.rewardInfos[d].mint.address));(a===void 0||c===void 0)&&Tu.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=Ii(r).publicKey,m=[this.setRewardInstruction(r,n.wallet,s,l,new G(e.config.id),n.tokenAccount,c,u,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{rewardVault:c,operationId:l},signers:[],instructions:m,instructionTypes:[W.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,i,r,s,a){let c=q([X("rewardIndex")]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Me,isSigner:!1,isWritable:!1},{pubkey:oo,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({rewardIndex:a},l);let m=Buffer.from([...kt.collectReward,...l]);return new $e({keys:u,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:i}){let[r,s]=[new G(e.programId),new G(e.id)],a,c;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===i.toString()&&(a=l,c=new G(t.rewardInfos[l].vault));(a===void 0||c===void 0)&&Tu.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let u=[this.collectRewardInstruction(r,n.wallet,s,n.tokenAccount,c,i,a)];return{address:{rewardVault:c},signers:[],instructions:u,instructionTypes:[W.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:i,wallet:r,nftMint:s,nft2022:a,getEphemeralSigners:c}){let u=[],l;if(c)l=new G((await c(1))[0]);else{let g=_o.generate();u.push(g),l=g.publicKey}let m=a?oe(r,s,Me).publicKey:oe(r,s,he).publicKey,{publicKey:d}=mt(n,s),p=Bi(e,l).publicKey,f=oe(r,l,he).publicKey,y=Tn(l).publicKey,b=Te.lockPositionInstructionV2({programId:e,auth:t,payer:i,positionOwner:r,lockOwner:r,positionNftAccount:m,positionId:d,lockPositionId:p,lockNftMint:l,lockNftAccount:f,metadataAccount:y,withMetadata:!0,nft2022:a,positionNftMint:s,authPositionNftAccount:oe(t,s,a?Me:he).publicKey,positionNftProgram:a?Me:he});return{address:{positionId:d,lockPositionId:p,lockNftAccount:f,lockNftMint:l,positionNftAccount:m,metadataAccount:y},instructions:[b],signers:u,instructionTypes:[W.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:i,lockOwner:r,positionNftAccount:s,positionId:a,positionNftMint:c,authPositionNftAccount:u,positionNftProgram:l,lockPositionId:m,lockNftMint:d,lockNftAccount:p,metadataAccount:f,withMetadata:y}){let b=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!0,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:Ri,isSigner:!1,isWritable:!1},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:en.programId,isSigner:!1,isWritable:!1}],g=q([Oe("withMetadata")]),w=Buffer.alloc(g.span);g.encode({withMetadata:y},w);let A=Buffer.from([...Iu,...w]);return new $e({keys:b,programId:e,data:A})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:i,positionNft:r}){let{publicKey:s}=oe(i,r,he),{publicKey:a}=mt(n,r),c=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:os(e,a).publicKey,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:en.programId,isSigner:!1,isWritable:!1}];return new $e({keys:c,programId:e,data:Buffer.from(Iu)})}static harvestLockPositionInstruction(e){let[t,n]=[new G(e.poolKeys.programId),new G(e.poolKeys.id)],i=Y.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),r=Y.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:s}=pe(t,n,i),{publicKey:a}=pe(t,n,r),{publicKey:c}=oe(e.owner,e.ownerPosition.nftMint,he),{publicKey:u}=mt(t,e.ownerPosition.nftMint),{publicKey:l}=Et(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),m=[];for(let f=0;f<e.poolKeys.rewardInfos.length;f++)m.push({poolRewardVault:new G(e.poolKeys.rewardInfos[f].vault),ownerRewardVault:e.ownerRewardAccounts[f],rewardMint:new G(e.poolKeys.rewardInfos[f].mint.address)});let d=[...m.map(f=>[{pubkey:f.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:f.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:f.rewardMint,isSigner:!1,isWritable:!1}]).flat()],p=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:os(e.programId,u).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new G(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new G(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Me,isSigner:!1,isWritable:!1},{pubkey:cn,isSigner:!1,isWritable:!1},{pubkey:new G(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new G(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...d];return new $e({keys:p,programId:e.programId,data:Buffer.from(Bu)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:i,lockOwner:r,lockNftMint:s,lockNftAccount:a,positionNftAccount:c,positionId:u,poolId:l,protocolPosition:m,vaultA:d,vaultB:p,tickArrayLower:f,tickArrayUpper:y,userVaultA:b,userVaultB:g,mintA:w,mintB:A,rewardAccounts:h,exTickArrayBitmap:I}){let k=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[],...h.map(S=>[{pubkey:S.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:S.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:S.rewardMint,isSigner:!1,isWritable:!1}]).flat()],x=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:he,isSigner:!1,isWritable:!1},{pubkey:Me,isSigner:!1,isWritable:!1},{pubkey:cn,isSigner:!1,isWritable:!1},{pubkey:w,isSigner:!1,isWritable:!1},{pubkey:A,isSigner:!1,isWritable:!1},...k];return new $e({keys:x,programId:e,data:Buffer.from(Bu)})}};var th=q([ot("mintAuthorityOption"),O("mintAuthority"),P("supply"),X("decimals"),X("isInitialized"),ot("freezeAuthorityOption"),O("freezeAuthority")]);import{PublicKey as rh}from"@solana/web3.js";import{MintLayout as ah,TOKEN_PROGRAM_ID as ch}from"@solana/spl-token";var Vo=o=>new Ce({mint:o.address,decimals:o.decimals,symbol:o.symbol,name:o.name}),Li=i=>{var r=i,{amount:o,isRaw:e,name:t}=r,n=We(r,["amount","isRaw","name"]);return new Ae(new Ce({mint:tt(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),o,e,t)};var st=i=>{var r=i,{address:o,programId:e,decimals:t}=r,n=We(r,["address","programId","decimals"]);return M({chainId:101,address:tt(o).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{}},n)},yn=o=>o?U(M({},o),{transferFeeConfigAuthority:o.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:o.withdrawWithheldAuthority.toBase58(),withheldAmount:o.withheldAmount.toString(),olderTransferFee:U(M({},o.olderTransferFee),{epoch:o.olderTransferFee.epoch.toString(),maximumFee:o.olderTransferFee.maximumFee.toString()}),newerTransferFee:U(M({},o.newerTransferFee),{epoch:o.newerTransferFee.epoch.toString(),maximumFee:o.newerTransferFee.maximumFee.toString()})}):void 0;import xu from"bn.js";var ls=new xu(25),Eo=new xu(1e4);import{PublicKey as Gt,SystemProgram as Ad,SYSVAR_RENT_PUBKEY as Oh,TransactionInstruction as zn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Pd,TOKEN_PROGRAM_ID as Mi}from"@solana/spl-token";var ms=q([X("instruction"),P("amountIn"),P("minAmountOut")]),ds=q([X("instruction"),P("maxAmountIn"),P("amountOut")]),Ih=q([X("instruction"),X("nonce")]),sd=q([X("instruction"),X("nonce"),P("startTime")]),Fo=q([P("status"),P("nonce"),P("maxOrder"),P("depth"),P("baseDecimal"),P("quoteDecimal"),P("state"),P("resetFlag"),P("minSize"),P("volMaxCutRatio"),P("amountWaveRatio"),P("baseLotSize"),P("quoteLotSize"),P("minPriceMultiplier"),P("maxPriceMultiplier"),P("systemDecimalValue"),P("minSeparateNumerator"),P("minSeparateDenominator"),P("tradeFeeNumerator"),P("tradeFeeDenominator"),P("pnlNumerator"),P("pnlDenominator"),P("swapFeeNumerator"),P("swapFeeDenominator"),P("baseNeedTakePnl"),P("quoteNeedTakePnl"),P("quoteTotalPnl"),P("baseTotalPnl"),P("poolOpenTime"),P("punishPcAmount"),P("punishCoinAmount"),P("orderbookToInitTime"),ee("swapBaseInAmount"),ee("swapQuoteOutAmount"),P("swapBase2QuoteFee"),ee("swapQuoteInAmount"),ee("swapBaseOutAmount"),P("swapQuote2BaseFee"),O("baseVault"),O("quoteVault"),O("baseMint"),O("quoteMint"),O("lpMint"),O("openOrders"),O("marketId"),O("marketProgramId"),O("targetOrders"),O("withdrawQueue"),O("lpVault"),O("owner"),P("lpReserve"),H(P(),3,"padding")]),Bh=q([P("accountType"),P("status"),P("nonce"),P("maxOrder"),P("depth"),P("baseDecimal"),P("quoteDecimal"),P("state"),P("resetFlag"),P("minSize"),P("volMaxCutRatio"),P("amountWaveRatio"),P("baseLotSize"),P("quoteLotSize"),P("minPriceMultiplier"),P("maxPriceMultiplier"),P("systemDecimalsValue"),P("abortTradeFactor"),P("priceTickMultiplier"),P("priceTick"),P("minSeparateNumerator"),P("minSeparateDenominator"),P("tradeFeeNumerator"),P("tradeFeeDenominator"),P("pnlNumerator"),P("pnlDenominator"),P("swapFeeNumerator"),P("swapFeeDenominator"),P("baseNeedTakePnl"),P("quoteNeedTakePnl"),P("quoteTotalPnl"),P("baseTotalPnl"),P("poolOpenTime"),P("punishPcAmount"),P("punishCoinAmount"),P("orderbookToInitTime"),ee("swapBaseInAmount"),ee("swapQuoteOutAmount"),ee("swapQuoteInAmount"),ee("swapBaseOutAmount"),P("swapQuote2BaseFee"),P("swapBase2QuoteFee"),O("baseVault"),O("quoteVault"),O("baseMint"),O("quoteMint"),O("lpMint"),O("modelDataAccount"),O("openOrders"),O("marketId"),O("marketProgramId"),O("targetOrders"),O("owner"),H(P(),64,"padding")]),ps=q([X("instruction"),P("baseAmountIn"),P("quoteAmountIn"),P("fixedSide"),P("otherAmountMin")]),fs=q([X("instruction"),P("lpAmount"),P("baseAmountMin"),P("quoteAmountMin")]);var Su=q([P("fee")]);import{PublicKey as ad}from"@solana/web3.js";var Xn=new ad("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Cn=5e4,ud=q([P("x"),P("y"),P("price")]),cd=q([P("accountType"),P("status"),P("multiplier"),P("validDataCount"),H(ud,Cn,"DataElement")]);function ld(o,e){return[0,Cn-2]}function md(o){return[0,Cn-2]}function dd(o){return[0,Cn-2]}function pd(o,e,t){let[n,i]=ld(e,t),r=n,s=i,a=0,c=e*o.multiplier/t;for(;r<=s;){if(a=Math.floor((s+r)/2),a===0||a>=Cn-2)return[a,a,!1];let u=o.DataElement[a].x*o.multiplier/o.DataElement[a].y,l=o.DataElement[a-1].x*o.multiplier/o.DataElement[a-1].y,m=o.DataElement[a+1].x*o.multiplier/o.DataElement[a+1].y;if(c===u)return[a,a,!0];if(c===l)return[a-1,a-1,!0];if(c===m)return[a+1,a+1,!0];if(c<l)s=a-1;else{if(c>l&&c<u)return[a-1,a,!0];if(c>u&&c<m)return[a,a+1,!0];r=a+1}}return[a,a,!1]}function ys(o,e,t){let[n,i,r]=pd(o,e,t);if(!r)return 0;if(n===i){let s=o.DataElement[n].x;return e*o.multiplier/s}else{let s=o.DataElement[n].x,a=o.DataElement[n].y,c=o.DataElement[i].x,u=o.DataElement[i].y,l=t*(c*a-s*u),m=s*l,d=(c-s)*(e*a-s*t)*u,p=m+d;return e*o.multiplier*l/p}}function Kn(o,e,t){return e*o.multiplier/t}function Ku(o,e,t){return e*t/o.multiplier}function fd(o,e){let[t,n]=md(e),i=t,r=n,s=0,a=e;for(;i<r;){if(s=Math.floor((r+i)/2),s<=0||s>Cn-2)return[s,s,!1];let c=o.DataElement[s].x,u=o.DataElement[s-1].x,l=o.DataElement[s+1].x;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<u)r=s-1;else{if(a>u&&a<c)return[s-1,s,!0];if(a>c&&a<l)return[s,s+1,!0];i=s+1}}return[s,s,!1]}function yd(o,e){let[t,n]=dd(e),i=t,r=n,s=0,a=e;for(;i<=r;){if(s=Math.floor((r+i)/2),s<=0||s>=Cn-2)return[s,s,!1];let c=o.DataElement[s].y,u=o.DataElement[s-1].y,l=o.DataElement[s+1].y;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)i=s+1;else{if(a<u&&a>c)return[s-1,s,!0];if(a<c&&a>l)return[s,s+1,!0];r=s-1}}return[s,s,!1]}function Cu(o,e,t,n){let i=n?e+t:e-t,[r,s,a]=fd(o,i);if(!a)return[0,0,!1,a];if(r===s)return[o.DataElement[s].price,o.DataElement[s].y,!1,a];{let c=o.DataElement[r].x,u=o.DataElement[s].x,l=o.DataElement[r].price,m=o.DataElement[s].price,d=o.DataElement[r].y,p=o.DataElement[s].y;if(e>=c&&e<=u)return n?[m,p,!0,a]:[l,d,!0,a];{let f,y;return n?(f=l+(m-l)*(e-c)/(u-c),y=d-(i-c)*o.multiplier/m):(f=l+(m-l)*(e-c)/(u-c),y=p+(u-i)*o.multiplier/l),[f,y,!1,a]}}}function bd(o,e,t,n){let i=n?e-t:e+t,[r,s,a]=yd(o,i);if(!a)return[0,0,!1,a];if(r===s)return[o.DataElement[s].price,o.DataElement[s].x,!1,a];{let c=o.DataElement[r].x,u=o.DataElement[s].x,l=o.DataElement[r].price,m=o.DataElement[s].price,d=o.DataElement[r].y,p=o.DataElement[s].y;if(e>=p&&e<=d)return n?[m,u,!0,a]:[l,c,!0,a];{let f,y;return n?(f=l+(m-l)*(d-e)/(d-p),y=c+m*(d-i)/o.multiplier):(f=l+(m-l)*(d-e)/(d-p),y=u-l*(i-p)/o.multiplier),[f,y,!1,a]}}}function gd(o,e){let t=Cu(o,e,0,!1);return t[3]?t[0]:0}function Ru(o,e,t,n){let i=ys(o,e,t),r=Kn(o,e,i),s=Kn(o,t,i),a=Kn(o,n,i),c=!0,[u,l,m,d]=Cu(o,r,a,c);if(!d)return 0;if(m)return n*o.multiplier/u;{let p=s-l;return Ku(o,p,i)}}function Lu(o,e,t,n){let i=ys(o,e,t),r=Kn(o,e,i),s=Kn(o,t,i),a=Kn(o,n,i),c=!1,[u,l,m,d]=bd(o,s,a,c);if(!d)return 0;if(m)return n*u/o.multiplier;{let p=r-l;return Ku(o,p,i)}}function wd(o){let e=cd.decode(o);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function Ou(o,e,t,n){let i=gd(o,Kn(o,e,ys(o,e,t)))/o.multiplier;return n?i:1/i}var Oi=class{constructor({connection:e}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(Xn);e&&(this._layoutData=wd(e==null?void 0:e.data))}}};var Mu=me("Raydium_liquidity_instruction");function Nu(o){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:i,quoteAmountIn:r,fixedSide:s,otherAmountMin:a}=o,c=Buffer.alloc(ps.span);ps.encode({instruction:3,baseAmountIn:$(i),quoteAmountIn:$(r),otherAmountMin:$(a),fixedSide:s==="base"?yt:ua},c);let u=[B({pubkey:Mi,isWritable:!1}),B({pubkey:new Gt(e.id)}),B({pubkey:new Gt(t.authority),isWritable:!1}),B({pubkey:new Gt(t.openOrders),isWritable:!1}),B({pubkey:new Gt(t.targetOrders)}),B({pubkey:new Gt(e.lpMint.address)}),B({pubkey:new Gt(t.vault.A)}),B({pubkey:new Gt(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(B({pubkey:Xn})),u.push(B({pubkey:new Gt(e.marketId),isWritable:!1}),B({pubkey:n.baseTokenAccount}),B({pubkey:n.quoteTokenAccount}),B({pubkey:n.lpTokenAccount}),B({pubkey:n.owner,isWritable:!1,isSigner:!0}),B({pubkey:new Gt(t.marketEventQueue),isWritable:!1})),new zn({programId:new Gt(e.programId),keys:u,data:c})}function bs(o){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:i,baseAmountMin:r,quoteAmountMin:s}=o,a=Ze(t),c=4;if(e.pooltype.includes("StablePool")&&(c=5),c===4||c===5){let u=Buffer.alloc(fs.span);fs.encode({instruction:4,lpAmount:$(i),baseAmountMin:$(r),quoteAmountMin:$(s)},u);let l=[B({pubkey:Mi,isWritable:!1}),B({pubkey:a.id}),B({pubkey:a.authority,isWritable:!1}),B({pubkey:a.openOrders}),B({pubkey:a.targetOrders}),B({pubkey:a.mintLp.address}),B({pubkey:a.vault.A}),B({pubkey:a.vault.B})];return c===5?l.push(B({pubkey:Xn})):(l.push(B({pubkey:a.id})),l.push(B({pubkey:a.id}))),l.push(B({pubkey:a.marketProgramId,isWritable:!1}),B({pubkey:a.marketId}),B({pubkey:a.marketBaseVault}),B({pubkey:a.marketQuoteVault}),B({pubkey:a.marketAuthority,isWritable:!1}),B({pubkey:n.lpTokenAccount}),B({pubkey:n.baseTokenAccount}),B({pubkey:n.quoteTokenAccount}),B({pubkey:n.owner,isWritable:!1,isSigner:!0}),B({pubkey:a.marketEventQueue}),B({pubkey:a.marketBids}),B({pubkey:a.marketAsks})),new zn({programId:a.programId,keys:l,data:u})}return new zn({programId:a.programId,keys:[]})}function gs({programId:o,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:i,coinMint:r,pcMint:s,coinVault:a,pcVault:c,withdrawQueue:u,ammTargetOrders:l,poolTempLp:m,marketProgramId:d,marketId:p,userWallet:f,userCoinVault:y,userPcVault:b,userLpVault:g,nonce:w,openTime:A,coinAmount:h,pcAmount:I,ammConfigId:k,feeDestinationId:x}){let S=q([X("instruction"),X("nonce"),P("openTime"),P("pcAmount"),P("coinAmount")]),K=[{pubkey:Mi,isSigner:!1,isWritable:!1},{pubkey:Pd,isSigner:!1,isWritable:!1},{pubkey:Ad.programId,isSigner:!1,isWritable:!1},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:k,isSigner:!1,isWritable:!1},{pubkey:x,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!0,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],T=Buffer.alloc(S.span);return S.encode({instruction:1,nonce:w,openTime:A,coinAmount:h,pcAmount:I},T),{instruction:new zn({keys:K,programId:o,data:T}),instructionType:W.AmmV4CreatePool}}function kd({poolKeys:o,userKeys:e,amountIn:t,minAmountOut:n},i){let r=Ze(o),s=Buffer.alloc(ms.span);ms.encode({instruction:9,amountIn:$(t),minAmountOut:$(n)},s);let a=[B({pubkey:Mi,isWritable:!1}),B({pubkey:r.id}),B({pubkey:r.authority,isWritable:!1}),B({pubkey:r.openOrders})];return i===4&&a.push(B({pubkey:r.targetOrders})),a.push(B({pubkey:r.vault.A}),B({pubkey:r.vault.B})),i===5&&a.push(B({pubkey:Xn})),a.push(B({pubkey:r.marketProgramId,isWritable:!1}),B({pubkey:r.marketId}),B({pubkey:r.marketBids}),B({pubkey:r.marketAsks}),B({pubkey:r.marketEventQueue}),B({pubkey:r.marketBaseVault}),B({pubkey:r.marketQuoteVault}),B({pubkey:r.marketAuthority,isWritable:!1}),B({pubkey:e.tokenAccountIn}),B({pubkey:e.tokenAccountOut}),B({pubkey:e.owner,isWritable:!1,isSigner:!0})),new zn({programId:r.programId,keys:a,data:s})}function hd({poolKeys:o,userKeys:e,maxAmountIn:t,amountOut:n},i){let r=Ze(o),s=Buffer.alloc(ds.span);ds.encode({instruction:11,maxAmountIn:$(t),amountOut:$(n)},s);let a=[B({pubkey:Mi,isWritable:!1}),B({pubkey:r.id}),B({pubkey:r.authority,isWritable:!1}),B({pubkey:r.openOrders}),B({pubkey:r.targetOrders}),B({pubkey:r.vault.A}),B({pubkey:r.vault.B})];return i===5&&a.push(B({pubkey:Xn})),a.push(B({pubkey:r.marketProgramId,isWritable:!1}),B({pubkey:r.marketId}),B({pubkey:r.marketBids}),B({pubkey:r.marketAsks}),B({pubkey:r.marketEventQueue}),B({pubkey:r.marketBaseVault}),B({pubkey:r.marketQuoteVault}),B({pubkey:r.marketAuthority,isWritable:!1}),B({pubkey:e.tokenAccountIn}),B({pubkey:e.tokenAccountOut}),B({pubkey:e.owner,isWritable:!1,isSigner:!0})),new zn({programId:r.programId,keys:a,data:s})}function Do(o){let{poolKeys:e,version:t,userKeys:n,amountIn:i,amountOut:r,fixedSide:s}=o;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return kd(U(M({},a),{amountIn:i,minAmountOut:r}),t);if(s==="out")return hd(U(M({},a),{maxAmountIn:i,amountOut:r}),t);Mu.logWithError("invalid params","params",o)}throw Mu.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}import{PublicKey as Bd}from"@solana/web3.js";import tT from"bn.js";import{TOKEN_PROGRAM_ID as xd}from"@solana/spl-token";import{PublicKey as Td}from"@solana/web3.js";var Id=me("Raydium_liquidity_serum");function vu({programId:o,marketId:e}){let t=[e.toBuffer()],n=0,i;for(;n<100;){try{let r=t.concat(Buffer.from([n]),Buffer.alloc(7));i=Td.createProgramAddressSync(r,o)}catch(r){if(r instanceof TypeError)throw r;n++;continue}return{publicKey:i,nonce:n}}throw Id.logWithError("unable to find a viable program address nonce","params",{programId:o,marketId:e}),new Error("unable to find a viable program address nonce")}function Wo({programId:o}){let{publicKey:e}=de([Buffer.from("amm_config_account_seed","utf-8")],o);return e}function Rn({name:o,programId:e,marketId:t}){let{publicKey:n}=de([e.toBuffer(),t.toBuffer(),Buffer.from(o,"utf-8")],e);return n}function Sd({programId:o,marketId:e}){let{publicKey:t}=de([o.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],o);return t}function As({programId:o}){return de([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],o)}function Ps({version:o,marketVersion:e,marketId:t,baseMint:n,quoteMint:i,baseDecimals:r,quoteDecimals:s,programId:a,marketProgramId:c}){let u=Rn({name:"amm_associated_seed",programId:a,marketId:t}),l=Rn({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:m,nonce:d}=As({programId:a}),p=Rn({name:"coin_vault_associated_seed",programId:a,marketId:t}),f=Rn({name:"pc_vault_associated_seed",programId:a,marketId:t}),y=Rn({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),b=Sd({programId:a,marketId:t}),g=Rn({name:"target_associated_seed",programId:a,marketId:t}),w=Rn({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:A}=vu({programId:c,marketId:t});return{id:u,baseMint:n,quoteMint:i,lpMint:l,baseDecimals:r,quoteDecimals:s,lpDecimals:r,version:o,programId:a,authority:m,nonce:d,baseVault:p,quoteVault:f,lpVault:y,openOrders:b,targetOrders:g,withdrawQueue:w,marketVersion:e,marketProgramId:c,marketId:t,marketAuthority:A,lookupTableAccount:Bd.default,configId:Wo({programId:a})}}var ws={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},qo=o=>{let e={},t=xd.toBase58();return Object.keys(o).map(n=>{let i=o[n],[r,s]=[i.baseMint.toBase58(),i.quoteMint.toBase58()];e[n]={id:n,version:4,status:i.status.toNumber(),programId:i.programId.toBase58(),mintA:st({address:r,programId:t,decimals:i.baseDecimal.toNumber()}),mintB:st({address:s,programId:t,decimals:i.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:i.poolPrice.toNumber(),mintAmountA:new N(i.mintAAmount.toString()).div(10**i.baseDecimal.toNumber()).toNumber(),mintAmountB:new N(i.mintBAmount.toString()).div(10**i.quoteDecimal.toNumber()).toNumber(),baseReserve:i.baseReserve,quoteReserve:i.quoteReserve,feeRate:new N(i.tradeFeeNumerator.toString()).div(i.tradeFeeDenominator.toString()).toNumber(),openTime:i.poolOpenTime.toString(),tvl:0,day:ws,week:ws,month:ws,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:i.marketId.toBase58(),configId:Wo({programId:i.programId}).toBase58(),lpPrice:0,lpAmount:new N(i.lpReserve.toString()).div(10**Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())).toNumber(),lpMint:st({address:i.lpMint.toBase58(),programId:t,decimals:Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())}),burnPercent:0}}),e};import Ne from"bn.js";import{PublicKey as Ni}from"@solana/web3.js";import vi from"bn.js";import{TOKEN_PROGRAM_ID as Fu}from"@solana/spl-token";import{SystemProgram as Ln,SYSVAR_RENT_PUBKEY as Cd,Transaction as _u,TransactionInstruction as Rd}from"@solana/web3.js";import{createInitializeAccountInstruction as Vu,TOKEN_PROGRAM_ID as Eu}from"@solana/spl-token";function Kd(o="accountFlags"){let e=new So(o);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var ks=q([we(5),Kd("accountFlags"),O("ownAddress"),P("vaultSignerNonce"),O("baseMint"),O("quoteMint"),O("baseVault"),P("baseDepositsTotal"),P("baseFeesAccrued"),O("quoteVault"),P("quoteDepositsTotal"),P("quoteFeesAccrued"),P("quoteDustThreshold"),O("requestQueue"),O("eventQueue"),O("bids"),O("asks"),P("baseLotSize"),P("quoteLotSize"),P("feeRateBps"),P("referrerRebatesAccrued"),we(7)]);function Ld({programId:o,marketInfo:e}){let t=q([X("version"),ot("instruction"),P("baseLotSize"),P("quoteLotSize"),Yt("feeRateBps"),P("vaultSignerNonce"),P("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:Cd,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),i=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},i),new Rd({keys:n,programId:o,data:i})}async function Uo({connection:o,wallet:e,marketInfo:t}){var s,a,c,u,l,m,d,p;let n=new _u,i=await o.getMinimumBalanceForRentExemption(165);n.add(Ln.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:i,space:165,programId:Eu}),Ln.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:i,space:165,programId:Eu}),Vu(t.baseVault.publicKey,t.baseMint,t.vaultOwner),Vu(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner),Ln.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await o.getMinimumBalanceForRentExemption(ks.span),space:ks.span,programId:t.programId}));let r=new _u;return r.add(Ln.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:t.lowestFeeMarket?6208320:await o.getMinimumBalanceForRentExemption((s=t.requestQueueSpace)!=null?s:5120+12),space:t.lowestFeeMarket?764:(a=t.requestQueueSpace)!=null?a:5120+12,programId:t.programId}),Ln.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:t.lowestFeeMarket?79594560:await o.getMinimumBalanceForRentExemption((c=t.eventQueueSpace)!=null?c:262144+12),space:t.lowestFeeMarket?11308:(u=t.eventQueueSpace)!=null?u:262144+12,programId:t.programId}),Ln.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:t.lowestFeeMarket?101977920:await o.getMinimumBalanceForRentExemption((l=t.orderbookQueueSpace)!=null?l:65536+12),space:t.lowestFeeMarket?14524:(m=t.orderbookQueueSpace)!=null?m:65536+12,programId:t.programId}),Ln.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:t.lowestFeeMarket?101977920:await o.getMinimumBalanceForRentExemption((d=t.orderbookQueueSpace)!=null?d:65536+12),space:t.lowestFeeMarket?14524:(p=t.orderbookQueueSpace)!=null?p:65536+12,programId:t.programId}),Ld({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[W.CreateAccount,W.CreateAccount,W.InitAccount,W.InitAccount]},{transaction:r,signer:[],instructionTypes:[W.CreateAccount,W.CreateAccount,W.CreateAccount,W.CreateAccount,W.CreateAccount,W.InitMarket]}]}var Qn=class extends Le{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:i,dexProgramId:r,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u,assignSeed:l,txVersion:m,computeBudgetConfig:d,txTipConfig:p,feePayer:f}){let y=this.scope.ownerPubKey,b=l?`${e.mint.toBase58().slice(0,10)}-${t.mint.toBase58().slice(0,10)}-${l}`:void 0,g=Ve({fromPublicKey:y,programId:r,assignSeed:b&&`${b}-market`}),w=Ve({fromPublicKey:y,programId:r,assignSeed:b&&`${b}-request`}),A=Ve({fromPublicKey:y,programId:r,assignSeed:b&&`${b}-event`}),h=Ve({fromPublicKey:y,programId:r,assignSeed:b&&`${b}-bids`}),I=Ve({fromPublicKey:y,programId:r,assignSeed:b&&`${b}-asks`}),k=Ve({fromPublicKey:y,programId:Fu,assignSeed:b&&`${b}-baseVault`}),x=Ve({fromPublicKey:y,programId:Fu,assignSeed:b&&`${b}-quoteVault`}),S=0,K=new vi(100);function T(){let Z=new vi(0);for(;;)try{return{vaultOwner:Ni.createProgramAddressSync([g.publicKey.toBuffer(),Z.toArrayLike(Buffer,"le",8)],r),vaultSignerNonce:Z}}catch{if(Z.iaddn(1),Z.gt(new vi(25555)))throw Error("find vault owner error")}}let{vaultOwner:C,vaultSignerNonce:R}=T(),L=new vi(Math.round(10**e.decimals*n)),v=new vi(Math.round(n*10**t.decimals*i));if(L.eq(yt))throw Error("lot size is too small");if(v.eq(yt))throw Error("tick size or lot size is too small");let F=await Uo({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:r,id:g,baseMint:e.mint,quoteMint:t.mint,baseVault:k,quoteVault:x,vaultOwner:C,requestQueue:w,eventQueue:A,bids:h,asks:I,feeRateBps:S,quoteDustThreshold:K,vaultSignerNonce:R,baseLotSize:L,quoteLotSize:v,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u}}),_=this.createTxBuilder(f);_.addInstruction({instructions:F[0].transaction.instructions,signers:F[0].signer});for await(let Z of F.slice(1,F.length))_.addInstruction({instructions:Z.transaction.instructions,signers:Z.signer,instructionTypes:Z.instructionTypes});return m===0?_.sizeCheckBuildV0({computeBudgetConfig:d,address:{marketId:g.publicKey,requestQueue:w.publicKey,eventQueue:A.publicKey,bids:h.publicKey,asks:I.publicKey,baseVault:k.publicKey,quoteVault:x.publicKey,baseMint:new Ni(e.mint),quoteMint:new Ni(t.mint)}}):_.sizeCheckBuild({computeBudgetConfig:d,address:{marketId:g.publicKey,requestQueue:w.publicKey,eventQueue:A.publicKey,bids:h.publicKey,asks:I.publicKey,baseVault:k.publicKey,quoteVault:x.publicKey,baseMint:new Ni(e.mint),quoteMint:new Ni(t.mint)}})}};var _i=class extends Le{constructor(t){super(t);this.stableLayout=new Oi({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:t,amount:n,slippage:i,baseIn:r}){let s=new Ne(new N(n).mul(10**t[r?"mintA":"mintB"].decimals).toFixed(0)),a=Vo(t[r?"mintB":"mintA"]),[c,u]=[new Ne(new N(t.mintAmountA).mul(10**t.mintA.decimals).toString()),new Ne(new N(t.mintAmountB).mul(10**t.mintB.decimals).toString())],l=new Ne(new N(t.lpAmount).mul(10**t.lpMint.decimals).toFixed(0,N.ROUND_DOWN));this.logDebug("baseReserve:",c.toString(),"quoteReserve:",u.toString()),this.logDebug("tokenIn:",r?t.mintA.symbol:t.mintB.symbol,"amountIn:",s.toString(),"anotherToken:",r?t.mintB.symbol:t.mintA.symbol,"slippage:",`${i.toSignificant()}%`,"baseReserve",c.toString(),"quoteReserve",u.toString());let m=r?"base":"quote";this.logDebug("input side:",m);let d=yt;s.isZero()||(d=m==="base"?so(s.mul(u),c):so(s.mul(c),u)),this.logDebug("amountRaw:",d.toString(),"lpAmount:",l.toString());let p=so(s.mul(l),m==="base"?c:u);this.logDebug("liquidity:",p.toString());let f=new Qe(new Ne(1)).add(i),y=new Qe(new Ne(1)).sub(i),b=f.mul(d).quotient,g=y.mul(d).quotient,w=new Ae(a,d),A=new Ae(a,b),h=new Ae(a,g);return this.logDebug("anotherAmount:",w.toFixed(),"maxAnotherAmount:",A.toFixed()),{anotherAmount:w,maxAnotherAmount:A,minAnotherAmount:h,liquidity:p}}async getAmmPoolKeys(t){return(await this.scope.api.fetchPoolKeysById({idList:[t]}))[0]}async addLiquidity(t){let{poolInfo:n,poolKeys:i,amountInA:r,amountInB:s,otherAmountMin:a,fixedSide:c,config:u,txVersion:l,computeBudgetConfig:m,txTipConfig:d,feePayer:p}=t;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",r,"amountInB:",s),(r.isZero()||s.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:r.toFixed(),amountInB:s.toFixed()});let{account:f}=this.scope,{bypassAssociatedCheck:y,checkCreateATAOwner:b}=M({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},u),[g,w]=[r.token,s.token],A=await f.getCreatedTokenAccount({mint:g.mint,associatedOnly:!1}),h=await f.getCreatedTokenAccount({mint:w.mint,associatedOnly:!1});!A&&!h&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",f.tokenAccounts);let I=await f.getCreatedTokenAccount({mint:new qe(n.lpMint.address)}),k=[g,w],x=[A,h],S=[r.raw,s.raw],K=r.token.mint.toBase58()===n.mintA.address?"base":"quote",T="base";["quote","base"].includes(K)||this.logAndCreateError("invalid fixedSide","fixedSide",c),K==="quote"?(k.reverse(),x.reverse(),S.reverse(),T=c==="a"?"quote":"base"):K==="base"&&(T=c==="a"?"base":"quote");let[C,R]=k,[L,v]=x,[F,_]=S,Z=i!=null?i:await this.getAmmPoolKeys(n.id),ce=this.createTxBuilder(p),ht=await f.handleTokenAccount({side:"in",amount:F,mint:C.mint,tokenAccount:L,bypassAssociatedCheck:y,checkCreateATAOwner:b}),{tokenAccount:ve}=ht,Je=We(ht,["tokenAccount"]);ce.addInstruction(Je);let Tt=await f.handleTokenAccount({side:"in",amount:_,mint:R.mint,tokenAccount:v,bypassAssociatedCheck:y,checkCreateATAOwner:b}),{tokenAccount:ge}=Tt,_e=We(Tt,["tokenAccount"]);ce.addInstruction(_e);let dt=await f.handleTokenAccount({side:"out",amount:0,mint:new qe(n.lpMint.address),tokenAccount:I,bypassAssociatedCheck:y,checkCreateATAOwner:b}),{tokenAccount:ut}=dt,Dt=We(dt,["tokenAccount"]);return ce.addInstruction(Dt),ce.addInstruction({instructions:[Nu({poolInfo:n,poolKeys:Z,userKeys:{baseTokenAccount:ve,quoteTokenAccount:ge,lpTokenAccount:ut,owner:this.scope.ownerPubKey},baseAmountIn:F,quoteAmountIn:_,otherAmountMin:a.raw,fixedSide:T})],instructionTypes:[n.pooltype.includes("StablePool")?W.AmmV5AddLiquidity:W.AmmV4AddLiquidity],lookupTableAddress:Z.lookupTableAccount?[Z.lookupTableAccount]:[]}),ce.addCustomComputeBudget(m),ce.addTipInstruction(d),l===0?await ce.buildV0():ce.build()}async removeLiquidity(t){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:n,poolKeys:i,lpAmount:r,baseAmountMin:s,quoteAmountMin:a,config:c,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}=t,p=i!=null?i:await this.getAmmPoolKeys(n.id),[f,y,b]=[new qe(n.mintA.address),new qe(n.mintB.address),new qe(n.lpMint.address)];this.logDebug("lpAmount:",r),this.logDebug("baseAmountMin:",s),this.logDebug("quoteAmountMin:",a),r.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",r.toString());let{account:g}=this.scope,w=await g.getCreatedTokenAccount({mint:b,associatedOnly:!1});w||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",g.tokenAccounts);let A=await g.getCreatedTokenAccount({mint:f}),h=await g.getCreatedTokenAccount({mint:y}),I=this.createTxBuilder(d),{bypassAssociatedCheck:k,checkCreateATAOwner:x}=M({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},c),R=await g.handleTokenAccount({side:"out",amount:0,mint:f,tokenAccount:A,bypassAssociatedCheck:k,checkCreateATAOwner:x}),{tokenAccount:S}=R,K=We(R,["tokenAccount"]);I.addInstruction(K);let L=await g.handleTokenAccount({side:"out",amount:0,mint:y,tokenAccount:h,bypassAssociatedCheck:k,checkCreateATAOwner:x}),{tokenAccount:T}=L,C=We(L,["tokenAccount"]);return I.addInstruction(C),I.addInstruction({instructions:[bs({poolInfo:n,poolKeys:p,userKeys:{lpTokenAccount:w,baseTokenAccount:S,quoteTokenAccount:T,owner:this.scope.ownerPubKey},lpAmount:r,baseAmountMin:s,quoteAmountMin:a})],lookupTableAddress:p.lookupTableAccount?[p.lookupTableAccount]:[],instructionTypes:[n.pooltype.includes("StablePool")?W.AmmV5RemoveLiquidity:W.AmmV4RemoveLiquidity]}),I.addCustomComputeBudget(l),I.addTipInstruction(m),u===0?await I.buildV0():I.build()}async removeAllLpAndCreateClmmPosition({poolInfo:t,clmmPoolInfo:n,removeLpAmount:i,createPositionInfo:r,farmInfo:s,userFarmLpAmount:a,base:c,computeBudgetConfig:u,payer:l,userAuxiliaryLedgers:m,tokenProgram:d=bn,checkCreateATAOwner:p=!0,getEphemeralSigners:f,txVersion:y,feePayer:b}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(t.mintA.address===n.mintA.address||t.mintA.address===n.mintB.address)||!(t.mintB.address===n.mintA.address||t.mintB.address===n.mintB.address))throw Error("mint check error");let g=this.createTxBuilder(b),w={};for(let Z of this.scope.account.tokenAccountRawInfos)(w[Z.accountInfo.mint.toString()]===void 0||oe(this.scope.ownerPubKey,Z.accountInfo.mint,bn).publicKey.equals(Z.pubkey))&&(w[Z.accountInfo.mint.toString()]=Z.pubkey);let A=w[t.lpMint.address];if(A===void 0)throw Error("find lp account error in trade accounts");let h=i.add(a!=null?a:new Ne(0)),I=t.mintA.address===Ce.WSOL.mint.toString(),k=t.mintB.address===Ce.WSOL.mint.toString(),{account:x,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:bn,mint:new qe(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:I?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:!0,checkCreateATAOwner:p});if(g.addInstruction(S||{}),x===void 0)throw new Error("base token account not found");let{account:K,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:bn,mint:new qe(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:!0,checkCreateATAOwner:p});if(g.addInstruction(T||{}),K===void 0)throw new Error("quote token account not found");if(w[t.mintA.address]=x,w[t.mintB.address]=K,s!==void 0&&!(a!=null&&a.isZero())){let Z=It[s.programId],ce=Bt({programId:new qe(s.programId),poolId:new qe(s.id),owner:this.scope.ownerPubKey,version:Z}),ve,Je=await this.scope.connection.getAccountInfo(ce);if(Je&&(ve=yi(Z).decode(Je.data)),Z!==6&&!ve){let{instruction:dt,instructionType:nn}=gi({id:new qe(s.id),programId:new qe(s.programId),version:Z,ledger:ce,owner:this.scope.ownerPubKey});g.addInstruction({instructions:[dt],instructionTypes:[nn]})}let ge=[];for(let dt of s.rewardInfos){let nn=dt.mint.address===Ce.WSOL.mint.toString();if(w[dt.mint.address])ge.push(w[dt.mint.address]);else{let{account:Zn,instructionParams:An}=await this.scope.account.getOrCreateTokenAccount({mint:new qe(dt.mint.address),tokenProgram:d,owner:this.scope.ownerPubKey,skipCloseAccount:!nn,createInfo:{payer:l||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:p});Zn||this.logAndCreateError("farm reward account not found:",dt.mint.address),An&&g.addInstruction(An),ge.push(Zn)}}let _e=(await this.scope.api.fetchFarmKeysById({ids:s.id}))[0],ut={userAuxiliaryLedgers:m,amount:a,owner:this.scope.ownerPubKey,farmInfo:s,farmKeys:_e,lpAccount:A,rewardAccounts:ge},Dt=It[s.programId],ht=Dt===6?wi(ut):Dt===5?Ai(ut):Pi(ut),Tt={3:W.FarmV3Withdraw,5:W.FarmV5Withdraw,6:W.FarmV6Withdraw};g.addInstruction({instructions:[ht],instructionTypes:[Tt[Dt]]})}let C=await this.getAmmPoolKeys(t.id),R=bs({poolInfo:t,poolKeys:C,userKeys:{lpTokenAccount:A,baseTokenAccount:x,quoteTokenAccount:K,owner:this.scope.ownerPubKey},lpAmount:h,baseAmountMin:0,quoteAmountMin:0});g.addInstruction({instructions:[R],instructionTypes:[t.pooltype.includes("StablePool")?W.AmmV5RemoveLiquidity:W.AmmV4RemoveLiquidity],lookupTableAddress:C.lookupTableAccount?[C.lookupTableAccount]:[]});let[L,v]=t.mintA.address===n.mintA.address?[x,K]:[K,x],F=await this.scope.clmm.getClmmPoolKeys(n.id),_=await Te.openPositionFromBaseInstructions(U(M({poolInfo:n,poolKeys:F,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:L,tokenAccountB:v},withMetadata:"create"},r),{base:c,getEphemeralSigners:f}));return g.addInstruction({instructions:[..._.instructions],signers:_.signers,instructionTypes:[..._.instructionTypes],lookupTableAddress:F.lookupTableAccount?[F.lookupTableAccount]:[]}),y===0?g.sizeCheckBuildV0({computeBudgetConfig:u}):g.sizeCheckBuild({computeBudgetConfig:u})}async createPoolV4({programId:t,marketInfo:n,baseMintInfo:i,quoteMintInfo:r,baseAmount:s,quoteAmount:a,startTime:c,ownerInfo:u,associatedOnly:l=!1,checkCreateATAOwner:m=!1,tokenProgram:d,txVersion:p,feeDestinationId:f,computeBudgetConfig:y,txTipConfig:b,feePayer:g}){var v;let w=u.feePayer||((v=this.scope.owner)==null?void 0:v.publicKey),A=u.useSOLBalance&&i.mint.equals(Go),h=u.useSOLBalance&&r.mint.equals(Go),I=this.createTxBuilder(g),{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:A?{payer:w,amount:s}:void 0,notUseTokenAccount:A,skipCloseAccount:!A,associatedOnly:A?!1:l,checkCreateATAOwner:m});I.addInstruction(x||{});let{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:r.mint,owner:this.scope.ownerPubKey,createInfo:h?{payer:w,amount:a}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:l,checkCreateATAOwner:m});if(I.addInstruction(K||{}),k===void 0||S===void 0)throw Error("you don't has some token account");let T=Ps({version:4,marketVersion:3,marketId:n.marketId,baseMint:i.mint,quoteMint:r.mint,baseDecimals:i.decimals,quoteDecimals:r.decimals,programId:t,marketProgramId:n.programId}),C={programId:t,ammId:T.id,ammAuthority:T.authority,ammOpenOrders:T.openOrders,lpMint:T.lpMint,coinMint:T.baseMint,pcMint:T.quoteMint,coinVault:T.baseVault,pcVault:T.quoteVault,withdrawQueue:T.withdrawQueue,ammTargetOrders:T.targetOrders,poolTempLp:T.lpVault,marketProgramId:T.marketProgramId,marketId:T.marketId,ammConfigId:T.configId,feeDestinationId:f},{instruction:R,instructionType:L}=gs(U(M({},C),{userWallet:this.scope.ownerPubKey,userCoinVault:k,userPcVault:S,userLpVault:oe(this.scope.ownerPubKey,T.lpMint,d).publicKey,nonce:T.nonce,openTime:c,coinAmount:s,pcAmount:a}));return I.addInstruction({instructions:[R],instructionTypes:[L]}),I.addCustomComputeBudget(y),I.addTipInstruction(b),I.versionBuild({txVersion:p,extInfo:{address:C}})}async createMarketAndPoolV4({programId:t=co,marketProgram:n=wa,feeDestinationId:i=Pa,tokenProgram:r,baseMintInfo:s,quoteMintInfo:a,baseAmount:c,quoteAmount:u,startTime:l,ownerInfo:m,lowestFeeMarket:d,assignSeed:p,associatedOnly:f=!1,checkCreateATAOwner:y=!1,lotSize:b=1,tickSize:g=.01,txVersion:w,computeBudgetConfig:A,txTipConfig:h,feePayer:I}){var Os,Ms,Ns;let k=this.scope.ownerPubKey,x=m.feePayer||((Os=this.scope.owner)==null?void 0:Os.publicKey),S=m.useSOLBalance&&s.mint.equals(Go),K=m.useSOLBalance&&a.mint.equals(Go),T=p?`${s.mint.toBase58().slice(0,7)}-${a.mint.toBase58().slice(0,7)}-${p}`:void 0,C=Ve({fromPublicKey:k,programId:n,assignSeed:T&&`${T}-market`}),R=Ve({fromPublicKey:k,programId:n,assignSeed:T&&`${T}-request`}),L=Ve({fromPublicKey:k,programId:n,assignSeed:T&&`${T}-event`}),v=Ve({fromPublicKey:k,programId:n,assignSeed:T&&`${T}-bids`}),F=Ve({fromPublicKey:k,programId:n,assignSeed:T&&`${T}-asks`}),_=Ve({fromPublicKey:k,programId:bn,assignSeed:T&&`${T}-baseVault`}),Z=Ve({fromPublicKey:k,programId:bn,assignSeed:T&&`${T}-quoteVault`}),ce=0,ve=new Ne(100);function Je(){let Wt=new Ne(0);for(;;)try{return{vaultOwner:qe.createProgramAddressSync([C.publicKey.toBuffer(),Wt.toArrayLike(Buffer,"le",8)],n),vaultSignerNonce:Wt}}catch{if(Wt.iaddn(1),Wt.gt(new Ne(25555)))throw Error("find vault owner error")}}let{vaultOwner:ge,vaultSignerNonce:_e}=Je(),ut=new Ne(Math.round(10**s.decimals*b)),Dt=new Ne(Math.round(b*10**a.decimals*g));if(ut.eq(yt))throw Error("lot size is too small");if(Dt.eq(yt))throw Error("tick size or lot size is too small");let ht=await Uo({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:n,vaultOwner:ge,baseMint:s.mint,quoteMint:a.mint,id:C,baseVault:_,quoteVault:Z,requestQueue:R,eventQueue:L,bids:v,asks:F,feeRateBps:ce,quoteDustThreshold:ve,vaultSignerNonce:_e,baseLotSize:ut,quoteLotSize:Dt,lowestFeeMarket:d}}),Tt=this.createTxBuilder(I);Tt.addInstruction({instructions:ht[0].transaction.instructions,signers:ht[0].signer});for await(let Wt of ht.slice(1,ht.length))Tt.addInstruction({instructions:Wt.transaction.instructions,signers:Wt.signer,instructionTypes:Wt.instructionTypes});let{account:dt,instructionParams:nn}=await this.scope.account.getOrCreateTokenAccount({mint:s.mint,owner:this.scope.ownerPubKey,createInfo:S?{payer:x,amount:c}:void 0,notUseTokenAccount:S,skipCloseAccount:!S,associatedOnly:S?!1:f,checkCreateATAOwner:y,assignSeed:S&&T?`${T}-wsol`:void 0});Tt.addInstruction(nn||{});let{account:Zn,instructionParams:An}=await this.scope.account.getOrCreateTokenAccount({mint:a.mint,owner:this.scope.ownerPubKey,createInfo:K?{payer:x,amount:u}:void 0,notUseTokenAccount:K,skipCloseAccount:!K,associatedOnly:K?!1:f,checkCreateATAOwner:y,assignSeed:K&&T?`${T}-wsol`:void 0});if(Tt.addInstruction(An||{}),dt===void 0)throw Error("you don't has base token account");if(Zn===void 0)throw Error("you don't has quote token account");let et=Ps({version:4,marketVersion:3,marketId:C.publicKey,baseMint:s.mint,quoteMint:a.mint,baseDecimals:s.decimals,quoteDecimals:a.decimals,programId:t,marketProgramId:n}),sr={programId:t,ammId:et.id,ammAuthority:et.authority,ammOpenOrders:et.openOrders,lpMint:et.lpMint,coinMint:et.baseMint,pcMint:et.quoteMint,coinVault:et.baseVault,pcVault:et.quoteVault,withdrawQueue:et.withdrawQueue,ammTargetOrders:et.targetOrders,poolTempLp:et.lpVault,marketProgramId:et.marketProgramId,marketId:et.marketId,ammConfigId:et.configId,feeDestinationId:i},{instruction:cc,instructionType:lc}=gs(U(M({},sr),{userWallet:this.scope.ownerPubKey,userCoinVault:dt,userPcVault:Zn,userLpVault:oe(this.scope.ownerPubKey,et.lpMint,r).publicKey,nonce:et.nonce,openTime:l,coinAmount:c,pcAmount:u}));Tt.addInstruction({instructions:[cc],instructionTypes:[lc]});let Ls=S||K?[((Ms=nn==null?void 0:nn.instructions)==null?void 0:Ms[0])||((Ns=An==null?void 0:An.instructions)==null?void 0:Ns[0])].filter(Wt=>!!Wt):void 0;return w===0?Tt.sizeCheckBuildV0({computeBudgetConfig:A,splitIns:Ls,address:M({requestQueue:R.publicKey,eventQueue:L.publicKey,bids:v.publicKey,asks:F.publicKey,baseVault:_.publicKey,quoteVault:Z.publicKey,baseMint:new qe(s.mint),quoteMint:new qe(a.mint)},sr)}):Tt.sizeCheckBuild({computeBudgetConfig:A,splitIns:Ls,address:M({requestQueue:R.publicKey,eventQueue:L.publicKey,bids:v.publicKey,asks:F.publicKey,baseVault:_.publicKey,quoteVault:Z.publicKey,baseMint:new qe(s.mint),quoteMint:new qe(a.mint)},sr)})}async getCreatePoolFee({programId:t}){let n=Wo({programId:t}),i=await this.scope.connection.getAccountInfo(n,{dataSlice:{offset:536,length:8}});if(i===null)throw Error("get config account error");return Su.decode(i.data).fee}computeAmountOut({poolInfo:t,amountIn:n,mintIn:i,mintOut:r,slippage:s}){let[a,c]=[i.toString(),r.toString()];if(a!==t.mintA.address&&a!==t.mintB.address)throw new Error("toke not match");if(c!==t.mintA.address&&c!==t.mintB.address)throw new Error("toke not match");let{baseReserve:u,quoteReserve:l}=t,m=[u,l],d=[t.mintA.decimals,t.mintB.decimals],p=a==t.mintA.address?"base":"quote";p==="quote"&&(m.reverse(),d.reverse());let[f,y]=m,[b,g]=d,w=t.version===4,A;if(w)A=new N(y.toString()).div(10**g).div(new N(f.toString()).div(10**b));else{let L=Ou(this.stableLayout.stableModelData,u.toNumber(),l.toNumber(),!1);p==="quote"?A=new N(1e6).div(L*1e6):A=new N(L*1e6).div(1e6)}let h=n,I=new Ne(0),k=new Ne(0);if(!h.isZero())if(w){k=ln(h.mul(ls),Eo);let L=h.sub(k),v=f.add(L);I=y.mul(L).div(v)}else{k=h.mul(new Ne(2)).div(new Ne(1e4));let L=h.sub(k);p==="quote"?I=new Ne(Ru(this.stableLayout.stableModelData,l.toNumber(),u.toNumber(),L.toNumber())):I=new Ne(Lu(this.stableLayout.stableModelData,l.toNumber(),u.toNumber(),L.toNumber()))}let x=new Ne(new N(I.toString()).mul(1-s).toFixed(0)),S=I,K=x,T=new N(I.toString()).div(new N(h.sub(k).toString()).toFixed(0));!h.isZero()&&!I.isZero()&&(T=new N(I.toString()).div(10**g).div(new N(h.sub(k).toString()).div(10**b)));let C=A.sub(T).div(A).mul(100);return{amountOut:S,minAmountOut:K,currentPrice:A,executionPrice:T,priceImpact:C,fee:k}}computeAmountIn({poolInfo:t,amountOut:n,mintIn:i,mintOut:r,slippage:s}){let{baseReserve:a,quoteReserve:c}=t;i.toString()!==t.mintA.address&&i.toString()!==t.mintB.address&&this.logAndCreateError("mintIn does not match pool"),r.toString()!==t.mintA.address&&r.toString()!==t.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",a.toString()),this.logDebug("quoteReserve:",c.toString());let u=i.toString()===t.mintA.address,[l,m]=u?[t.mintA,t.mintB]:[t.mintB,t.mintA];this.logDebug("currencyOut:",m.symbol||m.address),this.logDebug("amountOut:",new N(n.toString()).div(10**m.decimals).toDecimalPlaces(m.decimals).toString(),l.symbol||l.address),this.logDebug("slippage:",`${s*100}%`);let d=[a,c],p=u?"quote":"base";p==="base"&&d.reverse(),this.logDebug("output side:",p);let[f,y]=d,b=new N(y.toString()).div(10**t[u?"mintB":"mintA"].decimals).div(new N(f.toString()).div(10**t[u?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${l.symbol||l.address} \u2248 ${b.toString()} ${m.symbol||m.address}`),this.logDebug("currentPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new N(1).div(b).toString()} ${l.symbol||l.address}`);let g=new Ne(0),w=n;if(!w.isZero()){w.gt(y)&&(w=y.sub(new Ne(1)));let K=y.sub(w);g=f.mul(w).div(K).mul(Eo).div(Eo.sub(ls))}let A=new Ne(new N(g.toString()).mul(1+s).toFixed(0)),h=g,I=A;this.logDebug("amountIn:",new N(h.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString()),this.logDebug("maxAmountIn:",new N(I.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString());let k=null;!g.isZero()&&!w.isZero()&&(k=new N(w.toString()).div(10**m.decimals).div(new N(g.toString()).div(10**l.decimals)),this.logDebug("executionPrice:",`1 ${m.symbol||m.address} \u2248 ${k.toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`),this.logDebug("executionPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new N(1).div(k).toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`));let x=b.mul(h.toString()),S=x.sub(n.toString()).abs().div(x);return this.logDebug("priceImpact:",`${S.toString()}%`),{amountIn:h,maxAmountIn:I,currentPrice:b,executionPrice:k,priceImpact:S}}async swap({poolInfo:t,poolKeys:n,amountIn:i,amountOut:r,inputMint:s,fixedSide:a,txVersion:c,config:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}){let p=this.createTxBuilder(d),{associatedOnly:f=!0,inputUseSolBalance:y=!0,outputUseSolBalance:b=!0}=u||{},[g,w]=s===t.mintA.address?[t.mintA,t.mintB]:[t.mintB,t.mintA],A=y&&g.address===j.toBase58(),h=b&&w.address===j.toBase58(),{account:I,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:bn,mint:new qe(g.address),owner:this.scope.ownerPubKey,createInfo:A?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:f});p.addInstruction(k||{}),I||this.logAndCreateError("input token account not found",{token:g.symbol||g.address,tokenAccountIn:I,inputTokenUseSolBalance:A,associatedOnly:f});let{account:x,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:bn,mint:new qe(w.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:f});p.addInstruction(S||{}),x===void 0&&this.logAndCreateError("output token account not found",{token:w.symbol||w.address,tokenAccountOut:x,outputTokenUseSolBalance:h,associatedOnly:f});let K=n||await this.getAmmPoolKeys(t.id),T=4;return t.pooltype.includes("StablePool")&&(T=5),p.addInstruction({instructions:[Do({version:T,poolKeys:K,userKeys:{tokenAccountIn:I,tokenAccountOut:x,owner:this.scope.ownerPubKey},amountIn:i,amountOut:r,fixedSide:a})],instructionTypes:[T===4?W.AmmV4SwapBaseIn:W.AmmV5SwapBaseIn]}),p.addCustomComputeBudget(l),p.addTipInstruction(m),p.versionBuild({txVersion:c})}async getRpcPoolInfo(t){return(await this.getRpcPoolInfos([t]))[t]}async getRpcPoolInfos(t,n){let i=await Ue(this.scope.connection,t.map(l=>({pubkey:new qe(l)})),n),r={},s=[];for(let l=0;l<t.length;l++){let m=i[l];if(m===null||!m.accountInfo)throw Error("fetch pool info error: "+String(t[l]));let d=Fo.decode(m.accountInfo.data);r[String(t[l])]=U(M({},d),{programId:m.accountInfo.owner}),s.push(d.baseVault,d.quoteVault)}let a={},c=await Ue(this.scope.connection,s.map(l=>({pubkey:new qe(l)})),n);for(let l=0;l<s.length;l++){let m=c[l].accountInfo;if(m===null)throw Error("fetch vault info error: "+s[l]);a[String(s[l])]=new Ne(Od.decode(m.data).amount.toString())}let u={};for(let[l,m]of Object.entries(r)){let d=a[m.baseVault.toString()].sub(m.baseNeedTakePnl),p=a[m.quoteVault.toString()].sub(m.quoteNeedTakePnl);u[l]=U(M({},m),{baseReserve:d,mintAAmount:a[m.baseVault.toString()],mintBAmount:a[m.quoteVault.toString()],quoteReserve:p,poolPrice:new N(p.toString()).div(new N(10).pow(m.quoteDecimal.toString())).div(new N(d.toString()).div(new N(10).pow(m.baseDecimal.toString())))})}return u}async getPoolInfoFromRpc({poolId:t}){let n=await this.getRpcPoolInfo(t),i=qo({[t]:n}),r=i[t],s=await this.scope.tradeV2.computePoolToPoolKeys({pools:[i[t]],ammRpcData:{[t]:n}});return{poolRpcData:n,poolInfo:r,poolKeys:s[0]}}};import{PublicKey as Q}from"@solana/web3.js";import bt from"bn.js";import{AccountLayout as Du,TOKEN_2022_PROGRAM_ID as gn,TOKEN_PROGRAM_ID as Vi}from"@solana/spl-token";var Ei=class extends Le{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){var x;let{programId:t,owner:n=((x=this.scope.owner)==null?void 0:x.publicKey)||Q.default,mint1:i,mint2:r,ammConfig:s,initialPrice:a,computeBudgetConfig:c,forerunCreate:u,getObserveState:l,txVersion:m,txTipConfig:d,feePayer:p}=e,f=this.createTxBuilder(p),[y,b,g]=new bt(new Q(i.address).toBuffer()).gt(new bt(new Q(r.address).toBuffer()))?[r,i,new N(1).div(a)]:[i,r,a],w=ie.priceToSqrtPriceX64(g,y.decimals,b.decimals),A=[],h=[];y.programId===gn.toBase58()&&h.push(rs(t,new Q(y.address)).publicKey),b.programId===gn.toBase58()&&h.push(rs(t,new Q(b.address)).publicKey),(await this.scope.connection.getMultipleAccountsInfo(h)).forEach((S,K)=>{S&&A.push(h[K])});let k=await Te.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:y,mintB:b,ammConfigId:s.id,initialPriceX64:w,forerunCreate:!l&&u,extendMintAccount:A});return f.addInstruction(k),f.addCustomComputeBudget(c),f.addTipInstruction(d),f.versionBuild({txVersion:m,extInfo:{address:U(M({},k.address),{observationId:k.address.observationId.toBase58(),exBitmapAccount:k.address.exBitmapAccount.toBase58(),programId:t.toString(),id:k.address.poolId.toString(),mintA:y,mintB:b,openTime:"0",vault:{A:k.address.mintAVault.toString(),B:k.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}}),mockPoolInfo:M({type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:k.address.poolId.toString(),mintA:y,mintB:b,feeRate:s.tradeFeeRate,openTime:"0",programId:t.toString(),price:g.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},burnPercent:0},cu),forerunCreate:u}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,nft2022:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,withMetadata:d="create",getEphemeralSigners:p,computeBudgetConfig:f,txTipConfig:y,txVersion:b,feePayer:g}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let w=this.createTxBuilder(g),A=null,h=null,I=n.useSOLBalance&&e.mintA.address===j.toString(),k=n.useSOLBalance&&e.mintB.address===j.toString(),[x,S]=s==="MintA"?[a,c]:[c,a],{account:K,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Q(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:I||x.isZero()?{payer:this.scope.ownerPubKey,amount:x}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:I?!1:l,checkCreateATAOwner:m});K&&(A=K),w.addInstruction(T||{});let{account:C,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Q(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||S.isZero()?{payer:this.scope.ownerPubKey,amount:S}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:k?!1:l,checkCreateATAOwner:m});C&&(h=C),w.addInstruction(R||{}),(!A||!h)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:A==null?void 0:A.toBase58(),ownerTokenAccountB:h==null?void 0:h.toBase58()});let L=t||await this.getClmmPoolKeys(e.id),v=await Te.openPositionFromBaseInstructions({poolInfo:e,poolKeys:L,ownerInfo:U(M({},n),{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:A,tokenAccountB:h}),tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,withMetadata:d,getEphemeralSigners:p,nft2022:u});return w.addInstruction(v),w.addCustomComputeBudget(f),w.addTipInstruction(y),w.versionBuild({txVersion:b,extInfo:M({},v.address)})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:i,amountMaxB:r,tickLower:s,tickUpper:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:d,computeBudgetConfig:p,txTipConfig:f,getEphemeralSigners:y,nft2022:b,feePayer:g}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let w=this.createTxBuilder(g),A=null,h=null,I=n.useSOLBalance&&e.mintA.address===j.toBase58(),k=n.useSOLBalance&&e.mintB.address===j.toBase58(),{account:x,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Q(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:I||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:I?!1:u,checkCreateATAOwner:l});x&&(A=x),w.addInstruction(S||{});let{account:K,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Q(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:k?!1:u,checkCreateATAOwner:l});K&&(h=K),w.addInstruction(T||{}),(A===void 0||h===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let C=t||await this.getClmmPoolKeys(e.id),R=await Te.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:C,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:A,tokenAccountB:h},tickLower:s,tickUpper:a,liquidity:c,amountMaxA:i,amountMaxB:r,withMetadata:m,getEphemeralSigners:y,nft2022:b});return w.addInstruction(R),w.addCustomComputeBudget(p),w.addTipInstruction(f),w.versionBuild({txVersion:d,extInfo:{address:R.address}})}async increasePositionFromLiquidity(e){var T;let{poolInfo:t,poolKeys:n,ownerPosition:i,amountMaxA:r,amountMaxB:s,liquidity:a,ownerInfo:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txTipConfig:d,txVersion:p,feePayer:f}=e,y=this.createTxBuilder(f),b,g,w=c.useSOLBalance&&t.mintA.address===j.toString(),A=c.useSOLBalance&&t.mintB.address===j.toString(),{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:w||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!w,associatedOnly:w?!1:u,checkCreateATAOwner:l});h&&(b=h),y.addInstruction(I||{});let{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:A||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:A,skipCloseAccount:!A,associatedOnly:A?!1:u,checkCreateATAOwner:l});k&&(g=k),y.addInstruction(x||{}),!b&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let S=n!=null?n:await this.getClmmPoolKeys(t.id),K=Te.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:S,ownerPosition:i,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g},liquidity:a,amountMaxA:r,amountMaxB:s,nft2022:(T=await this.scope.connection.getAccountInfo(i.nftMint))==null?void 0:T.owner.equals(gn)});return y.addInstruction(K),y.addCustomComputeBudget(m),y.addTipInstruction(d),y.versionBuild({txVersion:p,extInfo:{address:K.address}})}async increasePositionFromBase(e){var K;let{poolInfo:t,ownerPosition:n,base:i,baseAmount:r,otherAmountMax:s,ownerInfo:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,f=this.createTxBuilder(p),y,b,g=a.useSOLBalance&&t.mintA.address===j.toString(),w=a.useSOLBalance&&t.mintB.address===j.toString(),{account:A,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:g||(i==="MintA"?r:s).isZero()?{payer:this.scope.ownerPubKey,amount:i==="MintA"?r:s}:void 0,skipCloseAccount:!g,associatedOnly:g?!1:c,checkCreateATAOwner:u});A&&(y=A),f.addInstruction(h||{});let{account:I,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||(i==="MintA"?s:r).isZero()?{payer:this.scope.ownerPubKey,amount:i==="MintA"?s:r}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:c,checkCreateATAOwner:u});I&&(b=I),f.addInstruction(k||{}),!y&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let x=await this.getClmmPoolKeys(t.id),S=Te.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:x,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:y,tokenAccountB:b},base:i,baseAmount:r,otherAmountMax:s,nft2022:(K=await this.scope.connection.getAccountInfo(n.nftMint))==null?void 0:K.owner.equals(gn)});return f.addInstruction(S),f.addCustomComputeBudget(l),f.addTipInstruction(m),f.versionBuild({txVersion:d,extInfo:{address:S.address}})}async decreaseLiquidity(e){var L;let{poolInfo:t,poolKeys:n,ownerPosition:i,ownerInfo:r,amountMinA:s,amountMinB:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txTipConfig:d,txVersion:p,feePayer:f}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let y=this.createTxBuilder(f),b=r.useSOLBalance&&t.mintA.address===j.toString(),g=r.useSOLBalance&&t.mintB.address===j.toString(),w,A,{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:l});w=h,I&&y.addInstruction(I);let{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!g,associatedOnly:g?!1:u,checkCreateATAOwner:l});A=k,x&&y.addInstruction(x);let S=[];for(let v of t.rewardDefaultInfos){let F=r.useSOLBalance&&v.mint.address===j.toString(),_;if(v.mint.address===t.mintA.address)_=w;else if(v.mint.address===t.mintB.address)_=A;else{let{account:Z,instructionParams:ce}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(v.mint.programId),mint:new Q(v.mint.address),notUseTokenAccount:F,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!F,associatedOnly:F?!1:u,checkCreateATAOwner:l});_=Z,ce&&y.addInstruction(ce)}S.push(_)}!w&&!A&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let K=n!=null?n:await this.getClmmPoolKeys(t.id),T=(L=await this.scope.connection.getAccountInfo(i.nftMint))==null?void 0:L.owner.equals(gn),C=await Te.decreaseLiquidityInstructions({poolInfo:t,poolKeys:K,ownerPosition:i,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:A,rewardAccounts:S},liquidity:c,amountMinA:s,amountMinB:a,nft2022:T});y.addInstruction({instructions:C.instructions,instructionTypes:[W.ClmmDecreasePosition]});let R=M({},C.address);if(r.closePosition){let v=await Te.closePositionInstructions({poolInfo:t,poolKeys:K,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:i,nft2022:T});y.addInstruction({endInstructions:v.instructions,endInstructionTypes:v.instructionTypes}),R=M(M({},R),v.address)}return y.addCustomComputeBudget(m),y.addTipInstruction(d),y.versionBuild({txVersion:p,extInfo:{address:R}})}async lockPosition(e){var f;let{programId:t=si,authProgramId:n=lo,poolProgramId:i=kn,ownerPosition:r,payer:s,computeBudgetConfig:a,txTipConfig:c,txVersion:u,getEphemeralSigners:l,feePayer:m}=e,d=this.createTxBuilder(m),p=await Te.makeLockPositions({programId:t,authProgramId:n,poolProgramId:i,wallet:this.scope.ownerPubKey,payer:s!=null?s:this.scope.ownerPubKey,nftMint:r.nftMint,getEphemeralSigners:l,nft2022:(f=await this.scope.connection.getAccountInfo(r.nftMint))==null?void 0:f.owner.equals(gn)});return d.addInstruction(p),d.addCustomComputeBudget(a),d.addTipInstruction(c),d.versionBuild({txVersion:u,extInfo:p.address})}async harvestLockPosition(e){let{programId:t=si,authProgramId:n=lo,clmmProgram:i=kn,poolKeys:r,lockData:s,ownerInfo:a={useSOLBalance:!0},associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,f=r||await this.getClmmPoolKeys(s.poolId.toString()),y=this.createTxBuilder(p),b=await this.scope.connection.getAccountInfo(s.positionId);b||this.logger.logWithError("position not found",s.positionId);let g=Ci.decode(b.data),w=a.useSOLBalance&&f.mintA.address===j.toString(),A=a.useSOLBalance&&f.mintB.address===j.toString(),h,I,{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.mintA.programId,mint:new Q(f.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!w,associatedOnly:w?!1:c,checkCreateATAOwner:u});h=k,x&&y.addInstruction(x);let{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.mintB.programId,mint:new Q(f.mintB.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!A,associatedOnly:A?!1:c,checkCreateATAOwner:u});I=S,K&&y.addInstruction(K);let T={},C=[];for(let ge of f.rewardInfos){let _e=a.useSOLBalance&&ge.mint.address===j.toString(),ut=T[ge.mint.address];if(!ut){let{account:Dt,instructionParams:ht}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(ge.mint.programId),mint:new Q(ge.mint.address),notUseTokenAccount:_e,owner:this.scope.ownerPubKey,skipCloseAccount:!_e,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:_e?!1:c});ut=Dt,ht&&y.addInstruction(ht)}T[ge.mint.address]=ut,C.push(ut)}let R=Bi(t,s.lockNftMint).publicKey,L=oe(this.scope.ownerPubKey,s.lockNftMint,Vi).publicKey,v=Y.getTickArrayStartIndexByTick(g.tickLower,f.config.tickSpacing),F=Y.getTickArrayStartIndexByTick(g.tickUpper,f.config.tickSpacing),{publicKey:_}=pe(new Q(f.programId),s.poolId,v),{publicKey:Z}=pe(new Q(f.programId),s.poolId,F),{publicKey:ce}=Et(new Q(f.programId),s.poolId,g.tickLower,g.tickUpper),ve=[];for(let ge=0;ge<f.rewardInfos.length;ge++)ve.push({poolRewardVault:new Q(f.rewardInfos[ge].vault),ownerRewardVault:C[ge],rewardMint:new Q(f.rewardInfos[ge].mint.address)});let Je=await Te.harvestLockPositionInstructionV2({programId:t,auth:n,lockPositionId:R,clmmProgram:i,lockOwner:this.scope.ownerPubKey,lockNftMint:s.lockNftMint,lockNftAccount:L,positionNftAccount:s.nftAccount,positionId:s.positionId,poolId:s.poolId,protocolPosition:ce,vaultA:new Q(f.vault.A),vaultB:new Q(f.vault.B),tickArrayLower:_,tickArrayUpper:Z,userVaultA:h,userVaultB:I,mintA:new Q(f.mintA.address),mintB:new Q(f.mintB.address),rewardAccounts:ve,exTickArrayBitmap:Ee(i,s.poolId).publicKey});return y.addInstruction({instructions:[Je],instructionTypes:[W.ClmmHarvestLockPosition]}),y.addCustomComputeBudget(l),y.addTipInstruction(m),y.versionBuild({txVersion:d})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:i,computeBudgetConfig:r,txTipConfig:s,feePayer:a}){var m;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let c=this.createTxBuilder(a),u=t!=null?t:await this.getClmmPoolKeys(e.id),l=Te.closePositionInstructions({poolInfo:e,poolKeys:u,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n,nft2022:(m=await this.scope.connection.getAccountInfo(n.nftMint))==null?void 0:m.owner.equals(gn)});return c.addCustomComputeBudget(r),c.addTipInstruction(s),c.addInstruction(l).versionBuild({txVersion:i,extInfo:{address:l.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txVersion:a,feePayer:c}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(c),l=t.useSOLBalance&&n.mint.address.toString()===j.toString(),m=n.perSecond.mul(n.endTime-n.openTime),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(n.mint.address),mint:new Q(n.mint.address),notUseTokenAccount:!!l,skipCloseAccount:!l,owner:this.scope.ownerPubKey,createInfo:l?{payer:t.feePayer||this.scope.ownerPubKey,amount:new bt(new N(m.toFixed(0)).gte(m)?m.toFixed(0):m.add(1).toFixed(0))}:void 0,associatedOnly:l?!1:i,checkCreateATAOwner:r});p&&u.addInstruction(p),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),y=Te.initRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{programId:new Q(n.mint.programId),mint:new Q(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:re.decimalToX64(n.perSecond)}});return u.addInstruction(y),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:y.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){for(let p of i)p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let m=this.createTxBuilder(l),d={};for(let p of i){let f=n.useSOLBalance&&p.mint.address===j.toString(),y=p.perSecond.mul(p.endTime-p.openTime),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(p.mint.programId),mint:new Q(p.mint.address),notUseTokenAccount:!!f,skipCloseAccount:!f,owner:this.scope.ownerPubKey,createInfo:f?{payer:n.feePayer||this.scope.ownerPubKey,amount:new bt(new N(y.toFixed(0)).gte(y)?y.toFixed(0):y.add(1).toFixed(0))}:void 0,associatedOnly:f?!1:r,checkCreateATAOwner:s});g&&m.addInstruction(g),b||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let w=t!=null?t:await this.getClmmPoolKeys(e.id),A=Te.initRewardInstructions({poolInfo:e,poolKeys:w,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:b},rewardInfo:{programId:new Q(p.mint.programId),mint:new Q(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:re.decimalToX64(p.perSecond)}});d=M(M({},d),A.address),m.addInstruction(A)}return m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:{address:d}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let l=this.createTxBuilder(u),m=t.useSOLBalance&&n.mint.equals(j),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:m,owner:this.scope.ownerPubKey,createInfo:m?{payer:t.feePayer||this.scope.ownerPubKey,amount:new bt(new N(n.perSecond.sub(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.sub(n.endTime-n.openTime))?n.perSecond.sub(n.endTime-n.openTime).toFixed(0):n.perSecond.sub(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:m?!1:i,checkCreateATAOwner:r});p&&l.addInstruction(p),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),y=Te.setRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:re.decimalToX64(n.perSecond)}});return l.addInstruction(y),l.addCustomComputeBudget(s),l.addTipInstruction(a),l.versionBuild({txVersion:c,extInfo:{address:y.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){let m=this.createTxBuilder(l),d={};for(let p of i){p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let f=n.useSOLBalance&&p.mint.address===j.toString(),{account:y,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(p.mint.programId),mint:new Q(p.mint.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:f?{payer:n.feePayer||this.scope.ownerPubKey,amount:new bt(new N(p.perSecond.sub(p.endTime-p.openTime).toFixed(0)).gte(p.perSecond.sub(p.endTime-p.openTime))?p.perSecond.sub(p.endTime-p.openTime).toFixed(0):p.perSecond.sub(p.endTime-p.openTime).add(1).toFixed(0))}:void 0,associatedOnly:f?!1:r,checkCreateATAOwner:s});b&&m.addInstruction(b),y||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let g=t!=null?t:await this.getClmmPoolKeys(e.id),w=Te.setRewardInstructions({poolInfo:e,poolKeys:g,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:y},rewardInfo:{mint:new Q(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:re.decimalToX64(p.perSecond)}});m.addInstruction(w),d=M(M({},d),w.address)}return m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:{address:d}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){let l=e.rewardDefaultInfos.find(g=>g.mint.address===n.toString());l||this.logAndCreateError("reward mint error","not found reward mint",n);let m=this.createTxBuilder(u),d=t.useSOLBalance&&n.equals(j),{account:p,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(l.mint.programId),mint:n,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!d,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:i,checkCreateATAOwner:r});f&&m.addInstruction(f),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),b=Te.collectRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardMint:n});return m.addInstruction(b),m.addCustomComputeBudget(s),m.addTipInstruction(a),m.versionBuild({txVersion:c,extInfo:{address:b.address}})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l={};for(let m of n){let d=e.rewardDefaultInfos.find(w=>w.mint.address===m.toString());if(!d){this.logAndCreateError("reward mint error","not found reward mint",m);continue}let p=t.useSOLBalance&&m.equals(j),{account:f,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(d.mint.programId),mint:m,notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:i,checkCreateATAOwner:r});f||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),y&&u.addInstruction(y);let b=await this.getClmmPoolKeys(e.id),g=Te.collectRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:f},rewardMint:m});u.addInstruction(g),l=M(M({},l),g.address)}return u.addCustomComputeBudget(s),u.addTipInstruction(a),u.build({address:l})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:i,amountOutMin:r,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p,txTipConfig:f,feePayer:y}){let b=this.createTxBuilder(y),g=n.toString()===e.mintA.address,w=c.useSOLBalance&&e.mintA.address===j.toBase58(),A=c.useSOLBalance&&e.mintB.address===j.toBase58(),h;!s||s.equals(new N(0))?h=g?Kt.add(new bt(1)):Ct.sub(new bt(1)):h=ie.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let I;if(!I){let{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Q(e.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:w||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?i:0}:void 0,associatedOnly:w?!1:l,checkCreateATAOwner:m});I=S,K&&b.addInstruction(K)}let k;if(!k){let{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Q(e.mintB.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,skipCloseAccount:!A,createInfo:A||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:i}:void 0,associatedOnly:A?!1:l,checkCreateATAOwner:m});k=S,K&&b.addInstruction(K)}(!I||!k)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:I,ownerTokenAccountB:k,mintAUseSOLBalance:w,mintBUseSOLBalance:A,associatedOnly:l});let x=t!=null?t:await this.getClmmPoolKeys(e.id);return b.addInstruction(Te.makeSwapBaseInInstructions({poolInfo:e,poolKeys:x,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:I,tokenAccountB:k},inputMint:new Q(n),amountIn:i,amountOutMin:r,sqrtPriceLimitX64:h,remainingAccounts:u})),b.addCustomComputeBudget(p),b.addTipInstruction(f),b.versionBuild({txVersion:d})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:i,amountInMax:r,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p,txTipConfig:f,feePayer:y}){let b=this.createTxBuilder(y),g=n.toString()===e.mintB.address,w=c.useSOLBalance&&e.mintA.address===j.toBase58(),A=c.useSOLBalance&&e.mintB.address===j.toBase58(),h;!s||s.equals(new N(0))?h=n.toString()===e.mintB.address?Kt.add(new bt(1)):Ct.sub(new bt(1)):h=ie.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let I;if(!I){let{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Q(e.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:w||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?r:0}:void 0,associatedOnly:w?!1:l,checkCreateATAOwner:m});I=S,K&&b.addInstruction(K)}let k;if(!k){let{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Q(e.mintB.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,skipCloseAccount:!A,createInfo:A||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:r}:void 0,associatedOnly:A?!1:l,checkCreateATAOwner:m});k=S,K&&b.addInstruction(K)}(!I||!k)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:I,ownerTokenAccountB:k,mintAUseSOLBalance:w,mintBUseSOLBalance:A,associatedOnly:l});let x=t!=null?t:await this.getClmmPoolKeys(e.id);return b.addInstruction(Te.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:x,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:I,tokenAccountB:k},outputMint:new Q(n),amountOut:i,amountInMax:r,sqrtPriceLimitX64:h,remainingAccounts:u})),b.addCustomComputeBudget(p),b.addTipInstruction(f),b.versionBuild({txVersion:d})}async harvestAllRewards({allPoolInfo:e,allPositions:t,lockInfo:n,ownerInfo:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,programId:a,txVersion:c,computeBudgetConfig:u,feePayer:l}){var b,g;let m={};for(let w of this.scope.account.tokenAccountRawInfos)r?oe(this.scope.ownerPubKey,w.accountInfo.mint,a).publicKey.equals(w.pubkey)&&(m[w.accountInfo.mint.toString()]=w.pubkey):m[w.accountInfo.mint.toString()]=w.pubkey;let d=Object.values(t).flat().map(w=>w.nftMint),p=await Ue(this.scope.connection,d.map(w=>({pubkey:w}))),f={};p.forEach(w=>{var A,h;f[w.pubkey.toBase58()]=(h=(A=w==null?void 0:w.accountInfo)==null?void 0:A.owner)!=null?h:null});let y=this.createTxBuilder(l);for(let w of Object.values(e)){if(t[w.id]===void 0||!t[w.id].find(C=>!C.liquidity.isZero()||C.rewardInfos.find(R=>!R.rewardAmountOwed.isZero())))continue;let A=w,h=i.useSOLBalance&&A.mintA.address===j.toString(),I=i.useSOLBalance&&A.mintB.address===j.toString(),k=m[A.mintA.address];if(!k){let{account:C,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:A.mintA.programId,mint:new Q(A.mintA.address),notUseTokenAccount:h,owner:this.scope.ownerPubKey,skipCloseAccount:!h,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:h?!1:r,checkCreateATAOwner:s});k=C,R&&y.addInstruction(R)}let x=m[A.mintB.address];if(!x){let{account:C,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:A.mintB.programId,mint:new Q(A.mintB.address),notUseTokenAccount:I,owner:this.scope.ownerPubKey,skipCloseAccount:!I,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:I?!1:r,checkCreateATAOwner:s});x=C,R&&y.addInstruction(R)}m[A.mintA.address]=k,m[A.mintB.address]=x;let S=[];for(let C of A.rewardDefaultInfos){let R=i.useSOLBalance&&C.mint.address===j.toString(),L=m[C.mint.address];if(!L){let{account:v,instructionParams:F}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(C.mint.programId),mint:new Q(C.mint.address),notUseTokenAccount:R,owner:this.scope.ownerPubKey,skipCloseAccount:!R,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:R?!1:r});L=v,F&&y.addInstruction(F)}m[C.mint.address]=L,S.push(L)}let K=await this.getClmmPoolKeys(A.id),T=[];for(let C=0;C<K.rewardInfos.length;C++)T.push({poolRewardVault:new Q(K.rewardInfos[C].vault),ownerRewardVault:S[C],rewardMint:new Q(K.rewardInfos[C].mint.address)});for(let C of t[w.id]){let R=(b=n==null?void 0:n[w.id])==null?void 0:b[C.nftMint.toBase58()];if(R){let L=oe(this.scope.ownerPubKey,R.lockNftMint,Vi).publicKey,v=Y.getTickArrayStartIndexByTick(C.tickLower,K.config.tickSpacing),F=Y.getTickArrayStartIndexByTick(C.tickUpper,K.config.tickSpacing),{publicKey:_}=pe(new Q(K.programId),R.poolId,v),{publicKey:Z}=pe(new Q(K.programId),R.poolId,F),{publicKey:ce}=Et(new Q(K.programId),R.poolId,C.tickLower,C.tickUpper),ve=Bi(si,R.lockNftMint).publicKey,Je=Te.harvestLockPositionInstructionV2({programId:si,auth:lo,lockPositionId:ve,clmmProgram:kn,lockOwner:this.scope.ownerPubKey,lockNftMint:R.lockNftMint,lockNftAccount:L,positionNftAccount:R.nftAccount,positionId:R.positionId,poolId:R.poolId,protocolPosition:ce,vaultA:new Q(K.vault.A),vaultB:new Q(K.vault.B),tickArrayLower:_,tickArrayUpper:Z,userVaultA:k,userVaultB:x,mintA:new Q(K.mintA.address),mintB:new Q(K.mintB.address),rewardAccounts:T,exTickArrayBitmap:Ee(kn,R.poolId).publicKey});y.addInstruction({instructions:[Je],instructionTypes:[W.ClmmHarvestLockPosition],lookupTableAddress:K.lookupTableAccount?[K.lookupTableAccount]:[]})}else{let L=Te.decreaseLiquidityInstructions({poolInfo:A,poolKeys:K,ownerPosition:C,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:x,rewardAccounts:S},liquidity:new bt(0),amountMinA:new bt(0),amountMinB:new bt(0),nft2022:(g=f[C.nftMint.toBase58()])==null?void 0:g.equals(gn)});y.addInstruction(L)}}}return c===0?y.sizeCheckBuildV0({computeBudgetConfig:u}):y.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(Ii(e).publicKey);return t?hu.decode(t.data).whitelistMints.filter(i=>!i.equals(Q.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new bt(1))).map(s=>mt(new Q(e),s.accountInfo.mint).publicKey),i=await this.scope.connection.getMultipleAccountsInfo(n),r=[];return i.forEach(s=>{if(!s)return;let a=Ci.decode(s.data);r.push(a)}),r}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await Ue(this.scope.connection,e.map(r=>({pubkey:new Q(r)})),t),i={};for(let r=0;r<e.length;r++){let s=n[r];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[r]));let a=xn.decode(s.accountInfo.data),c=ie.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();i[String(e[r])]=U(M({},a),{currentPrice:c,programId:s.accountInfo.owner})}return i}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(c=>e[c].ammConfig.toBase58())),i=await Ue(this.scope.connection,Array.from(n).map(c=>({pubkey:new Q(c)}))),r={};i.forEach(c=>{!c.accountInfo||(r[c.pubkey.toBase58()]=Pu.decode(c.accountInfo.data))});let s=await Be.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(c=>{var m,d,p,f;let[u,l]=[e[c].mintA.toBase58(),e[c].mintB.toBase58()];return{id:c,programId:e[c].programId.toBase58(),mintA:st({address:u,decimals:e[c].mintDecimalsA,programId:t[u].programId.toBase58()||Vi.toBase58(),extensions:{feeConfig:(m=t[u])!=null&&m.feeConfig?yn((d=t[u])==null?void 0:d.feeConfig):void 0}}),mintB:st({address:l,decimals:e[c].mintDecimalsB,programId:t[l].programId.toBase58()||Vi.toBase58(),extensions:{feeConfig:(p=t[l])!=null&&p.feeConfig?yn((f=t[l])==null?void 0:f.feeConfig):void 0}}),price:e[c].currentPrice,config:U(M({},r[e[c].ammConfig.toBase58()]),{id:e[c].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]})}})}),a=await Be.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){var l;let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),i=await _n({connection:this.scope.connection,mints:Array.from(n).map(m=>new Q(m))}),{computeClmmPoolInfo:r,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:i}),a=await Ue(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),c=wu(r[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");c.mintAmountA=Number(Du.decode(a[0].accountInfo.data).amount.toString()),c.mintAmountB=Number(Du.decode((l=a[1].accountInfo)==null?void 0:l.data).amount.toString());let u=U(M({},r[e]),{exBitmapAccount:r[e].exBitmapAccount.toBase58(),observationId:r[e].observationId.toBase58(),id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},config:c.config,rewardInfos:r[e].rewardInfos.filter(m=>!m.tokenVault.equals(Q.default)).map(m=>({mint:st({address:m.tokenMint.toBase58(),programId:Vi.toBase58(),decimals:10}),vault:m.tokenVault.toBase58()}))});return{poolInfo:c,poolKeys:u,computePoolInfo:r[e],tickData:s}}};import{PublicKey as z}from"@solana/web3.js";import{AccountLayout as zd,NATIVE_MINT as Jo,TOKEN_PROGRAM_ID as Ft}from"@solana/spl-token";import Ts from"bn.js";import Yo from"decimal.js-light";import Fi from"bn.js";function Xo(o,e){if(e.isZero())throw Error("divisor is zero");return o.mod(e)}function Md(o,e){if(e.isZero())throw Error("rhs is zero");let t=o.div(e);if(t.isZero())throw Error("quotient is zero");let n=Xo(o,e);return n.gt(Yn)&&(t=t.add(new Fi(1)),e=o.div(t),n=Xo(o,t),n.gt(Yn)&&(e=e.add(new Fi(1)))),[t,e]}var Yn=new Fi(0),zo=class{static swapWithoutFees(e,t,n){let i=t.mul(n),r=t.add(e),[s]=Md(i,r),a=n.sub(s);if(a.isZero())throw Error("destinationAmountSwapped is zero");return{destinationAmountSwapped:a}}static lpTokensToTradingTokens(e,t,n,i,r){let s=e.mul(n).div(t),a=e.mul(i).div(t);if(r===0)return{tokenAmount0:s,tokenAmount1:a};if(r===1)return Xo(e.mul(n),t).gt(Yn)&&s.gt(Yn)&&(s=s.add(new Fi(1))),Xo(e.mul(i),t).gt(Yn)&&a.gt(Yn)&&(a=a.add(new Fi(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};import qu from"bn.js";var hs=new qu(1e6);function Nd(o,e,t){return o.mul(e).add(t).sub(new qu(1)).div(t)}function Wu(o,e,t){return o.mul(e).div(t)}var Qo=class{static tradingFee(e,t){return Nd(e,t,hs)}static protocolFee(e,t){return Wu(e,t,hs)}static fundFee(e,t){return Wu(e,t,hs)}};var Ho=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,i){let r=Qo.tradingFee(e,i),s=e.sub(r),{destinationAmountSwapped:a}=zo.swapWithoutFees(s,t,n);return{newSwapDestinationAmount:n.sub(a),sourceAmountSwapped:e,destinationAmountSwapped:a,tradeFee:r}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:i,quoteReserve:r,outputMint:s,outputAmount:a}){let[c,u,l,m,d]=t.address===s.toString()?[i,r,e.decimals,t.decimals,e.address]:[r,i,t.decimals,e.decimals,t.address],p=new Yo(u.toString()).div(10**m).div(new Yo(c.toString()).div(10**l)),f=a.gte(u)?u.sub(new Ts(1)):a,y=u.sub(f),b=ln(c.mul(f),y),g=ln(b.mul(new Ts(1e6)),new Ts(1e6).sub(n)),w=g.sub(b),A=new Yo(f.toString()).div(10**m).div(new Yo(g.toString()).div(10**l)),h=p.isZero()?0:A.sub(p).div(p).abs().toNumber();return{amountRealOut:f,amountIn:g,amountInWithoutFee:b,tradeFee:w,priceImpact:h}}};import Fe from"bn.js";import{PublicKey as Wi,TransactionInstruction as On,Keypair as qd,SystemProgram as Ud}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Xu,TOKEN_2022_PROGRAM_ID as Bs,TOKEN_PROGRAM_ID as wn}from"@solana/spl-token";var vd=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),dB=Buffer.from("amm_config","utf8"),_d=Buffer.from("pool","utf8"),Vd=Buffer.from("pool_lp_mint","utf8"),Ed=Buffer.from("pool_vault","utf8"),Fd=Buffer.from("observation","utf8");function Hn(o){return de([vd],o)}function Is(o,e,t,n){return de([_d,e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}function Dd(o,e){return de([Vd,e.toBuffer()],o)}function Uu(o,e,t){return de([Ed,e.toBuffer(),t.toBuffer()],o)}function Di(o,e){return de([Fd,e.toBuffer()],o)}function Gu({poolId:o,programId:e,configId:t,mintA:n,mintB:i}){let r=Hn(e).publicKey,s=o||Is(e,t,n,i).publicKey,a=Dd(e,s).publicKey,c=Uu(e,s,n).publicKey,u=Uu(e,s,i).publicKey,l=Di(e,s).publicKey;return{poolId:s,configId:t,authority:r,lpMint:a,vaultA:c,vaultB:u,observationId:l}}var Wd=Buffer.from("locked_liquidity","utf8");function jo(o,e){return de([Wd,e.toBuffer()],o)}var Gd=me("Raydium_cpmm"),Mn={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173],lockCpLiquidity:[216,157,29,78,38,51,31,26],collectCpFee:[8,30,51,199,209,184,247,133]};function zu(o,e,t,n,i,r,s,a,c,u,l,m,d,p,f,y,b,g,w,A){let h=q([P("amountMaxA"),P("amountMaxB"),P("openTime")]),I=Is(o,t,r,s).publicKey,k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!i.equals(I),isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:wn,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:Xu,isSigner:!1,isWritable:!1},{pubkey:kr,isSigner:!1,isWritable:!1},{pubkey:ct,isSigner:!1,isWritable:!1}],x=Buffer.alloc(h.span);return h.encode({amountMaxA:g,amountMaxB:w,openTime:A},x),new On({keys:k,programId:o,data:Buffer.from([...Mn.initialize,...x])})}function Qu(o,e,t,n,i,r,s,a,c,u,l,m,d,p,f){let y=q([P("lpAmount"),P("amountMaxA"),P("amountMaxB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:wn,isSigner:!1,isWritable:!1},{pubkey:Bs,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0}],g=Buffer.alloc(y.span);return Gd.debug("cpmm deposit data",{lpAmount:d.toString(),amountMaxA:p.toString(),amountMaxB:f.toString()}),y.encode({lpAmount:d,amountMaxA:p,amountMaxB:f},g),new On({keys:b,programId:o,data:Buffer.from([...Mn.deposit,...g])})}function Yu(o,e,t,n,i,r,s,a,c,u,l,m,d,p,f){let y=q([P("lpAmount"),P("amountMinA"),P("amountMinB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:wn,isSigner:!1,isWritable:!1},{pubkey:Bs,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:cn,isSigner:!1,isWritable:!1}],g=Buffer.alloc(y.span);return y.encode({lpAmount:d,amountMinA:p,amountMinB:f},g),new On({keys:b,programId:o,data:Buffer.from([...Mn.withdraw,...g])})}function Zo(o,e,t,n,i,r,s,a,c,u,l,m,d,p,f,y){let b=q([P("amountIn"),P("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],w=Buffer.alloc(b.span);return b.encode({amountIn:f,amounOutMin:y},w),new On({keys:g,programId:o,data:Buffer.from([...Mn.swapBaseInput,...w])})}function Hu(o,e,t,n,i,r,s,a,c,u,l,m,d,p,f,y){let b=q([P("amountInMax"),P("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],w=Buffer.alloc(b.span);return b.encode({amountInMax:f,amountOut:y},w),new On({keys:g,programId:o,data:Buffer.from([...Mn.swapBaseOutput,...w])})}async function ju(o){var b;let{ownerInfo:e,poolInfo:t,poolKeys:n,feeNftOwner:i,getEphemeralSigners:r}=o,s=[],[a,c]=[new Wi(t.id),new Wi(t.lpMint.address)],u;if(r)u=new Wi((await r(1))[0]);else{let g=qd.generate();s.push(g),u=g.publicKey}let{publicKey:l}=oe(i,u,wn),{publicKey:m}=Tn(u),{publicKey:d}=jo(o.lockProgram,u),{publicKey:p}=oe(e.wallet,c,wn),{publicKey:f}=oe(o.lockAuthProgram,c,wn),y=Xd({programId:o.lockProgram,auth:o.lockAuthProgram,payer:e.feePayer,liquidityOwner:e.wallet,nftOwner:i,nftMint:u,nftAccount:l,poolId:a,lockPda:d,mintLp:c,userLpVault:p,lockLpVault:f,poolVaultA:new Wi(n.vault.A),poolVaultB:new Wi(n.vault.B),metadataAccount:m,lpAmount:o.lpAmount,withMetadata:(b=o.withMetadata)!=null?b:!0});return{address:{nftMint:u,nftAccount:l,metadataAccount:m,lockPda:d,userLpVault:p,lockLpVault:f},instructions:[y],signers:s,instructionTypes:[W.CpmmLockLp],lookupTableAddress:[]}}function Xd({programId:o,auth:e,payer:t,liquidityOwner:n,nftOwner:i,nftMint:r,nftAccount:s,poolId:a,lockPda:c,mintLp:u,userLpVault:l,lockLpVault:m,poolVaultA:d,poolVaultB:p,metadataAccount:f,lpAmount:y,withMetadata:b}){let g=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:Ud.programId,isSigner:!1,isWritable:!1},{pubkey:wn,isSigner:!1,isWritable:!1},{pubkey:Xu,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1}],w=q([P("lpAmount"),Oe("withMetadata")]),A=Buffer.alloc(w.span);w.encode({lpAmount:y,withMetadata:b},A);let h=Buffer.from([...Mn.lockCpLiquidity,...A]);return new On({keys:g,programId:o,data:h})}function Zu({programId:o,nftOwner:e,auth:t,nftAccount:n,lockPda:i,poolId:r,mintLp:s,userVaultA:a,userVaultB:c,poolVaultA:u,poolVaultB:l,mintA:m,mintB:d,lockLpVault:p,lpFeeAmount:f,cpmmProgram:y,cpmmAuthProgram:b}){let g=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:y!=null?y:mo,isSigner:!1,isWritable:!1},{pubkey:b!=null?b:ka,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:wn,isSigner:!1,isWritable:!1},{pubkey:Bs,isSigner:!1,isWritable:!1},{pubkey:cn,isSigner:!1,isWritable:!1}],w=q([P("lpFeeAmount")]),A=Buffer.alloc(w.span);w.encode({lpFeeAmount:f},A);let h=Buffer.from([...Mn.collectCpFee,...A]);return new On({keys:g,programId:o,data:h})}var $u=q([we(8),X("bump"),Oe("disableCreatePool"),Yt("index"),P("tradeFeeRate"),P("protocolFeeRate"),P("fundFeeRate"),P("createPoolFee"),O("protocolOwner"),O("fundOwner"),H(P(),16)]),$o=q([we(8),O("configId"),O("poolCreator"),O("vaultA"),O("vaultB"),O("mintLp"),O("mintA"),O("mintB"),O("mintProgramA"),O("mintProgramB"),O("observationId"),X("bump"),X("status"),X("lpDecimals"),X("mintDecimalA"),X("mintDecimalB"),P("lpAmount"),P("protocolFeesMintA"),P("protocolFeesMintB"),P("fundFeesMintA"),P("fundFeesMintB"),P("openTime"),H(P(),32)]);var qi=class extends Le{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t){return(await this.getRpcPoolInfos([e],t))[e]}async getRpcPoolInfos(e,t){let n=await Ue(this.scope.connection,e.map(m=>({pubkey:new z(m)}))),i={},r=new Set,s=[];for(let m=0;m<e.length;m++){let d=n[m];if(d.accountInfo===null)throw Error("fetch pool info error: "+String(e[m]));let p=$o.decode(d.accountInfo.data);i[String(e[m])]=U(M({},p),{programId:d.accountInfo.owner}),r.add(String(p.configId)),s.push(p.vaultA,p.vaultB)}let a={};if(t){let m=[...r],d=await Ue(this.scope.connection,m.map(p=>({pubkey:new z(p)})));for(let p=0;p<m.length;p++){let f=d[p].accountInfo;if(f===null)throw Error("fetch pool config error: "+m[p]);a[m[p]]=$u.decode(f.data)}}let c={},u=await Ue(this.scope.connection,s.map(m=>({pubkey:new z(m)})));for(let m=0;m<s.length;m++){let d=u[m].accountInfo;if(d===null)throw Error("fetch vault info error: "+s[m]);c[String(s[m])]=new Fe(zd.decode(d.data).amount.toString())}let l={};for(let[m,d]of Object.entries(i)){let p=c[d.vaultA.toString()].sub(d.protocolFeesMintA).sub(d.fundFeesMintA),f=c[d.vaultB.toString()].sub(d.protocolFeesMintB).sub(d.fundFeesMintB);l[m]=U(M({},d),{baseReserve:p,quoteReserve:f,vaultAAmount:c[d.vaultA.toString()],vaultBAmount:c[d.vaultB.toString()],configInfo:a[d.configId.toString()],poolPrice:new N(f.toString()).div(new N(10).pow(d.mintDecimalB)).div(new N(p.toString()).div(new N(10).pow(d.mintDecimalA)))})}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,i)=>{var c,u,l,m;let r=e[i],[s,a]=[r.mintA.toBase58(),r.mintB.toBase58()];return U(M({},n),{[i]:U(M({},r),{id:new z(i),configInfo:r.configInfo,version:7,authority:Hn(r.programId).publicKey,mintA:st({address:s,decimals:r.mintDecimalA,programId:r.mintProgramA.toBase58(),extensions:{feeConfig:(c=t[s])!=null&&c.feeConfig?yn((u=t[s])==null?void 0:u.feeConfig):void 0}}),mintB:st({address:a,decimals:r.mintDecimalB,programId:r.mintProgramB.toBase58(),extensions:{feeConfig:(l=t[a])!=null&&l.feeConfig?yn((m=t[a])==null?void 0:m.feeConfig):void 0}})})})},{})}async getPoolInfoFromRpc(e){let t=await this.getRpcPoolInfo(e,!0),n=await _n({connection:this.scope.connection,mints:[t.mintA,t.mintB]}),i=st({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?yn(n[t.mintA.toBase58()].feeConfig):void 0}}),r=st({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?yn(n[t.mintB.toBase58()].feeConfig):void 0}}),s=st({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:Ft.toBase58()}),a={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},c={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:s,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:a,mintA:i,mintB:r,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new N(t.vaultAAmount.toString()).div(10**i.decimals).toNumber(),mintAmountB:new N(t.vaultBAmount.toString()).div(10**r.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,burnPercent:0,day:c,week:c,month:c,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:i,mintB:r,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:Hn(t.programId).publicKey.toBase58(),mintLp:s,config:a,observationId:Di(t.programId,new z(e)).publicKey.toBase58()},rpcData:t}}async createPool(f){var y=f,{poolId:e,programId:t,poolFeeAccount:n,startTime:i,ownerInfo:r,associatedOnly:s=!1,checkCreateATAOwner:a=!1,txVersion:c,feeConfig:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}=y,p=We(y,["poolId","programId","poolFeeAccount","startTime","ownerInfo","associatedOnly","checkCreateATAOwner","txVersion","feeConfig","computeBudgetConfig","txTipConfig","feePayer"]);var _,Z,ce;let b=r.feePayer||((_=this.scope.owner)==null?void 0:_.publicKey),g=new Fe(new z(p.mintA.address).toBuffer()).lte(new Fe(new z(p.mintB.address).toBuffer())),[w,A]=g?[p.mintA,p.mintB]:[p.mintB,p.mintA],[h,I]=g?[p.mintAAmount,p.mintBAmount]:[p.mintBAmount,p.mintAAmount],k=r.useSOLBalance&&w.address===Jo.toBase58(),x=r.useSOLBalance&&A.address===Jo.toBase58(),[S,K]=[new z(w.address),new z(A.address)],T=this.createTxBuilder(d),{account:C,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({mint:S,tokenProgram:w.programId,owner:this.scope.ownerPubKey,createInfo:k?{payer:b,amount:h}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:s,checkCreateATAOwner:a});T.addInstruction(R||{});let{account:L,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({mint:new z(A.address),tokenProgram:A.programId,owner:this.scope.ownerPubKey,createInfo:x?{payer:b,amount:I}:void 0,notUseTokenAccount:x,skipCloseAccount:!x,associatedOnly:x?!1:s,checkCreateATAOwner:a});if(T.addInstruction(v||{}),C===void 0||L===void 0)throw Error("you don't has some token account");let F=Gu({poolId:e,programId:t,configId:new z(u.id),mintA:S,mintB:K});return T.addInstruction({instructions:[zu(t,this.scope.ownerPubKey,new z(u.id),F.authority,F.poolId,S,K,F.lpMint,C,L,oe(this.scope.ownerPubKey,F.lpMint).publicKey,F.vaultA,F.vaultB,n,new z((Z=w.programId)!=null?Z:Ft),new z((ce=A.programId)!=null?ce:Ft),F.observationId,h,I,i)],instructionTypes:[W.CpmmCreatePool]}),T.addCustomComputeBudget(l),T.addTipInstruction(m),T.versionBuild({txVersion:c,extInfo:{address:U(M({},F),{mintA:w,mintB:A,programId:t,poolFeeAccount:n,feeConfig:u})}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:i,baseIn:r,slippage:s,computeResult:a,computeBudgetConfig:c,txTipConfig:u,config:l,txVersion:m,feePayer:d}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),i.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:i.toString()});let{account:p}=this.scope,{bypassAssociatedCheck:f,checkCreateATAOwner:y}=M({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},l),b=a?void 0:await this.getRpcPoolInfo(t.id),{liquidity:g,inputAmountFee:w,anotherAmount:A}=a||this.computePairAmount({poolInfo:U(M({},t),{lpAmount:new N(b.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()}),baseReserve:b.baseReserve,quoteReserve:b.quoteReserve,slippage:new Qe(0),baseIn:r,epochInfo:await this.scope.fetchEpochInfo(),amount:new N(i.toString()).div(10**(r?t.mintA.decimals:t.mintB.decimals))}),h=A.amount,I=t.mintA.address===Jo.toString(),k=t.mintB.address===Jo.toString(),x=this.createTxBuilder(d),[S,K]=[new z(t.mintA.address),new z(t.mintB.address)],{account:T,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:I||(r?i:h).isZero()?{payer:this.scope.ownerPubKey,amount:r?i:h}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:!1,checkCreateATAOwner:y});x.addInstruction(C||{});let{account:R,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||(r?h:i).isZero()?{payer:this.scope.ownerPubKey,amount:r?h:i}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:!1,checkCreateATAOwner:y});x.addInstruction(L||{}),!T&&!R&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let v=await p.getCreatedTokenAccount({mint:new z(t.lpMint.address)}),ve=await p.handleTokenAccount({side:"out",amount:0,mint:new z(t.lpMint.address),tokenAccount:v,bypassAssociatedCheck:f,checkCreateATAOwner:y}),{tokenAccount:F}=ve,_=We(ve,["tokenAccount"]);x.addInstruction(_);let Z=n!=null?n:await this.getCpmmPoolKeys(t.id),ce=new Qe(new Fe(1)).sub(s);return x.addInstruction({instructions:[Qu(new z(t.programId),this.scope.ownerPubKey,new z(Z.authority),new z(t.id),F,T,R,new z(Z.vault.A),new z(Z.vault.B),S,K,new z(t.lpMint.address),a?a==null?void 0:a.liquidity:ce.mul(g).quotient,r?w.amount:h,r?h:w.amount)],instructionTypes:[W.CpmmAddLiquidity],lookupTableAddress:Z.lookupTableAccount?[Z.lookupTableAccount]:[]}),x.addCustomComputeBudget(c),x.addTipInstruction(u),x.versionBuild({txVersion:m})}async withdrawLiquidity(e){var _,Z;let{poolInfo:t,poolKeys:n,lpAmount:i,slippage:r,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u,closeWsol:l=!0}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let m=new Qe(new Fe(1)).sub(r),d=await this.getRpcPoolInfo(t.id),[p,f]=[m.mul(i.mul(d.baseReserve).div(d.lpAmount)).quotient,m.mul(i.mul(d.quoteReserve).div(d.lpAmount)).quotient],y=await this.scope.fetchEpochInfo(),[b,g]=[Pe(p,t.mintA.extensions.feeConfig,y,!1),Pe(f,t.mintB.extensions.feeConfig,y,!1)],{account:w}=this.scope,A=this.createTxBuilder(u),[h,I]=[new z(t.mintA.address),new z(t.mintB.address)],k=h.equals(j),x=I.equals(j),S,K,{account:T,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(k&&l),associatedOnly:!k,checkCreateATAOwner:!1});S=T,C&&A.addInstruction(C);let{account:R,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:x,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(x&&l),associatedOnly:!x,checkCreateATAOwner:!1});K=R,L&&A.addInstruction(L),(!S||!K)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",w.tokenAccounts);let v=await w.getCreatedTokenAccount({mint:new z(t.lpMint.address)});v||this.logAndCreateError("cannot found lp token account","tokenAccounts",w.tokenAccounts);let F=n!=null?n:await this.getCpmmPoolKeys(t.id);return A.addInstruction({instructions:[Yu(new z(t.programId),this.scope.ownerPubKey,new z(F.authority),new z(t.id),v,S,K,new z(F.vault.A),new z(F.vault.B),h,I,new z(t.lpMint.address),i,p.sub((_=b.fee)!=null?_:new Fe(0)),f.sub((Z=g.fee)!=null?Z:new Fe(0)))],instructionTypes:[W.CpmmWithdrawLiquidity],lookupTableAddress:F.lookupTableAccount?[F.lookupTableAccount]:[]}),A.addCustomComputeBudget(s),A.addTipInstruction(a),A.versionBuild({txVersion:c})}async swap(e){var C,R,L,v,F,_;let{poolInfo:t,poolKeys:n,baseIn:i,fixedOut:r,inputAmount:s,swapResult:a,slippage:c=0,config:u,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,{bypassAssociatedCheck:f,checkCreateATAOwner:y,associatedOnly:b}=M({bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0},u),g=this.createTxBuilder(p),[w,A]=[new z(t.mintA.address),new z(t.mintB.address)];r?a.sourceAmountSwapped=a.sourceAmountSwapped.mul(new Fe((1+c)*1e4)).div(new Fe(1e4)):a.destinationAmountSwapped=a.destinationAmountSwapped.mul(new Fe((1-c)*1e4)).div(new Fe(1e4));let h=t.mintA.address===j.toBase58(),I=t.mintB.address===j.toBase58(),{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({mint:w,tokenProgram:new z((C=t.mintA.programId)!=null?C:Ft),owner:this.scope.ownerPubKey,createInfo:h||!i?{payer:this.scope.ownerPubKey,amount:i?a.sourceAmountSwapped:0}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:b,checkCreateATAOwner:y});x&&g.addInstruction(x);let{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:A,tokenProgram:new z((R=t.mintB.programId)!=null?R:Ft),owner:this.scope.ownerPubKey,createInfo:I||i?{payer:this.scope.ownerPubKey,amount:i?0:a.sourceAmountSwapped}:void 0,notUseTokenAccount:I,skipCloseAccount:!I,associatedOnly:I?!1:b,checkCreateATAOwner:y});K&&g.addInstruction(K),(!k||!S)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:k,mintBTokenAcc:S,mintAUseSOLBalance:h,mintBUseSOLBalance:I,associatedOnly:b});let T=n!=null?n:await this.getCpmmPoolKeys(t.id);return g.addInstruction({instructions:[r?Hu(new z(t.programId),this.scope.ownerPubKey,new z(T.authority),new z(T.config.id),new z(t.id),i?k:S,i?S:k,new z(T.vault[i?"A":"B"]),new z(T.vault[i?"B":"A"]),new z((F=t[i?"mintA":"mintB"].programId)!=null?F:Ft),new z((_=t[i?"mintB":"mintA"].programId)!=null?_:Ft),i?w:A,i?A:w,Di(new z(t.programId),new z(t.id)).publicKey,a.sourceAmountSwapped,a.destinationAmountSwapped):Zo(new z(t.programId),this.scope.ownerPubKey,new z(T.authority),new z(T.config.id),new z(t.id),i?k:S,i?S:k,new z(T.vault[i?"A":"B"]),new z(T.vault[i?"B":"A"]),new z((L=t[i?"mintA":"mintB"].programId)!=null?L:Ft),new z((v=t[i?"mintB":"mintA"].programId)!=null?v:Ft),i?w:A,i?A:w,Di(new z(t.programId),new z(t.id)).publicKey,s,a.destinationAmountSwapped)],instructionTypes:[r?W.CpmmSwapBaseOut:W.ClmmSwapBaseIn]}),g.addCustomComputeBudget(l),g.addTipInstruction(m),g.versionBuild({txVersion:d})}async lockLp(e){var d,p,f,y,b;let{poolInfo:t,lpAmount:n,computeBudgetConfig:i,txTipConfig:r,txVersion:s,feePayer:a,feeNftOwner:c}=e;n.isZero()&&this.logAndCreateError("lpAmount must greater than zero",{lpAmount:n.toString()});let u=this.createTxBuilder(a),l=(d=e.poolKeys)!=null?d:await this.getCpmmPoolKeys(t.id),m=await ju({poolInfo:t,poolKeys:l,ownerInfo:{wallet:this.scope.ownerPubKey,feePayer:(p=e.feePayer)!=null?p:this.scope.ownerPubKey},feeNftOwner:c!=null?c:this.scope.ownerPubKey,lockProgram:(f=e.programId)!=null?f:po,lockAuthProgram:(y=e.authProgram)!=null?y:fo,lpAmount:n,withMetadata:(b=e.withMetadata)!=null?b:!0,getEphemeralSigners:e.getEphemeralSigners});return u.addInstruction(m),u.addCustomComputeBudget(i),u.addTipInstruction(r),u.versionBuild({txVersion:s,extInfo:m.address})}async harvestLockLp(e){var R;let{poolInfo:t,lpFeeAmount:n,nftMint:i,programId:r=po,authProgram:s=fo,cpmmProgram:a,computeBudgetConfig:c,txTipConfig:u,txVersion:l,closeWsol:m=!0}=e;n.isZero()&&this.logAndCreateError("lpFeeAmount must greater than zero",{lpAmount:n.toString()});let d=e.feePayer||this.scope.ownerPubKey,p=this.createTxBuilder(d),[f,y]=[new z(t.mintA.address),new z(t.mintB.address)],b=f.equals(j),g=y.equals(j),w,A,{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(b&&m),associatedOnly:!b,checkCreateATAOwner:!1});w=h,I&&p.addInstruction(I);let{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(g&&m),associatedOnly:!g,checkCreateATAOwner:!1});A=k,x&&p.addInstruction(x),(!w||!A)&&this.logAndCreateError("cannot found target token accounts",{tokenAccountA:w,tokenAccountB:A});let S=(R=e.poolKeys)!=null?R:await this.getCpmmPoolKeys(t.id),{publicKey:K}=oe(d,i,Ft),{publicKey:T}=jo(r,i),{publicKey:C}=oe(s,new z(t.lpMint.address),Ft);return p.addInstruction({instructions:[Zu({programId:r!=null?r:po,nftOwner:this.scope.ownerPubKey,auth:s!=null?s:fo,nftMint:i,nftAccount:K,lockPda:T,poolId:new z(t.id),mintLp:new z(S.mintLp.address),userVaultA:w,userVaultB:A,poolVaultA:new z(S.vault.A),poolVaultB:new z(S.vault.B),mintA:f,mintB:y,lockLpVault:C,lpFeeAmount:n,cpmmProgram:a==null?void 0:a.programId,cpmmAuthProgram:a==null?void 0:a.authProgram})],instructionTypes:[W.CpmmCollectLockFee]}),p.addCustomComputeBudget(c),p.addTipInstruction(u),p.versionBuild({txVersion:l})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:i}){let r=n.toString()===e.mintB.address,s=Ho.swap(t,r?e.baseReserve:e.quoteReserve,r?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),a=new N(s.destinationAmountSwapped.toString()).div(s.sourceAmountSwapped.toString()),c=s.destinationAmountSwapped.mul(new Fe((1-i)*1e4)).div(new Fe(1e4));return{allTrade:s.sourceAmountSwapped.eq(t),amountIn:t,amountOut:s.destinationAmountSwapped,minAmountOut:c,executionPrice:a,fee:s.tradeFee,priceImpact:e.poolPrice.sub(a).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:i,slippage:r,epochInfo:s,baseIn:a}){var h,I,k,x,S,K,T,C,R;let c=1-Number(r.toSignificant())/100,u=new Fe(new N(i).mul(10**e[a?"mintA":"mintB"].decimals).mul(c).toFixed(0)),l=Pe(u,e[a?"mintA":"mintB"].extensions.feeConfig,s,!1),m=u.sub((h=l.fee)!=null?h:new Fe(0)),d=new Fe(new N(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,N.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",a?e.mintA.symbol:e.mintB.symbol,"amountIn:",u.toString(),"amountInFee:",(k=(I=l.fee)==null?void 0:I.toString())!=null?k:0,"anotherToken:",a?e.mintB.symbol:e.mintA.symbol,"slippage:",`${r.toSignificant()}%`);let p=a?"base":"quote";this.logDebug("input side:",p);let f=m.mul(d).div(p==="base"?t:n),y={amount:yt,fee:void 0,expirationTime:void 0};if(!m.isZero()){let L=Qd(f,t,n,d);this.logDebug("lpAmountData:",{amountA:L.amountA.toString(),amountB:L.amountB.toString()}),y=Pe(L[a?"amountB":"amountA"],e[a?"mintB":"mintA"].extensions.feeConfig,s,!0)}let b=new Qe(new Fe(1)).add(r),g=new Qe(new Fe(1)).sub(r),w=Pe(b.mul(y.amount.sub((x=y.fee)!=null?x:new Fe(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0),A=Pe(g.mul(y.amount.sub((S=y.fee)!=null?S:new Fe(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0);return this.logDebug("anotherAmount:",y.amount.toString(),"anotherAmountFee:",(T=(K=y.fee)==null?void 0:K.toString())!=null?T:0,"maxAnotherAmount:",w.amount.toString(),"maxAnotherAmountFee:",(R=(C=w.fee)==null?void 0:C.toString())!=null?R:0),{inputAmountFee:l,anotherAmount:y,maxAnotherAmount:w,minAnotherAmount:A,liquidity:f}}};function Qd(o,e,t,n){let i=o.mul(e).div(n);!i.isZero()&&!o.mul(e).mod(n).isZero()&&(i=i.add(new Fe(1)));let r=o.mul(t).div(n);return!r.isZero()&&!o.mul(t).mod(n).isZero()&&(r=r.add(new Fe(1))),{amountA:i,amountB:r}}import{PublicKey as vn}from"@solana/web3.js";import{createTransferInstruction as oc,TOKEN_PROGRAM_ID as De,TOKEN_2022_PROGRAM_ID as nr}from"@solana/spl-token";import ir from"bn.js";var Ju={[Sr.toBase58()]:3},ec={3:Sr};var xs=q([we(5),we(8),O("ownAddress"),P("vaultSignerNonce"),O("baseMint"),O("quoteMint"),O("baseVault"),P("baseDepositsTotal"),P("baseFeesAccrued"),O("quoteVault"),P("quoteDepositsTotal"),P("quoteFeesAccrued"),P("quoteDustThreshold"),O("requestQueue"),O("eventQueue"),O("bids"),O("asks"),P("baseLotSize"),P("quoteLotSize"),P("feeRateBps"),P("referrerRebatesAccrued"),we(7)]),tc={3:xs};import{PublicKey as nc}from"@solana/web3.js";var er=me("Serum"),tr=class{static getProgramId(e){let t=ec[e];return t||er.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=Ju[t];return n||er.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=tc[e];return t||er.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],i=0,r;for(;i<100;){try{let s=n.concat(Buffer.from([i]),Buffer.alloc(7));r=nc.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;i++;continue}return{publicKey:r,nonce:i}}return er.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:nc.default,nonce:i}}};import{PublicKey as ne,SystemProgram as Yd,TransactionInstruction as Hd}from"@solana/web3.js";import Nn from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as jd,TOKEN_2022_PROGRAM_ID as Zd,TOKEN_PROGRAM_ID as $d}from"@solana/spl-token";function Jd(o,e,t,n,i,r,s,a,c,u,l,m,d,p,f){var k;let y=[],b=[B({pubkey:$d,isWritable:!1}),B({pubkey:Zd,isWritable:!1}),B({pubkey:jd,isWritable:!1}),B({pubkey:Yd.programId,isWritable:!1}),B({pubkey:e,isSigner:!0})];b.push(B({pubkey:t})),b.push(B({pubkey:i}));let g=[c,u],w=[l,m],A=[r,s,a];for(let x=0;x<g.length;x++){let S=g[x],K=A[x]===S.mintA.address;if(b.push(B({pubkey:new ne(S.programId),isWritable:!1})),x===g.length-1?b.push(B({pubkey:i})):b.push(B({pubkey:n})),b.push(B({pubkey:new ne(A[x])})),b.push(B({pubkey:new ne(A[x+1])})),S.version===6){let T=w[x];b.push(B({pubkey:new ne(T.config.id)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(K?T.vault.A:T.vault.B)})),b.push(B({pubkey:new ne(K?T.vault.B:T.vault.A)})),b.push(B({pubkey:new ne(S.observationId)})),b.push(B({pubkey:cn})),b.push(B({pubkey:Ee(new ne(S.programId),new ne(S.id)).publicKey})),y.push(ep(S.sqrtPriceX64.toString(),K));for(let C of(k=f[x])!=null?k:[])b.push(B({pubkey:new ne(C)}))}else if(S.version===5){let T=w[x];b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.authority),isWritable:!1})),b.push(B({pubkey:new ne(T.marketProgramId)})),b.push(B({pubkey:new ne(T.marketAuthority)})),b.push(B({pubkey:Aa,isWritable:!1})),b.push(B({pubkey:new ne(T.openOrders)})),b.push(B({pubkey:new ne(T.vault.A)})),b.push(B({pubkey:new ne(T.vault.B)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.marketId)})),b.push(B({pubkey:new ne(T.marketBids)})),b.push(B({pubkey:new ne(T.marketAsks)})),b.push(B({pubkey:new ne(T.marketEventQueue)})),b.push(B({pubkey:new ne(T.marketBaseVault)})),b.push(B({pubkey:new ne(T.marketQuoteVault)}))}else if(S.version===4){let T=w[x],C=S.status!==1;b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.authority),isWritable:!1})),b.push(B({pubkey:new ne(C?T.id:T.marketProgramId)})),b.push(B({pubkey:new ne(C?T.id:T.marketAuthority)})),b.push(B({pubkey:new ne(C?T.id:T.openOrders)})),b.push(B({pubkey:new ne(T.vault.A)})),b.push(B({pubkey:new ne(T.vault.B)})),b.push(B({pubkey:new ne(C?T.id:T.marketId)})),b.push(B({pubkey:new ne(C?T.id:T.marketBids)})),b.push(B({pubkey:new ne(C?T.id:T.marketAsks)})),b.push(B({pubkey:new ne(C?T.id:T.marketEventQueue)})),b.push(B({pubkey:new ne(C?T.id:T.marketBaseVault)})),b.push(B({pubkey:new ne(C?T.id:T.marketQuoteVault)}))}else if(S.version===7){let T=w[x];b.push(B({pubkey:new ne(T.authority)})),b.push(B({pubkey:new ne(T.config.id)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(K?T.vault.A:T.vault.B)})),b.push(B({pubkey:new ne(K?T.vault.B:T.vault.A)})),b.push(B({pubkey:new ne(S.observationId)}))}else throw Error("pool type error")}let h=q([X("insId"),P("amountIn"),P("amountOut"),H(ee(),y.length,"clmmPriceLimit")]),I=Buffer.alloc(h.span);return h.encode({insId:0,amountIn:d,amountOut:p,clmmPriceLimit:y},I),new Hd({keys:b,programId:o,data:I})}function ep(o,e){if(o)if(e){let t=new Nn(o).div(new Nn(25));return t.gt(Oo)?t:Oo}else{let t=new Nn(o).mul(new Nn(25));return t.lt(Mo)?t:Mo}else return e?Oo:Mo}function ic({routeProgram:o,ownerInfo:e,inputMint:t,swapInfo:n}){var i,r,s,a,c,u,l;if(n.routeType==="amm")if(n.poolInfo[0].version===6){let m=n.poolKey[0],d=Ze(m),p=t.equals(d.mintA.address)?Kt.add(wt):Ct.sub(wt);return Te.makeSwapBaseInInstructions({poolInfo:m,poolKeys:m,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:d.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:d.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub((r=(i=n.minAmountOut.fee)==null?void 0:i.raw)!=null?r:new Nn(0)),sqrtPriceLimitX64:p,remainingAccounts:(s=n.remainingAccounts[0])!=null?s:[]})}else if(n.poolInfo[0].version===7){let m=n.poolInfo[0],d=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[Zo(m.programId,e.wallet,m.authority,m.configId,m.id,e.sourceToken,e.destinationToken,d?m.vaultA:m.vaultB,d?m.vaultB:m.vaultA,d?m.mintProgramA:m.mintProgramB,d?m.mintProgramB:m.mintProgramA,new ne(m[d?"mintA":"mintB"].address),new ne(m[d?"mintB":"mintA"].address),m.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[d?W.CpmmSwapBaseIn:W.CpmmSwapBaseOut],address:{}}}else{let m=n.poolKey[0];return{signers:[],instructions:[Do({poolKeys:m,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub((c=(a=n.minAmountOut.fee)==null?void 0:a.raw)!=null?c:new Nn(0)),fixedSide:"in"})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?W.AmmV5SwapBaseIn:W.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let m=n.poolInfo[0],d=n.poolInfo[1],p=n.poolKey[0],f=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[Jd(o,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),m,d,p,f,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub((l=(u=n.minAmountOut.fee)==null?void 0:u.raw)!=null?l:new Nn(0)),n.remainingAccounts)],instructionTypes:[W.RouteSwap],lookupTableAddress:[p.lookupTableAccount,f.lookupTableAccount].filter(y=>y!==void 0),address:{}}}else throw Error("route type error")}var tn=new ir(0),Ui=class extends Le{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(j));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:i=1,feePayer:r}=e,s=await this.getWSolAccounts(),a=this.createTxBuilder(r);a.addCustomComputeBudget(e.computeBudgetConfig);let c=await jt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:0});a.addInstruction(c);let u=$(t);for(let l=0;l<s.length;l++)u.gte(s[l].amount)?(a.addInstruction({instructions:[Ht({tokenAccount:s[l].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),u.sub(s[l].amount)):a.addInstruction({instructions:[Ht({tokenAccount:s[l].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return a.versionBuild({txVersion:i})}async wrapWSol(e,t,n,i){let r=this.createTxBuilder(i),s=await jt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return r.addInstruction(s),r.versionBuild({txVersion:n!=null?n:1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:i,routeProgram:r,txVersion:s,feePayer:a}){let c=this.createTxBuilder(a),u=e.amountIn,l=e.amountOut,m=u.amount.token.mint.equals(j),d=l.amount.token.mint.equals(j),p=u.amount.token.mint,f=l.amount.token.mint,{account:y,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?nr:De,mint:p,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!m,createInfo:m?{payer:this.scope.ownerPubKey,amount:u.amount.raw}:void 0,associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(b&&c.addInstruction(b),y===void 0)throw Error("input account check error");let g;if(e.routeType==="route"&&!d)g=this.scope.account.getAssociatedTokenAccount(f,l.amount.token.isToken2022?nr:De);else{let{account:I,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.amount.token.isToken2022?nr:De,mint:f,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});g=I,k&&c.addInstruction(k)}d&&c.addInstruction({endInstructions:[Ht({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:g,programId:De})],endInstructionTypes:[W.CloseAccount]});let w;if(e.routeType==="route"){let I=e.middleToken;w=this.scope.account.getAssociatedTokenAccount(I.mint,I.isToken2022?nr:De)}let A=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),h=ic({routeProgram:r,inputMint:p,swapInfo:U(M({},e),{poolInfo:[...e.poolInfoList],poolKey:A,outputMint:f}),ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:y,routeToken:w,destinationToken:g}});if(e.feeConfig!==void 0){let I=this.createTxBuilder();I.addInstruction({instructions:[oc(y,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[W.TransferAmount]}),I.addInstruction(h);let{transactions:k}=s===0?await I.sizeCheckBuildV0():await I.sizeCheckBuild();k.length<2&&c.addInstruction({instructions:[oc(y,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[W.TransferAmount]})}return c.addInstruction(h),s===0?c.sizeCheckBuildV0({computeBudgetConfig:i,address:h.address}):c.sizeCheckBuild({computeBudgetConfig:i,address:h.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=co,clmm:n=kn,cpmm:i=mo}=e||{},r=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:Fo.offsetOf("baseMint"),length:64}}),s=q([O("baseMint"),O("quoteMint")]),a=r.map(p=>({id:p.pubkey,version:4,mintA:s.decode(p.account.data).baseMint,mintB:s.decode(p.account.data).quoteMint})),c=q([O("mintA"),O("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:xn.span}],dataSlice:{offset:xn.offsetOf("mintA"),length:64}})).map(p=>{let f=c.decode(p.account.data);return{id:p.pubkey,version:6,mintA:f.mintA,mintB:f.mintB}}),d=(await this.scope.connection.getProgramAccounts(i,{dataSlice:{offset:$o.offsetOf("mintA"),length:64}})).map(p=>{let f=c.decode(p.account.data);return{id:p.pubkey,version:7,mintA:f.mintA,mintB:f.mintB}});return{clmmPools:l,ammPools:a,cpmmPools:d}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:i,cpmmPools:r}){e=e.toString()===vn.default.toString()?j:e,t=t.toString()===vn.default.toString()?j:t;let s={},a={},c={},u=[],l={};for(let d of n!=null?n:[]){if((d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),a[d.id.toString()]=d),d.mintA.equals(e)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:De,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintB.equals(e)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:De,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintA.equals(t)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:De,in:[],out:[],mDecimals:0}),l[p].out.push(d)}if(d.mintB.equals(t)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:De,in:[],out:[],mDecimals:0}),l[p].out.push(d)}}let m=[];for(let d of i)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),s[d.id.toBase58()]=d,m.push(d)),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:De,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:De,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:De,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:De,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of r)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),c[d.id.toBase58()]=d),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:De,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:De,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:De,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:De,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of Object.keys(l)){if(l[d].in.length===1&&l[d].out.length===1&&l[d].in[0].id.equals(l[d].out[0].id)){delete l[d];continue}if(l[d].in.length===0||l[d].out.length===0){delete l[d];continue}let p=l[d];for(let f of p.in)for(let y of p.out)f.version===6&&a[f.id.toString()]===void 0?a[f.id.toString()]=f:f.version===7&&c[f.id.toString()]===void 0?c[f.id.toString()]=f:(f.version===4||f.version===5)&&s[f.id.toString()]===void 0&&(s[f.id.toString()]=f),y.version===6&&a[y.id.toString()]===void 0?a[y.id.toString()]=y:y.version===7&&c[y.id.toString()]===void 0?c[y.id.toString()]=y:(y.version===4||y.version===5)&&s[y.id.toString()]===void 0&&(s[y.id.toString()]=y)}return{directPath:u,addLiquidityPools:m,routePathDict:l,needSimulate:Object.values(s),needTickArray:Object.values(a),cpmmPoolList:Object.values(c)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let i=new Set([...e.needTickArray.map(y=>[y.mintA.toBase58(),y.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let r=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(y=>y.id)),s=qo(r),a={};Object.values(s).forEach(y=>{i.delete(y.mintA.address),a[y.mintA.address]={address:new vn(y.mintA.address),programId:De,mintAuthority:null,supply:BigInt(0),decimals:y.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},i.delete(y.mintB.address),a[y.mintB.address]={address:new vn(y.mintB.address),programId:De,mintAuthority:null,supply:BigInt(0),decimals:y.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let c=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(y=>y.id.toBase58()),!0);Object.values(c).forEach(y=>{let[b,g]=[y.mintA.toBase58(),y.mintB.toBase58()];y.mintProgramA.equals(De)?(i.delete(b),a[b]={address:y.mintA,programId:y.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:y.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(b),y.mintProgramB.equals(De)?(i.delete(g),a[g]={address:y.mintB,programId:y.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:y.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(g)}),console.log("fetching mints info, total: ",i.size);let u=await _n({connection:this.scope.connection,mints:Array.from(i).map(y=>new vn(y))});a=M(M({},a),u);let l=this.scope.cpmm.toComputePoolInfos({pools:c,mintInfos:a});console.log("fetching clmm pools info, total:",e.needTickArray.length);let m=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(y=>y.id)}),{computeClmmPoolInfo:d,computePoolTickData:p}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:m,mintInfos:a}),f=Object.keys(e.routePathDict).reduce((y,b)=>U(M({},y),{[b]:U(M({},e.routePathDict[b]),{mintProgram:a[b].programId,mDecimals:a[b].decimals,in:e.routePathDict[b].in.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[b].out.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()])})}),{});return{mintInfos:a,ammPoolsRpcInfo:r,ammSimulateCache:s,clmmPoolsRpcInfo:m,computeClmmPoolInfo:d,computePoolTickData:p,computeCpmmData:l,routePathDict:f}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:i,simulateCache:r,tickCache:s,slippage:a,chainTime:c,epochInfo:u,feeConfig:l}){var g,w,A,h,I,k,x,S,K;let m=l===void 0?new ir(0):e.raw.mul(new ir(l.feeBps.toNumber())).div(new ir(1e4)),d=e.raw.sub(m),p=new Ae(e.token,d),f=l===void 0?void 0:{feeAmount:m,feeAccount:l.feeAccount},y=U(M({},t),{address:tt(t.address).toString()}),b=[];for(let T of n)try{b.push(U(M({},this.computeAmountOut({itemPool:T,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:y,amountIn:p})),{feeConfig:f}))}catch(C){this.logDebug("direct error",T.version,T.id.toString(),C.message)}this.logDebug("direct done");for(let[T,C]of Object.entries(i)){let R={chainId:101,address:T,programId:C.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:C.mDecimals,tags:[],extensions:{}},L=C.in.map(F=>{try{return{pool:F,data:this.computeAmountOut({itemPool:F,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:R,amountIn:p})}}catch(_){this.logDebug("route in error",F.version,F.id.toString(),_.message);return}}).sort((F,_)=>{var ve,Je,ge,_e;let Z=F===void 0?tn:F.data.amountOut.amount.raw.sub((Je=(ve=F.data.amountOut.fee)==null?void 0:ve.raw)!=null?Je:tn),ce=_===void 0?tn:_.data.amountOut.amount.raw.sub((_e=(ge=_.data.amountOut.fee)==null?void 0:ge.raw)!=null?_e:tn);return Z.lt(ce)?1:-1})[0];if(L===void 0)continue;let v=new Ae(Vo(R),L.data.amountOut.amount.raw.sub((w=(g=L.data.amountOut.fee)==null?void 0:g.raw)!=null?w:tn));for(let F of C.out)try{let _=this.computeAmountOut({itemPool:F,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:y,amountIn:v});b.push(U(M({},_),{allTrade:!!(L.data.allTrade&&_.allTrade),amountIn:L.data.amountIn,amountOut:_.amountOut,minAmountOut:_.minAmountOut,currentPrice:void 0,executionPrice:new N(new ft({baseToken:L.data.amountIn.amount.token,denominator:L.data.amountIn.amount.raw,quoteToken:_.amountOut.amount.token,numerator:_.amountOut.amount.raw.sub((h=(A=_.amountOut.fee)==null?void 0:A.raw)!=null?h:tn)}).toFixed()),priceImpact:new N(L.data.priceImpact.add(_.priceImpact).toFixed()),fee:[L.data.fee[0],_.fee[0]],routeType:"route",poolInfoList:[L.pool,F],remainingAccounts:[L.data.remainingAccounts[0],_.remainingAccounts[0]],minMiddleAmountFee:(I=_.amountOut.fee)!=null&&I.raw?new Ae(L.data.amountOut.amount.token,((x=(k=L.data.amountOut.fee)==null?void 0:k.raw)!=null?x:tn).add((K=(S=_.amountOut.fee)==null?void 0:S.raw)!=null?K:tn)):void 0,middleToken:L.data.amountOut.amount.token,poolReady:L.data.poolReady&&_.poolReady,poolType:[L.data.poolType,_.poolType],feeConfig:f,expirationTime:_t(L.data.expirationTime,_.expirationTime)}))}catch(_){this.logDebug("route out error",F.version,F.id.toString(),_.message)}}return b.filter(T=>(T.allTrade||this.logDebug(`pool ${T.poolInfoList.map(C=>C.id.toString()).join(",")} filter out since not all trade`),T.allTrade)).sort((T,C)=>T.amountOut.amount.raw.sub(C.amountOut.amount.raw).gt(tn)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:i,epochInfo:r,slippage:s,outputToken:a,amountIn:c}){if(e.version===6){let{allTrade:u,realAmountIn:l,amountOut:m,minAmountOut:d,expirationTime:p,currentPrice:f,executionPrice:y,priceImpact:b,fee:g,remainingAccounts:w,executionPriceX64:A}=Be.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:c.raw,tokenOut:a,slippage:s,epochInfo:r,catchLiquidityInsufficient:!0});return{allTrade:u,amountIn:l,amountOut:m,minAmountOut:d,currentPrice:new N(f.toFixed()),executionPrice:new N(y.toFixed()),priceImpact:new N(b.toFixed()),fee:[g],remainingAccounts:[w],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<i,poolType:"CLMM",slippage:s,clmmExPriceX64:[A],expirationTime:_t(l.expirationTime,p)}}else if(e.version===7){let{allTrade:u,executionPrice:l,amountOut:m,minAmountOut:d,priceImpact:p,fee:f}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:a.address,amountIn:c.raw,slippage:s});return{allTrade:u,amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:Li(U(M({},a),{amount:m})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:Li(U(M({},a),{amount:d})),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:p,fee:[new Ae(c.token,f)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<i,poolType:"CPMM",slippage:s,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:u,minAmountOut:l,currentPrice:m,executionPrice:d,priceImpact:p,fee:f}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:c.raw,mintIn:c.token.mint,mintOut:a.address,slippage:s});return{amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:Li(U(M({},a),{amount:u})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:Li(U(M({},a),{amount:l})),fee:void 0,expirationTime:void 0},currentPrice:m,executionPrice:d,priceImpact:p,fee:[new Ae(c.token,f)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<i,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:s,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let i=new Set(e.filter(u=>u.version===6&&!t[u.id.toString()]).map(u=>u.id.toString()));if(i.size>0){let u=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(i)});Object.keys(u).forEach(l=>{t[l]=u[l]})}let r=new Set(e.filter(u=>u.version===4&&!n[u.id.toString()]).map(u=>u.id.toString()));if(r.size>0){let u=await this.scope.liquidity.getRpcPoolInfos(Array.from(r));Object.keys(u).forEach(l=>{n[l]=u[l]})}let s=new Set(e.filter(u=>u.version===4).map(u=>u.marketId)),a={};s.size>0&&(await Ue(this.scope.connection,Array.from(s).map(l=>({pubkey:new vn(l)})))).forEach(l=>{if(!l.accountInfo)return;let m=xs.decode(l.accountInfo.data);a[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:tr.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:m.baseVault.toString(),marketQuoteVault:m.quoteVault.toString(),marketBids:m.bids.toString(),marketAsks:m.asks.toString(),marketEventQueue:m.eventQueue.toString()}});let c=[];return e.forEach(u=>{if(u.version===6){let l=t[u.id.toString()],m={programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:U(M({},u.ammConfig),{id:u.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}),rewardInfos:[],observationId:u.observationId.toBase58(),exBitmapAccount:u.exBitmapAccount.toBase58()};c.push(m)}else if(u.version===4){let l=n[u.id.toString()],m=M({programId:u.programId,id:u.id,mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:As({programId:new vn(u.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:u.lpMint},a[u.marketId]);c.push(m)}else u.version===7&&c.push({observationId:u.observationId.toBase58(),programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),authority:Hn(u.programId).publicKey.toBase58(),vault:{A:u.vaultA.toBase58(),B:u.vaultB.toBase58()},mintLp:st({address:u.mintLp.toBase58(),programId:De.toBase58(),decimals:u.lpDecimals}),config:U(M({id:u.configId.toBase58()},u.configInfo),{protocolFeeRate:u.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:u.configInfo.tradeFeeRate.toNumber(),fundFeeRate:u.configInfo.fundFeeRate.toNumber(),createPoolFee:u.configInfo.createPoolFee.toString()})})}),c}};import{PublicKey as tp,Transaction as Ss,TransactionInstruction as np}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ip}from"@solana/spl-token";import rc from"bn.js";var at=class extends Le{static getPdaPoolId(e,t){return de([at.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,i){return de([at.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new rc(i).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:i,chainTime:r}){if(n.length===0)return[];let s=n.map(l=>at.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<at.VERSION_PROJECT.length;l++)a.push(...s.map(m=>at.getPdaOwnerId(t,m,i,l).publicKey));let c=await Lt(e,[...s,...a]),u=[];for(let l=0;l<c.length;l++){let m=Math.floor(l/n.length),d=l%n.length,p=s[d],f=a[l],y=c[d],b=c[n.length+l];if(!(y&&b)||y.data.length!==at.POOL_LAYOUT.span||b.data.length!==at.OWNER_LAYOUT.span)continue;let g=at.POOL_LAYOUT.decode(y.data),w=at.OWNER_LAYOUT.decode(b.data),A=g.openTime.toNumber(),h=g.endTime.toNumber(),I=w.tokenInfo.map(S=>S.debtAmount.gt(new rc(0))).filter(S=>!S).length!==3,k=r>A&&r<h&&g.status===1,x=I&&k;u.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:f,snapshotLpAmount:w.lpAmount,project:at.VERSION_PROJECT[m],openTime:A,endTime:h,canClaim:x,canClaimErrorType:I?k?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((S,K)=>({mintAddress:S.mintAddress,mintVault:S.mintVault,mintDecimals:S.mintDecimals,perLpLoss:S.perLpLoss,debtAmount:w.tokenInfo[K].debtAmount.add(w.tokenInfo[K].claimedAmount)}))})}return u}async makeClaimTransaction({poolInfo:e,ownerInfo:t,feePayer:n}){t.wallet||this.scope.checkOwner();let i=this.createTxBuilder(n),r=t.wallet||this.scope.ownerPubKey,s=[];for(let u of e.tokenInfo){let{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(Ce.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!u.mintAddress.equals(Ce.WSOL.mint),associatedOnly:u.mintAddress.equals(Ce.WSOL.mint)?!1:t.associatedOnly});m&&i.addInstruction(m),s.push(l)}i.addInstruction({instructions:[at.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:r,ownerPda:e.ownerAccountId,claimAddress:s}})]});let{transaction:a,signers:c}=i.build();return[{transaction:a,signer:c}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t,feePayer:n}){let i=this.createTxBuilder(n),r=t.wallet||this.scope.ownerPubKey,s={};for(let l of e){let m=[];for(let d of l.tokenInfo){let{account:p,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({mint:d.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:d.mintAddress.equals(Ce.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!d.mintAddress.equals(Ce.WSOL.mint),associatedOnly:d.mintAddress.equals(Ce.WSOL.mint)?!1:t.associatedOnly});f&&i.addInstruction(f),p&&(s[d.mintAddress.toString()]=p,m.push(p))}i.addInstruction({instructions:[at.makeClaimInstruction({programId:l.programId,poolInfo:l,ownerInfo:{wallet:r,ownerPda:l.ownerAccountId,claimAddress:m}})]})}let{transaction:a,signers:c}=i.build(),u=i.allInstructions;return xr(u,[r,...c.map(l=>l.publicKey)])?[{transaction:a,signer:c}]:[{transaction:new Ss().add(...u.slice(0,i.AllTxData.instructions.length-1)),signer:c},{transaction:new Ss().add(...u.slice(i.AllTxData.instructions.length-1)),signer:[]},{transaction:new Ss().add(...i.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let i=q([]),r=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(c=>({pubkey:c,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:c})=>({pubkey:c,isSigner:!1,isWritable:!0})),{pubkey:ip,isSigner:!1,isWritable:!1}],s=Buffer.alloc(i.span);i.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new np({keys:r,programId:e,data:a})}},Rt=at;Rt.CLAIMED_NUM=3,Rt.POOL_LAYOUT=q([we(8),X("bump"),X("status"),P("openTime"),P("endTime"),O("ammId"),H(q([X("mintDecimals"),O("mintAddress"),O("mintVault"),P("perLpLoss"),P("totalClaimedAmount")]),at.CLAIMED_NUM,"tokenInfo"),H(P(),10,"padding")]),Rt.OWNER_LAYOUT=q([we(8),X("bump"),X("version"),O("poolId"),O("owner"),P("lpAmount"),H(q([O("mintAddress"),P("debtAmount"),P("claimedAmount")]),at.CLAIMED_NUM,"tokenInfo"),H(P(),4,"padding")]),Rt.DEFAULT_POOL_ID=["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new tp(e)),Rt.SEED_CONFIG={pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}},Rt.VERSION_PROJECT=[void 0,"Francium","Tulip","Larix"];import{PublicKey as Xi}from"@solana/web3.js";import uc from"bn.js";import{SYSVAR_CLOCK_PUBKEY as rp,TransactionInstruction as sc}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ac}from"@solana/spl-token";var op=q([X("instruction"),Ma("amount")]),Gi=q([X("instruction")]);function or({programId:o},e){let t=[{pubkey:ac,isSigner:!1,isWritable:!1},{pubkey:ra,isSigner:!1,isWritable:!1},...Object.entries(e).map(([i,r])=>({pubkey:r,isSigner:i==="userOwner",isWritable:!["authority","userOwner"].includes(i)}))],n=Buffer.alloc(Gi.span);return Gi.encode({instruction:2},n),new sc({keys:t,programId:o,data:n})}function Ks(o){let{poolConfig:e,userKeys:t,side:n}=o,i=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,r=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(Gi.span);Gi.encode({instruction:2},s);let a=[{pubkey:ac,isWritable:!1,isSigner:!1},{pubkey:rp,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:r,isWritable:!0,isSigner:!1},{pubkey:i,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new sc({programId:e.programId,keys:a,data:s})}var sp={[ai.IDO_PROGRAM_ID_V1.toString()]:1,[ai.IDO_PROGRAM_ID_V2.toString()]:2,[ai.IDO_PROGRAM_ID_V3.toString()]:3,[ai.IDO_PROGRAM_ID_V4.toString()]:4},jn=class extends Le{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:i=!1,txVersion:r,feePayer:s}){let a=this.createTxBuilder(s),c=sp[t.programId];c||this.logAndCreateError("invalid version",c);let u=Ze(t),[l,m]=[!new uc(e.coin).isZero(),!new uc(e.pc).isZero()],d=u.projectInfo.mint.address.equals(j),{account:p,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!d,notUseTokenAccount:d,associatedOnly:d?!1:n,checkCreateATAOwner:i});!p&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&f&&a.addInstruction(f);let y=u.buyInfo.mint.address.equals(j),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,notUseTokenAccount:y,associatedOnly:y?!1:n,checkCreateATAOwner:i});if(!p&&m&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),m&&g&&a.addInstruction(g),(!p||!b)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),c===3)return a.addInstruction({instructions:[...l?[or({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:p,userIdoInfo:new Xi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...m?[or({programId:new Xi(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:b,userIdoInfo:new Xi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:r});if(c<3)return!l&&!m&&this.logAndCreateError("no claimable rewards"),a.addInstruction({instructions:[or({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:b,userBaseTokenAccount:p,userIdoInfo:new Xi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:r});let w={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:p,quoteTokenAccount:b,ledgerAccount:new Xi(e.userIdoInfo),owner:this.scope.ownerPubKey}};return a.addInstruction({instructions:[...l?[Ks(U(M({},w),{side:"base"}))]:[],...m?[Ks(U(M({},w),{side:"quote"}))]:[]]}).versionBuild({txVersion:r})}};import{PublicKey as ap}from"@solana/web3.js";import{MintLayout as up,TOKEN_2022_PROGRAM_ID as Cs,TOKEN_PROGRAM_ID as Rs}from"@solana/spl-token";var zi=class extends Le{constructor(t){super(t);this._tokenList=[];this._tokenMap=new Map;this._blackTokenMap=new Set;this._mintGroup={official:new Set,jup:new Set,extra:new Set};this._whiteMap=new Set;this._extraTokenList=[]}async load(t){this.checkDisabled();let{forceUpdate:n=!1,type:i="strict"}=t||{},{mintList:r,blacklist:s,whiteList:a}=await this.scope.fetchV3TokenList(n),c=await this.scope.fetchJupTokenList(n);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Set(s),this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(a),this._tokenMap.set(un.address,un),this._mintGroup.official.add(un.address),r.forEach(u=>{var l;this._blackTokenMap.has(u.address)||(this._tokenMap.set(u.address,U(M({},u),{type:"raydium",priority:2,programId:(l=u.programId)!=null?l:u.tags.includes("token-2022")?Cs.toBase58():Rs.toBase58()})),this._mintGroup.official.add(u.address))}),c.forEach(u=>{var l;this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,U(M({},u),{type:"jupiter",priority:1,programId:(l=u.programId)!=null?l:u.tags.includes("token-2022")?Cs.toBase58():Rs.toBase58(),tags:u.freezeAuthority?[...u.tags||[],"hasFreeze"]:u.tags})),this._mintGroup.jup.add(u.address))}),this._extraTokenList.forEach(u=>{this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,U(M({},u),{type:"extra",priority:1,programId:u.programId||u.tags.includes("token-2022")?Cs.toBase58():Rs.toBase58()})),this._mintGroup.extra.add(u.address))}),this._tokenList=Array.from(this._tokenMap).map(u=>u[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(t){if(!t)throw new Error("please input mint");let n=t.toString(),i=this._tokenMap.get(n);if(i)return i;if(n.toLocaleUpperCase()==="SOL")return un;let r=(await this.scope.api.getTokenInfo([n]))[0];if(r)return this._mintGroup.extra.add(n),this._tokenMap.set(n,U(M({},r),{priority:2})),r;let s=await this.scope.connection.getAccountInfo(new ap(n));if(!s)throw new Error(`mint address not found: ${n}`);let a=up.decode(s.data),c=n.toString().substring(0,6),u={chainId:101,address:n,programId:s.owner.toBase58(),logoURI:"",symbol:c,name:c,decimals:a.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(n),this._tokenMap.set(n,u),u}};var rr=class{constructor(e){this.rawBalances=new Map;let{connection:t,cluster:n,owner:i,api:r,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:c,blockhashCommitment:u="confirmed",loopMultiTxStatus:l}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=i?new Nt(i):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=u,this.loopMultiTxStatus=l,this.api=r,this._apiCacheTime=c||5*60*1e3,this.logger=me("Raydium"),this.farm=new ki({scope:this,moduleName:"Raydium_Farm"}),this.account=new pi({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new _i({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new zi({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new Ui({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new Ei({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new qi({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new Rt({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new Qn({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new jn({scope:this,moduleName:"Raydium_ido"}),this.availability={};let m=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:m,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){var l;let t=cp({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:i,logCount:r,logRequests:s,urlConfigs:a}=t,c=new ko({cluster:n,timeout:i,urlConfigs:a,logCount:r,logRequests:s}),u=new rr(U(M({},t),{api:c}));return await u.fetchAvailabilityStatus((l=e.disableFeatureCheck)!=null?l:!0),e.disableLoadToken||await u.token.load({type:e.jupTokenType}),u}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(ho);return this._owner.publicKey}setOwner(e){return this._owner=e?new Nt(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error(Ba);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw this.logger.error(ho),new Error(ho)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n.map(i=>U(M({},i),{mintAuthority:i.mint_authority||void 0,freezeAuthority:i.freeze_authority||void 0}))},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){var e;return(e=this._chainTime)==null?void 0:e.value}async chainTimeOffset(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.offset)||0)}async currentBlockChainTime(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.chainTime)||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};export{rr as Raydium};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=raydium.mjs.map